mapView=null;PivotViewer.Views.MapView2=PivotViewer.Views.IPivotViewerView.subClass({init:function(){this._super();this.locCache=[];this.locList=[];this.inScopeLocList=[];this.map=null;this.markers=[];this.overlay;this.overlayBaseImageUrl=null;this.geocodeList=[];this.itemsToGeocode=[];this.startGeocode;this.geocodeZero;this.applyBookmark=!1;this.mapService=null;this.APIKey=null;this.geocodeService=null;this.geometryValue=null;this.areaValues=[];this.areaObj;this.buckets=[];this.icons=[];this.iconsSelected=[];this.selectedMarker=null;this.selectedBucket=-1;var n=this;$.subscribe("/PivotViewer/Views/Item/Selected",function(t){var i,r;if(n.isActive)for(i=0;i<n.inScopeLocList.length;i++)if(r=n.inScopeLocList[i],r.tile==t.item){n.SelectMarker(n.markers[i],r);break}})},Setup:function(n,t,i,r){this.width=n;this.height=t;this.offsetX=i;this.offsetY=r;this.currentWidth=this.width;this.currentHeight=this.height;this.currentOffsetX=this.offsetX;this.currentOffsetY=this.offsetY;this.localStorage=Modernizr.localstorage?!0:!1;mapView=this},APILoaded:function(){var n=this;this.map=new google.maps.Map(document.getElementById("pv-map-canvas"));google.maps.event.addListener(this.map,"zoom_changed",function(){$.publish("/PivotViewer/Views/Item/Updated",null);n.GetOverlay()});google.maps.event.addListener(this.map,"center_changed",function(){$.publish("/PivotViewer/Views/Item/Updated",null);n.GetOverlay()});this.icons=["lib/leaflet/images/Red.png","lib/leaflet/images/Yellow.png","lib/leaflet/images/DarkGreen.png","lib/leaflet/images/Blue.png","lib/leaflet/images/Purple.png","lib/leaflet/images/Orange.png","lib/leaflet/images/Pink.png","lib/leaflet/images/Sky.png","lib/leaflet/images/Lime.png","lib/leaflet/images/Gold.png","lib/leaflet/images/Green.png"];this.iconsSelected=["lib/leaflet/images/RedDot.png","lib/leaflet/images/YellowDot.png","lib/leaflet/images/DarkGreenDot.png","lib/leaflet/images/BlueDot.png","lib/leaflet/images/PurpleDot.png","lib/leaflet/images/OrangeDot.png","lib/leaflet/images/PinkDot.png","lib/leaflet/images/SkyDot.png","lib/leaflet/images/LimeDot.png","lib/leaflet/images/GoldDot.png","lib/leaflet/images/GreenDot.png"];this.ClearMarkers=function(){for(var n=0;n<this.markers.length;n++)this.markers[n].setMap(null);this.markers=[]};this.SelectMarker=function(t,i){var r=n.GetBucketNumber(i),u;t==n.selectedMarker?(t.setIcon(n.icons[r]),n.selected=null,n.selectedMarker.setZIndex(0),n.selectedMarker=null,n.selectedBucket=-1,$(".pv-toolbarpanel-maplegend").empty(),$(".pv-mapview-legend").fadeIn()):(t.setIcon(n.iconsSelected[r]),t.setZIndex(1e9),n.selected=i.tile,n.selectedMarker!=null&&(n.selectedMarker.setZIndex(0),n.selectedMarker.setIcon(n.icons[n.selectedBucket])),n.selectedMarker=t,n.selectedBucket=r,n.map.panTo(i.loc),$(".pv-toolbarpanel-maplegend").empty(),u="<img style='height:15px;width:auto' src='"+n.icons[r]+"'><\/img>",u+=n.buckets[r].startRange==n.buckets[r].endRange?n.buckets[r].startRange:n.buckets[r].startRange+" to "+n.buckets[r].endRange,$(".pv-toolbarpanel-maplegend").append(u),$(".pv-mapview-legend").hide())};this.NewMarker=function(n){var t=new google.maps.Marker({position:n.loc,map:this.map,title:n.tile.facetItem.Name});return this.buckets[this._bucket].ids[n.tile.facetItem.Id]||this._bucket++,t.setIcon(this.icons[this._bucket]),google.maps.event.addListener(t,"click",function(n){return function(){$.publish("/PivotViewer/Views/Item/Selected",[{item:n.tile,bkt:this._bucket}])}}(n)),t};this.RefitBounds=function(){var n=new google.maps.LatLngBounds;for(i=0;i<this.markers.length;i++)n.extend(this.markers[i].position);this.map.fitBounds(n)};this.GetOverlay=function(){var n=this.map.getBounds(),r;if(n){var t=n.getSouthWest(),i=n.getNorthEast(),u=$("#pv-map-canvas").width(),f=$("#pv-map-canvas").height();this.overlayBaseImageUrl!=null&&(this.overlay&&this.overlay.setMap(null),r=this.overlayBaseImageUrl+"&bbox="+t.lng()+","+t.lat()+","+i.lng()+","+i.lat()+"&width="+u+"&height="+f,this.overlay=new google.maps.GroundOverlay(r,n,{opacity:.4}),this.overlay.setMap(this.map))}};this.Activate()},SetOptions:function(n){var r,u,f,t;if(n.GoogleAPIKey)this.APIKey=n.GoogleAPIKey,this.mapService="Google",r=document.createElement("script"),r.type="text/javascript",r.src="lib/wicket/wicket-gmap3.min.js",document.body.appendChild(r),n.GeocodeService=="Google"?this.geocodeService="Google":GeocodeService="Nominatim";else{this.mapService="OpenStreetMap";this.geocodeService="Nominatim";r=document.createElement("script");r.type="text/javascript";r.src="lib/wicket/wicket-leaflet.min.js";document.body.appendChild(r);this.map=new L.Map(document.getElementById("pv-map-canvas"));u="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";f="Map data © OpenStreetMap contributors";this.osm=new L.TileLayer(u,{attribution:f});this.map.addLayer(this.osm);this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Red.png"}}));this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Yellow.png"}}));this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/DarkGreen.png"}}));this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Blue.png"}}));this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Purple.png"}}));this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Orange.png"}}));this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Pink.png"}}));this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Sky.png"}}));this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Lime.png"}}));this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Gold.png"}}));this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Green.png"}}));this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/RedDot.png"}}));this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/YellowDot.png"}}));this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/DarkGreenDot.png"}}));this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/BlueDot.png"}}));this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/PurpleDot.png"}}));this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/OrangeDot.png"}}));this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/PinkDot.png"}}));this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/SkyDot.png"}}));this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/LimeDot.png"}}));this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/GoldDot.png"}}));this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/GreenDot.png"}}));t=this;this.map.on("zoomend",function(){$.publish("/PivotViewer/Views/Item/Updated",null);t.GetOverlay()});this.map.on("moveend",function(){$.publish("/PivotViewer/Views/Item/Updated",null);t.GetOverlay()});this.ClearMarkers=function(){for(var n=0;n<this.markers.length;n++)this.map.removeLayer(this.markers[n]);this.markers=[]};this.SelectMarker=function(n,i){var r=t.GetBucketNumber(i),u;n==t.selectedMarker?(n.setIcon(new t.icons[r]),t.selected=null,t.selectedMarker.setZIndexOffset(0),t.selectedMarker=null,t.selectedBucket=-1,$(".pv-toolbarpanel-maplegend").empty(),$(".pv-mapview-legend").fadeIn()):(n.setIcon(new t.iconsSelected[r]),n.setZIndexOffset(1e9),t.selected=i.tile,t.selectedMarker!=null&&(t.selectedMarker.setIcon(new t.icons[t.selectedBucket]),t.selectedMarker.setZIndexOffset(0)),t.selectedMarker=n,t.selectedBucket=r,t.map.panTo(i.loc),$(".pv-toolbarpanel-maplegend").empty(),u="<img style='height:15px;width:auto' src='"+n._icon.src+"'><\/img>",u+=t.buckets[r].startRange==t.buckets[r].endRange?t.buckets[r].startRange:t.buckets[r].startRange+" to "+t.buckets[r].endRange,$(".pv-toolbarpanel-maplegend").append(u),$(".pv-mapview-legend").hide())};this.NewMarker=function(n){var t=new L.Marker(n.loc,{title:n.tile.facetItem.Name});this.map.addLayer(t);this.buckets[this._bucket].ids[n.tile.facetItem.Id]||this._bucket++;t.setIcon(new this.icons[this._bucket]);t.on("click",function(n){return function(){$.publish("/PivotViewer/Views/Item/Selected",[{item:n.tile,bkt:this._bucket}])}}(n));return t};this.RefitBounds=function(){var n=[],t;for(i=0;i<this.markers.length;i++)n.push(this.markers[i].getLatLng());t=new L.LatLngBounds(n);this.map.fitBounds(t)};this.GetOverlay=function(){var n=this.map.getBounds(),r=n.getWest(),u=n.getEast(),f=n.getNorth(),e=n.getSouth(),t=this.map.getSize(),o=t.x,s=t.y,i;this.overlayBaseImageUrl!=null&&(this.overlay&&this.map.hasLayer(this.overlay)&&this.map.removeLayer(this.overlay),i=this.overlayBaseImageUrl+"&bbox="+r+","+e+","+u+","+f+"&width="+o+"&height="+s,this.overlay=new L.imageOverlay(i,n,{opacity:.4}),this.overlay.addTo(this.map))}}n.MapOverlay!=undefined&&(this.overlayBaseImageUrl=n.MapOverlay)},Activate:function(){if(Modernizr.canvas){if(this.map==null){var n=document.createElement("script");n.type="text/javascript";n.src="https://maps.googleapis.com/maps/api/js?key="+this.APIKey+"&sensor=false&callback=mapView.APILoaded";document.body.appendChild(n);return}this._super();$(".pv-toolbarpanel-maplegend").fadeIn();$(".pv-mapview-legend").fadeIn();$(".pv-toolbarpanel-zoomcontrols").css("border-width","0");$("#MAIN_BODY").css("overflow","auto");$(".pv-mapview-canvas").fadeIn();$(".pv-toolbarpanel-sort").fadeIn();this.filtered&&this.Filter(this.filterEvt.tiles,this.filterEvt.filter,this.filterEvt.sort)}},Deactivate:function(){this._super();$(".pv-mapview-legend").fadeOut();$(".pv-toolbarpanel-maplegend").fadeOut();$(".pv-mapview-canvas").fadeOut();$(".pv-toolbarpanel-sort").fadeOut()},GetBucketNumber:function(n){for(var t=0;t<this.buckets.length;t++)if(this.buckets[t].ids[n.tile.facetItem.Id])return t;return-1},Bucketize:function(n,t,i){var r,f,u;if(category=PivotCollection.GetFacetCategoryByName(i),t[0].facetItem.FacetByName[i]==undefined)return[{startRange:"(no info)",endRange:"(no info)",tiles:[t[0]],values:["(no info)"],startLabel:"(no info)",endLabel:"(no info)"}];for(r=t[0].facetItem.FacetByName[i].FacetValues[0].Value,f=t.length-1;f>0;f--)if(t[f].facetItem.FacetByName[i]!=undefined)break;return(u=t[f].facetItem.FacetByName[i].FacetValues[0].Value,category.Type==PivotViewer.Models.FacetType.DateTime)?(r=new Date(r),u=new Date(u),u.getFullYear()-r.getFullYear()+r.getFullYear()%10>9?GetBuckets(t,i,function(n){var t=new Date(n.Value).getFullYear();return t-t%10},function(n){var t=new Date(n.Value).getFullYear();return t-t%10+"s"}):u.getFullYear()>r.getFullYear()?GetBuckets(t,i,function(n){return new Date(n.Value).getFullYear()},function(n){return new Date(n.Value).getFullYear().toString()}):u.getMonth()>r.getMonth()?GetBuckets(t,i,function(n){return new Date(n.Value).getMonth()},function(n){var t=new Date(n.Value);return GetMonthName(t)+" "+t.getFullYear()}):u.getDate()>r.getDate()?GetBuckets(t,i,function(n){return new Date(n.Value).getDate()},function(n){var t=new Date(n.Value);return GetMonthName(t)+" "+t.getDate()+", "+t.getFullYear()}):u.getHours()>r.getHours()?GetBuckets(t,i,function(n){return new Date(n.Value).getHours()},function(n){var t=new Date(n.Value);return GetMonthName(t)+" "+t.getDate()+", "+t.getFullYear()+" "+GetStandardHour(t)+" "+GetMeridian(t)}):u.getMinutes()>r.getMinutes()?GetBuckets(t,i,function(n){return new Date(n.Value).getMinutes()},function(n){var t=new Date(n);return GetMonthName(t)+" "+t.getDate()+", "+t.getFullYear()+" "+GetStandardHour(t)+":"+t.getMinutes()+" "+GetMeridian(t)}):GetBuckets(t,i,function(n){return new Date(n.Value).getSeconds()},function(n){var t=new Date(n.Value);return GetMonthName(t)+" "+t.getDate()+", "+t.getFullYear()+" "+GetStandardHour(t)+":"+t.getMinutes()+"::"+t.getSeconds()+" "+GetMeridian(t)})):GetBuckets(t,i)},Filter:function(n,t,i){var ut=this,g=0,y,e,r,v,nt,a,f,w,u,rt,l,b,tt,k,it,h,p,o,s,c,d;for(Debug.Log("Map View Filtered: "+t.length),this.sortFacet=i,this.filter=t,this.tiles=n,this.buckets=this.Bucketize(n,t,this.sortFacet),this.inScopeLocList=[],$(".pv-toolbarpanel-maplegend").empty(),this.selected==null&&$(".pv-mapview-legend").fadeIn(),e=0;e<PivotCollection.FacetCategories.length;e++)if(y=PivotCollection.FacetCategories[e],y.Name.toUpperCase().indexOf("GEOMETRY")>=0){for(j=0;j<t.length;j++)if(f=t[j].facetItem.FacetByName[y.Name],f!=undefined){this.geometryValue=f.FacetValues[0].Value;break}if(j<t.length)break}for(e=0;e<PivotCollection.FacetCategories.length;e++)if(y=PivotCollection.FacetCategories[e],y.Name.toUpperCase().indexOf("AREA")>=0)for(j=0;j<t.length;j++)if(f=t[j].facetItem.FacetByName[y.Name],f!=undefined){this.areaValues.push({id:t[j].facetItem.Id,area:f.FacetValues[0].Value});break}for(e=0;e<t.length;e++){for(r=t[e],v=0;v<this.locList.length;v++)if(this.locList[v].tile==t[e]){(this.locList[v].loc.lat!=0||this.locList[v].loc.lng!=0)&&this.inScopeLocList.push(this.locList[v]);break}if(v==this.locList.length){for(h=-1,nt=-1,a=0;a<r.facetItem.Facets.length;a++)f=r.facetItem.Facets[a],f.Name.toUpperCase().indexOf("LATITUDE")>=0?h=a:f.Name.toUpperCase().indexOf("LONGITUDE")>=0&&(nt=a);if(h!=-1&&nt!=-1)s=r.facetItem.Facets[h].FacetValues[0].Value,c=r.facetItem.Facets[nt].FacetValues[0].Value,typeof s=="string"&&(s=parseFloat(s)),typeof c=="string"&&(c=parseFloat(c)),o=new L.LatLng(s,c),this.locList.push({tile:r,loc:o}),this.inScopeLocList.push({tile:r,loc:o});else for(a=0;a<r.facetItem.Facets.length;a++)if(f=r.facetItem.Facets[a],f.Name.toUpperCase().indexOf("LOCATION")>=0){for(w=0;w<f.FacetValues.length;w++)if(u=f.FacetValues[w].Value,rt=!1,u.toUpperCase().indexOf("POINT(")==0){if(c=parseFloat(u.substring(6,u.indexOf(" ",6)-6)),s=parseFloat(u.substring(u.indexOf(" ",6)+1,u.indexOf(")")-(u.indexOf(" ")+1))),isNaN(s)||isNaN(c))continue;o=new L.LatLng(s,c);locList.push({tille:r,loc:o});inScopeLocList.push({tile:r,loc:o});break}else if(u.indexOf(",")>-1){if(s=parseFloat(u.substring(0,u.indexOf(","))),c=parseFloat(u.substring(u.indexOf(","))),isNaN(s)||!isNaN(c))continue;o=new L.LatLng(lat,lon);locList.push({tile:r,loc:o});inScopeLocList.push({tile:r,loc:o});break}else if(u.length>1){for(l=u.replace("_"," ").toUpperCase(),b=0;b<r.facetItem.Facets.length;b++)if(r.facetItem.Facets[b].Name.toUpperCase().indexOf("REGION")>=0){tt=r.facetItem.Facets[b].FacetValues[0].Value;tt.length>1&&(l=l+", "+tt.replace("_"," ").toUpperCase());break}for(k=0;k<r.facetItem.Facets.length;k++)if(r.facetItem.Facets[k].Name.toUpperCase().indexOf("COUNTRY")>=0){it=r.facetItem.Facets[k].FacetValues[0].Value;it.length>1&&(l=l+", "+it.replace("_"," ").toUpperCase());break}for(h=0;h<this.locCache.length;h++)if(this.locCache[h].locName==l){this.locList.push({tile:r,loc:this.locCache[h].loc});this.inScopeLocList.push({tile:r,loc:this.locCache[h].loc});break}if(h==this.locCache.length&&this.localStorage&&(p=null,o=JSON.parse(localStorage.getItem(l)),o&&(s=parseFloat(o.lat),c=parseFloat(o.longitude),isNaN(s)||isNaN(lng)||(p=new L.LatLng(lat,lng),this.locCache.push({locName:l,loc:p}),this.locList.push({tile:r,loc:p}),this.inScopeLocList.push({tile:r,loc:p}))),p==null&&g<1e3)){for(d=0;d<this.geocodeList.length;d++)if(this.geocodeList[d]==l)break;d==this.geocodeList.length&&(this.geocodeList.push(l),g++);this.itemsToGeocode.push({tile:r,locName:l});break}}if(w!=f.FacetValues.length)break}}}if(this.inScopeLocList.length==0&&g==0){this.ShowMapError();return}g>0&&this.GetLocationsFromNames();$(".pv-mapview-canvas").css("height",this.height-12+"px");$(".pv-mapview-canvas").css("width",this.width-415+"px");this.CreateMap();this.filtered=!1},GetButtonImage:function(){return"images/MapView.png"},GetButtonImageSelected:function(){return"images/MapViewSelected.png"},GetViewName:function(){return"Map View 2"},MakeGeocodeCallBack:function(n){var t=this,i;return this.geocodeService=="Google"?function(i,r){var b=new L.LatLng(0,0),u=b,w,f,h,c,o,e,l,s,a;if(r==google.maps.GeocoderStatus.OK){var v=i[0].geometry.location,y=v.lat(),p=v.lng();y&&p&&(u=new L.LatLng(y,p))}for(t.locCache.push({locName:n,loc:u}),this.localStorage&&(w={lat:u.lat,lng:u.lng},localStorage.setItem(n,JSON.stringify(w))),f=0;f<t.itemsToGeocode.length;f++)h=t.itemsToGeocode[f].tile,e=t.itemsToGeocode[f].locName,e==n&&(t.locList.push({tile:h,loc:u}),(u.lat!=0||u.lng!=0)&&t.inScopeLocList.push({tile:h,loc:u}));for(c=!0,o=0;o<t.geocodeList.length;o++){for(e=t.geocodeList[o],l=!0,s=0;s<t.locCache.length;s++)if(t.locCache[s].locName==e){l=!1;break}if(l){c=!1;break}}if(a=new Date,(a.getTime()-t.geocodeZero.getTime())/1e3>20?(t.RedrawMarkers(),t.startGeocode=new Date):(a.getTime()-t.startGeocode.getTime())/1e3>2&&(t.RedrawMarkers(),t.RefitBounds(),t.GetOverlay(),t.startGeocode=new Date),c||t.geocodeList.Count==0){if(t.geocodeList=[],t.inScopeLocList.Count==0){this.ShowMapError();return}t.CreateMap();t.applyBookmark&&(t.SetBookmark(),t.applyBookmark=!1)}}:function(i){var p=new L.LatLng(0,0),r=p,b=$(i).find("searchresults"),s=$(i).find("place"),h,c,y,u,w,l,e,f,a,o,v;for(s&&(h=$(s).attr("lat"),c=$(s).attr("lon"),h&&c&&(r=new L.LatLng(h,c))),t.locCache.push({locName:n,loc:r}),this.localStorage&&(y={lat:r.lat,lng:r.lng},localStorage.setItem(n,JSON.stringify(y))),u=0;u<t.itemsToGeocode.length;u++)w=t.itemsToGeocode[u].tile.Id,f=t.itemsToGeocode[u].tile.facetItem.Id,f==n&&(t.locList.push({tile:item,loc:r}),(r.lat!=0||r.lng!=0)&&t.inScopeLocList.push({tile:item,loc:r}));for(l=!0,e=0;e<t.geocodeList.length;e++){for(f=t.geocodeList[e],a=!0,o=0;o<t.locCache.length;o++)if(t.locCache[o].locName==f){a=!1;break}if(a){l=!1;break}}if(v=new Date,(v.getTime()-t.geocodeZero.getTime())/1e3>20?(t.RedrawMarkers(),t.startGeocode=new Date):(v.getTime()-t.startGeocode.getTime())/1e3>2&&(t.RedrawMarkers(),t.RefitBounds(),t.startGeocode=new Date),l||t.geocodeList.Count==0){if(t.geocodeList=[],t.inScopeLocList.Count==0){this.ShowMapError();return}t.CreateMap();t.applyBookmark&&(t.SetBookmark(),t.applyBookmark=!1)}}},Geocode:function(n,t){var r,u,i;this.geocodeService=="Google"?(r=new google.maps.Geocoder,r.geocode({address:n},this.MakeGeocodeCallBack(n))):(u=this,i="http://nominatim.openstreetmap.org/search?q="+encodeURIComponent(n)+"&format=xml",$.ajax({type:"GET",url:i,success:t,error:function(n,t,r){var u="Error goecoding<br><br>";u+="URL        : "+i+"<br>";u+="Status : "+n.status+" "+r+"<br>";u+="Details    : "+n.responseText+"<br>";u+="<br>Pivot Viewer cannot continue until this problem is resolved<br>";$(".pv-wrapper").append('<div id="pv-dzloading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X<\/a><h2>HTML5 PivotViewer<\/h2><p>'+u+"<\/p><\/div><\/div>");setTimeout(function(){window.open("#pv-dzloading-error","_self")},1e3)}}))},GetLocationsFromNames:function(){for(l=0;l<this.itemsToGeocode.length;l++){var n=this.itemsToGeocode[l].tile.facetItem.Name;this.Geocode(n,this.MakeGeocodeCallBack(n))}this.startGeocode=new Date;this.startGeocode.setSeconds(this.startGeocode.getSeconds()+2);this.geocodeZero=new Date},CreateMap:function(){var t,n,i;if(this.geometryValue!=null){t=new Wkt.Wkt;try{t.read(this.geometryValue)}catch(u){try{t.read(this.geometryValue.replace("\n","").replace("\r","").replace("\t",""))}catch(r){r.name==="WKTError"&&Debug.Log("Wicket could not understand the WKT string you entered. Check that you have parentheses balanced, and try removing tabs and newline characters.")}}if(n=t.toObject(this.map.defaults),Wkt.isArray(n))for(i=0;i<n.length;i++)this.map.addLayer(n[i]);else this.map.addLayer(n)}this.CreateMarkers();this.RefitBounds();this.GetOverlay();this.CreateLegend()},CreateMarkers:function(){for(this.ClearMarkers(),this._bucket=0,i=0;i<this.inScopeLocList.length;i++)this.markers.push(this.NewMarker(this.inScopeLocList[i]))},DrawArea:function(){var t,r=new Wkt.Wkt,n,u,i;for(this.areaObj&&this.map.removeLayer(this.areaObj),n=0;n<this.areaValues.length;n++)if(this.areaValues[n].id==this.selected.facetItem.Id){t=this.areaValues[n].area;break}if(t){u=!0;try{r.read(t)}catch(e){try{r.read(t.replace("\n","").replace("\r","").replace("\t",""))}catch(f){f.name==="WKTError"&&(Debug.Log("Wicket could not understand the WKT string you entered. Check that you have parentheses balanced, and try removing tabs and newline characters."),u=!1)}}if(u)if(this.areaObj=r.toObject({color:"#990000",fillColor:"#EEFFCC",fillOpacity:.6}),Wkt.isArray(this.areaObj))for(i=0;i<this.areaObj.length;i++)this.map.addLayer(this.areaObj[i]);else this.map.addLayer(this.areaObj)}},RedrawMarkers:function(){this.CreateMarkers();this.DrawArea()},ShowMapError:function(){var n="";n=n+"The current data selection does not contain any location information that can be shown on a map<br><br>";n=n+"<br>Choose a different view<br>";$(".pv-wrapper").append('<div id="pv-dzlocation-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X<\/a><h2>HTML5 PivotViewer<\/h2><p>'+n+"<\/p><\/div><\/div>");setTimeout(function(){window.open("#pv-dzlocation-error","_self")},1e3);return},CreateLegend:function(){var i=$(".pv-mapview-legend").width()-32,t,n,r;for($(".pv-mapview-legend").empty(),$(".pv-mapview-legend").append("<div class='pv-legend-heading' style='height:28px' title='"+this.sortFacet+"'>"+this.sortFacet+"<\/div>"),t="<table id='pv-legend-data' style='color:#484848;'>",n=0;n<this.buckets.length;n++)r=this.mapService=="Google"?this.icons[n]:(new this.icons[n]).options.iconUrl,t+="<tr><td><img src='"+r+"'><\/img><\/td>",t+=this.buckets[n].startRange==this.buckets[n].endRange?"<td><div style='overflow:hidden;white-space:nowrap;width:"+i+"px;text-overflow:ellipsis'>"+this.buckets[n].startLabel+"<\/div><\/td><\/tr>":"<td><div style='overflow:hidden;white-space:nowrap;width:"+i+"px;text-overflow:ellipsis'>"+this.buckets[n].startLabel+" to "+this.buckets[n].endLabel+"<\/div><\/td><\/tr>";t+="<\/table>";$(".pv-mapview-legend").append(t)}});
