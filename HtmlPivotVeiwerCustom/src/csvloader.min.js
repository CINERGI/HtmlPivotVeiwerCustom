PivotViewer.Models.Loaders.CSVLoader=PivotViewer.Models.Loaders.ICollectionLoader.subClass({init:function(n,t){this.CSVUriNoProxy=n;this.CSVUri=t?t+n:n},LoadCollection:function(n){var i,r,t;this.collection=n;this._super(n);n.CollectionBaseNoProxy=this.CSVUriNoProxy;n.CollectionBase=this.CSVUri;i=n.CollectionBase;r=i.substring(i.lastIndexOf("/")+1,i.lastIndexOf("."));n.CollectionName=r;n.ImageBase=r+"/"+r+".dzc";n.BrandImage="";t=this;this.CSVUri.endsWith(".zip")?jBinary.loadData(this.CSVUri).then(function(n){var i=new JSZip;i.load(n);t.data=i.file(/.csv/)[0].asText().csvToArray();t.LoadData()}):$.ajax({type:"GET",url:this.CSVUri,dataType:"text",success:function(n){if(Debug.Log("CSV loaded"),t.data=n.csvToArray(),t.data.length<=1){$(".pv-loading").remove();$(".pv-wrapper").append('<div id="pv-empty-collection-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X<\/a><h2>HTML5 PivotViewer<\/h2><p>There are no items in the CSV Collection<br><br><\/p><\/div><\/div>');setTimeout(function(){window.open("#pv-empty-collection-error","_self")},1e3);return}t.LoadData()},error:function(n,t,i){$(".pv-loading").remove();var r="Error loading CSV Collection<br><br>";r+="URL        : "+this.url+"<br>";r+="Status : "+n.status+" "+i+"<br>";r+="Details    : "+n.responseText+"<br>";r+="<br>Pivot Viewer cannot continue until this problem is resolved<br>";$(".pv-wrapper").append('<div id="pv-loading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X<\/a><h2>HTML5 PivotViewer<\/h2><p>'+r+"<\/p><\/div><\/div>");setTimeout(function(){window.open("#pv-loading-error","_self")},1e3)}})},LoadData:function(){for(var u,f,s,t=this.data[0],e=-1,o=-1,i,r,n=0;n<t.length;n++){if(t[n].charAt(0)=="#"){t[n]=="#name"?e=n:t[n]=="#img"&&(o=n);continue}else(i=t[n].indexOf("#"))!==-1?r=t[n].indexOf("#number",i)!==-1?PivotViewer.Models.FacetType.Number:t[n].indexOf("#date",i)!==-1?PivotViewer.Models.FacetType.DateTime:t[n].indexOf("#ordinal",i)!==-1?PivotViewer.Models.FacetType.Ordinal:PivotViewer.Models.FacetType.String:(r=PivotViewer.Models.FacetType.String,i=t[n].length);u=new PivotViewer.Models.FacetCategory(t[n].substring(0,i),null,r,!0,!0,!0);u.column=n;this.collection.FacetCategories.push(u)}for(n=1;n<this.data.length;n++)f=this.data[n],s=new PivotViewer.Models.Item(f[o],String(n),"",f[e]),this.collection.Items.push(s);$.publish("/PivotViewer/Models/Collection/Loaded",null)},LoadColumn:function(n){for(var u,t,r,i=0;i<this.collection.Items.length;i++)(u=this.collection.Items[i],t=this.data[i+1][n.column],t.trim()!="")&&(r=new PivotViewer.Models.Facet(n.Name),n.Type==PivotViewer.Models.FacetType.String?r.AddFacetValue(new PivotViewer.Models.FacetValue(t)):n.Type==PivotViewer.Models.FacetType.Number||n.Type==PivotViewer.Models.FacetType.Ordinal?r.AddFacetValue(new PivotViewer.Models.FacetValue(parseFloat(t.replace(/,/g,"").match(/(?:-?\d+\.?\d*)|(?:-?\d*\.?\d+)/)[0]),t)):n.Type==PivotViewer.Models.FacetType.DateTime&&r.AddFacetValue(new PivotViewer.Models.FacetValue(moment(t,moment.parseFormat(t))._d.toString(),t)),u.Facets.push(r))},GetRow:function(n){for(var i,t,r,e=this.data[n],f=[],u=0;u<this.collection.FacetCategories.length;u++)(i=this.collection.FacetCategories[u],t=e[u],t.trim()!="")&&(r=new PivotViewer.Models.Facet(i.Name),i.Type==PivotViewer.Models.FacetType.String?r.AddFacetValue(new PivotViewer.Models.FacetValue(t)):i.Type==PivotViewer.Models.FacetType.Number||i.Type==PivotViewer.Models.FacetType.Ordinal?r.AddFacetValue(new PivotViewer.Models.FacetValue(parseFloat(t.replace(/,/g,"").match(/(?:-?\d+\.?\d*)|(?:-?\d*\.?\d+)/)[0]),t)):i.Type==PivotViewer.Models.FacetType.DateTime&&r.AddFacetValue(new PivotViewer.Models.FacetValue(moment(t,moment.parseFormat(t))._d.toString(),t)),f.push(r));return f}});
