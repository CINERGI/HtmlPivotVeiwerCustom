PivotViewer.Utils.loadScript("src/views/bucketview.min.js");PivotViewer.Views.CrosstabView=PivotViewer.Views.BucketView.subClass({init:function(){this._super();var n=this;if($("#pv-altsortcontrols").length==0){$("#pv-primsortcontrols").before("<div id='pv-altsortcontrols' class='pv-toolbarpanel-sortcontrols'><\/div>");$("#pv-altsortcontrols").hide();$("#pv-primsort").clone(!0).attr("id","pv-altsort").appendTo($("#pv-altsortcontrols"));$("#pv-altsort").on("change",function(){var r,t,i,u;if(n.buckets2!=undefined){if(n.sortFacet2=$("#pv-altsort option:selected").html(),r=PivotCollection.getCategoryByName(n.sortFacet2),r.uiInit||PV.initUIFacet(r),t=n.filterList.slice(0).sort(tileSortBy(n.sortFacet2)),Settings.showMissing)n.filterList2=t;else for(n.filterList2=[],i=0;i<t.length;i++)u=t[i],u.item.getFacetByName(n.sortFacet2)!=undefined&&n.filterList2.push(u);n.buckets2=n.bucketize(n.filterList2,n.sortFacet2);n.subbucketize();n.activate()}})}},getBucket:function(n){return Math.floor((n-this.offsetX-this.columnWidth)/this.columnWidth)},getBucket2:function(n){return this.buckets2.length-Math.floor(n/this.rowHeight)-1},recalibrateUISettings:function(){this.rowscols=this.getTileDimensions((this.origColumnWidth-4)*this.scale,(this.rowHeight-4)*this.scale,this.maxRatio,this.bigCount,this.rowscols)},resetUISettings:function(){this.rowscols=this.calculateDimensions((this.origColumnWidth-4)*this.scale,(this.rowHeight-4)*this.scale,this.maxRatio,this.bigCount)},subbucketize:function(){for(var r,t,i,n=0;n<this.buckets.length;n++)for(r=this.buckets[n],r.subBuckets=[],r.colCount=0,t=0;t<this.buckets2.length;t++)i=this.buckets2[t],r.subBuckets.push(new PivotViewer.Models.Bucket(i.startRange,i.startLabel,i.endRange,i.endLabel));for(n=0;n<this.filterList.length;n++){var u=this.filterList[n],f=u.item.id,t=this.buckets.ids[f],e=this.buckets2.ids[f];t!=undefined&&e!=undefined&&(this.buckets[t].subBuckets[e].addTile(u),this.buckets[t].colCount++)}},filter:function(n,t,i){var u,e,y,f,r,o;if(this._super(n,t,i),this.buckets2==undefined)this.sortFacet2=$("#pv-primsort option:selected").html(),$("#pv-altsort").val($("#pv-primsort").val()),this.buckets2=this.buckets,this.filterList2=this.filterList;else{if(u=[],t.length<this.filterList2.length)for(r=0;r<this.filterList2.length;r++)f=this.filterList2[r],this.buckets.ids[f.item.id]!=undefined&&u.push(f);else{for(e=[],y=PivotCollection.getCategoryByName(this.sortFacet2),r=0;r<t.length;r++)f=this.filterList[r],this.buckets2.ids[f.item.id]==undefined&&(Settings.showMissing||f.item.getFacetByName(this.sortFacet2)!=undefined)&&e.push(f);for(e.sort(tileSortBy(this.sortFacet2)),r=0,o=0;r<this.filterList2.length&&o<e.length;){var s=this.filterList2[r],h=e[o],c,l,a=s.item.getFacetByName(this.sortFacet2),v=h.item.getFacetByName(this.sortFacet2);if(a==undefined){u.push(h);o++;continue}else if(v==undefined){u.push(s);r++;continue}y.type==PivotViewer.Models.FacetType.DateTime?(c=new Date(a.values[0].value),l=new Date(v.values[0].value)):(c=a.values[0].value,l=v.values[0].value);c<l?(u.push(s),r++):(u.push(h),o++)}while(r<this.filterList2.length)u.push(this.filterList2[r++]);while(o<e.length)u.push(e[o++])}this.filterList2=u;this.buckets2=this.bucketize(this.filterList2,this.sortFacet2)}this.subbucketize()},createUI:function(){var f,i,e,s,a,o,h,r,u,c,n,l,v,t;for($("#pv-altsortcontrols").show(),this.filtered&&this.filter(this.filterEvt.tiles,this.filterEvt.filterList,this.filterEvt.sort),this.columnWidth=this.origColumnWidth=(this.width-this.offsetX)/(this.buckets.length+1),this.canvasHeightUIAdjusted=this.height-this.offsetY-this.titleSpace,this.rowHeight=this.canvasHeightUIAdjusted/this.buckets[0].subBuckets.length,f="<div class='pv-bucketview-overlay-bucket' style='width: "+(this.columnWidth-4)+"px; height:"+this.height+"px;''>",this.bigCount=0,n=0;n<this.buckets2.length;n++)i=this.buckets2[n],o=i.startRange==i.endRange||i.startLabel==i.endLabel?o=i.startLabel:i.startLabel+" to "+i.endLabel,f+="<div class='pv-bucketview-overlay-buckettitle-left' style='top: "+(this.buckets2.length-1-n)*this.rowHeight+"px; height: "+(this.rowHeight-4)+"px; width: "+(this.columnWidth-4)+"px'><div class='pv-bucket-countbox'>"+this.buckets2[n].tiles.length+"<br>"+Math.round(this.buckets2[n].tiles.length/this.filterList2.length*100)+"%<\/div><div class='pv-bucket-label'>"+o+"<\/div><\/div>";for(f+=this.getStatsBox(),n=0;n<this.buckets.length;n++){for(i=this.buckets[n],f+="<div class='pv-bucketview-overlay-bucket' style='width: "+(this.columnWidth-4)+"px; left:"+(n+1)*this.columnWidth+"px; height:"+this.height+"px;'>",e=0;e<i.subBuckets.length;e++)s=i.subBuckets[e],a=n%2==e%2?"bucketview-bucket-dark":"bucketview-bucket-light",f+="<div style='height:"+this.rowHeight+"px; top:"+e*this.rowHeight+"px;'><div class='"+a+"' style='height:"+(this.rowHeight-4)+"px; top: "+e*this.rowHeight+"px;'><\/div><\/div>",this.bigCount<s.tiles.length&&(this.bigCount=s.tiles.length);o=i.startRange==i.endRange||i.startLabel==i.endLabel?o="<div class='pv-bucket-label'>"+i.startLabel+"<\/div>":i.startLabel+"<br>to<br>"+i.endLabel;f+="<div class='pv-bucketview-overlay-buckettitle' style='top: "+(this.canvasHeightUIAdjusted+4)+"';'><div class='pv-bucket-countbox'>"+this.buckets[n].colCount+"<br>"+Math.round(this.buckets[n].colCount/this.filterList2.length*100)+"%<\/div>"+o+"<\/div><\/div><\/div>"}for(h=$(".pv-bucketview-overlay"),h.css("left",this.offsetX+"px"),$(".pv-bucketview-overlay div").fadeOut("slow",function(){$(this).remove()}),h.append(f),$(".pv-bucketview-overlay div").fadeIn("slow"),n=0;n<this.tiles.length;n++)(r=this.tiles[n],u=r._locations[0],u.startx=u.x,u.starty=u.y,r.startwidth=r.width,r.startheight=r.height,r.filtered&&(Settings.showMissing||!r.missing))||(r.start=PivotViewer.Utils.now(),r.end=r.start+1e3,c=Math.atan2(u.y-this.currentHeight/2,u.x-this.currentWidth/2),u.destinationx=this.currentWidth*Math.cos(c)+this.currentWidth/2,u.destinationy=this.currentHeight*Math.sin(c)+this.currentHeight/2);for(this.maxRatio=TileController._imageController.getRatio(this.tiles[0].item.img),n=0;n<this.filterList.length;n++)l=TileController._imageController.getRatio(this.filterList[n].item.img),l<this.maxRatio&&(this.maxRatio=l);v=this.filterList.length==this.tiles.length?0:500;t=this;setTimeout(function(){var r=$(".pv-toolbarpanel-zoomslider").slider("option","value"),i,n;for(r>0&&(t.selected=selectedTile=null,t.currentOffsetX=t.offsetX,t.currentOffsetY=t.offsetY,t.resetUISettings(),PV.zoom(0)),t.resetUISettings(),i=TileController._imageController,n=0;n<t.tiles.length;n++)t.tiles[n].origwidth=t.rowscols.TileHeight/i.getRatio(t.tiles[n].item.img),t.tiles[n].origheight=t.rowscols.TileHeight,t.tiles[n].destinationwidth=1,t.tiles[n].destinationheight=1;t.setTilePositions(t.rowscols,t.offsetX,t.offsetY,!1,!1)},v)},deactivate:function(){this._super();$("#pv-altsortcontrols").hide()},getViewName:function(){return"Crosstab View"},setTilePositions:function(n,t,i,r,u){var w=u&&this.rowscols?this.rowscols.Columns:n.Columns,b,k,o,a,s,v,h,l,f,e;for(u||(this.rowscols=n),b=[],k=[],o=0;o<this.tiles.length;o++)this.tiles[o].firstFilterItemDone=!1,this.tiles[o]._locations=[this.tiles[o]._locations[0]];for(a=this.rowHeight*this.scale,s=0;s<this.buckets.length;s++)for(v=this.buckets[s],h=0;h<v.subBuckets.length;h++){var p=v.subBuckets[h],c=0,y=0;for(l=0;l<p.tiles.length;l++)f=p.tiles[l],f.firstFilterItemDone?(e=new PivotViewer.Views.TileLocation,e.startx=f._locations[0].startx,e.starty=f._locations[0].starty,e.x=f._locations[0].x,e.y=f._locations[0].y,e.destinationx=(s+1)*this.columnWidth+c*n.TileMaxWidth+t,e.destinationy=this.canvasHeightUIAdjusted-h*a-n.TileHeight-y*n.TileHeight+i-10,f._locations.push(e)):(e=f._locations[0],r&&(e.startx=e.x,e.starty=e.y,f.startwidth=f.width,f.startheight=f.height),f.destinationwidth=n.TileMaxWidth,f.destinationheight=n.TileHeight,e.destinationx=(s+1)*this.columnWidth+c*n.TileMaxWidth+t,e.destinationy=this.canvasHeightUIAdjusted-h*a-n.TileHeight-y*n.TileHeight+i-10,f.start=PivotViewer.Utils.now(),f.end=f.start+1e3,f.firstFilterItemDone=!0),c==w-1?(c=0,y++):c++}},centerOnTile:function(n){for(var s=n._locations[n.selectedLoc],i=n.item,h=this.rowscols.Columns,v=this.rowscols.Rows,y=this.rowscols.TileMaxWidth,p=this.rowscols.TileHeight,r=this.buckets.ids[i.id],u=this.buckets2.ids[i.id],c=Math.round((s.x-this.currentOffsetX-(r+1)*this.columnWidth)/y),f=v-Math.floor((s.y-this.currentOffsetY-(this.buckets2.length-u-1)*this.rowHeight*this.scale-this.rowscols.PaddingY)/p),l=this.buckets[r].subBuckets[u],t=f*h+c,e,o,a;(t>l.tiles.length||l.tiles[t]!=n)&&t>=0;)f--,t-=h;e=n.context.canvas.height;o=n.context.canvas.width-($(".pv-filterpanel").width()+$(".pv-infopanel").width());a=n.height/e>n.height/TileController._imageController.getRatio(i.img)/o?n.origheight/e:n.origwidth/o;this.selected==null&&PV.zoom(Math.round(.75/a*2));this.currentOffsetX=this.width/2-this.rowscols.TileMaxWidth/2-(r+1)*this.columnWidth-c*this.rowscols.TileMaxWidth;this.currentOffsetY=this.height/2-this.canvasHeightUIAdjusted+this.rowscols.TileHeight/2+u*this.rowHeight*this.scale+f*this.rowscols.TileHeight+10;this.setTilePositions(this.rowscols,this.currentOffsetX,this.currentOffsetY,!0,!0)},getStatsBox:function(){for(var i,e,o,s,f,r,n=0,t,u=0;u<this.buckets.length;u++)if(t=this.buckets[u],t.tiles.length!=0)for(i=0;i<this.buckets2.length;i++)(e=this.buckets2[i],e.tiles.length!=0)&&(o=t.tiles.length*e.tiles.length/this.filterList.length,s=o-t.subBuckets[i].tiles.length,n+=s*s/o);return n=Math.floor(n*100)/100,f=pochisq(n,this.buckets.length,t.subBuckets.length),r="",f<.001?r="***":f<.01?r="**":f<.05&&(r="*"),"<div style='position:absolute; width: "+(this.columnWidth-4)+"px; height: 50px; top: "+u*this.rowHeight+"px;'><div style='text-align:center'>"+this.sortFacet2+"<\/div><div class='pv-bucket-countbox'>X<sup>2<\/sup><br>"+n+r+"<\/div><div style='position:absolute; right:2px;'>"+this.sortFacet+"<\/div><\/div><\/div>"},handleSelection:function(n,t,i,r){var s=!1,h=!1,o,e,f,u;n!=null&&(n.Selected(!0),n.selectedLoc=r,s=!0);this.selected!=null&&n==null&&(h=!0);n!=null&&this.selected!=n?(this.centerOnTile(n),$(".pv-bucketview-overlay div").fadeOut("slow")):this.selected!=null&&(this.selected=n=null,PV.zoom(0),$(".pv-bucketview-overlay div").fadeIn("slow"));$.publish("/PivotViewer/Views/Item/Selected",[{item:n}]);s||h||(o=this.getBucket(t),e=this.getBucket2(i),o>=0?(f=this.buckets[o],e>=0?(u=this.buckets2[e],$.publish("/PivotViewer/Views/Item/Filtered",[[{Facet:this.sortFacet,Item:f.startRange,MaxRange:f.endRange,Values:f.values},{Facet:this.sortFacet2,Item:u.startRange,MaxRange:u.endRange,Values:u.values}]])):$.publish("/PivotViewer/Views/Item/Filtered",[{Facet:this.sortFacet,Item:f.startRange,MaxRange:f.endRange,Values:f.values}])):e>=0&&(u=this.buckets2[e],$.publish("/PivotViewer/Views/Item/Filtered",[{Facet:this.sortFacet2,Item:u.startRange,MaxRange:u.endRange,Values:u.values}])))}});
