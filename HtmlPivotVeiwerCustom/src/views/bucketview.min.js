PivotViewer.Views.BucketView=PivotViewer.Views.TileBasedView.subClass({init:function(){this._super();var n=this;this.buckets=[];this.scale=1;this.canvasHeightUIAdjusted=0;this.titleSpace=62;this.dontZoom=!1;$.subscribe("/PivotViewer/Views/Canvas/Click",function(t){var r,u,i,f;if(n.isActive){for(r=null,u=null,i=0;i<n.filter.length;i++)f=n.filter[i].Contains(t.x,t.y),f>=0?(r=n.filter[i],u=f):n.filter[i].Selected(!1);n.handleSelection(r,t.x,t.y,u)}});$.subscribe("/PivotViewer/Views/Canvas/Hover",function(t){var u,r,e,i,f;if(n.isActive&&($(".pv-bucketview-overlay-bucket").removeClass("bucketview-bucket-hover"),u=n.GetBucket(t.x),r=n.buckets[u],!(u<0)))for(e=$("#pv-bucketview-overlay-bucket-"+u),e.addClass("bucketview-bucket-hover"),i=0;i<r.tiles.length;i++)f=r.tiles[i].Contains(t.x,t.y),f>=0?(r.tiles[i].Selected(!0),r.tiles[i].selectedLoc=f):r.tiles[i].Selected(!1)});$.subscribe("/PivotViewer/Views/Canvas/Zoom",function(t){var i,e,u,f,r;if(n.isActive){if(n.dontZoom){n.dontZoom=!1;return}if(i=n.scale,e=t.scale!=undefined?0:1e3,t.scale!=undefined?t.scale>=1?n.scale+=t.scale-1:(n.scale-=t.scale,n.scale=n.scale<1?1:n.scale):t.delta!=undefined&&(n.scale=t.delta==0?1:n.scale+t.delta),isNaN(n.scale)&&(n.scale=1),u=(n.width-n.offsetX)*n.scale,u<n.width||n.scale<=1?(n.currentOffsetX=n.offsetX,n.currentOffsetY=n.offsetY,n.currentWidth=n.width,n.currentHeight=n.height,n.canvasHeightUIAdjusted=n.height-n.offsetY-n.titleSpace,n.columnWidth=n.origColumnWidth,n.scale=1,$(".pv-bucketview-overlay div").fadeIn("slow"),n.dontZoom=!0,$(".pv-toolbarpanel-zoomslider").slider("option","value",0),n.RecalibrateUISettings()):(f=n.height*n.scale,n.currentOffsetX=t.x-(t.x-n.currentOffsetX)/i*n.scale,n.currentOffsetY=t.y-(t.y-n.currentOffsetY)/i*n.scale,n.canvasHeightUIAdjusted=f-(n.offsetY+n.titleSpace)/i*n.scale,n.currentWidth=u,n.currentHeight=f,n.columnWidth=n.origColumnWidth*n.scale,$(".pv-bucketview-overlay div").fadeOut("slow"),n.ResetUISettings()),n.SetVisibleTileGraphPositions(n.rowscols,n.currentOffsetX,n.currentOffsetY,!0,!0),n.scale==1&&i!=1){for(r=0;r<n.tiles.length;r++)n.tiles[r].Selected(!1),n.tiles[r].selectedLoc=0;n.selected=null;$.publish("/PivotViewer/Views/Item/Selected",[{item:n.selected}])}}});$.subscribe("/PivotViewer/Views/Canvas/Drag",function(t){if(n.isActive){var i=t.x,r=t.y,u=!1,f=!1;(n.currentOffsetX+=i,n.currentOffsetY+=r,i>0&&n.currentOffsetX>n.offsetX&&(n.currentOffsetX-=i,u=!0),r>0&&n.currentOffsetY+n.canvasHeightUIAdjusted>n.currentHeight+n.offsetY&&(n.currentOffsetY-=r,f=!0),n.currentOffsetX<n.offsetX&&n.currentWidth==n.width&&(n.currentOffsetX-=i,u=!0),i<0&&n.currentOffsetX<-1*(n.currentWidth-n.width)&&(n.currentOffsetX-=i,u=!0),n.currentOffsetY<n.offsetY&&n.currentHeight==n.height&&(n.currentOffsetY-=r,f=!0),r<0&&n.currentOffsetY-n.offsetY<-1*(n.currentHeight-n.height)&&(n.currentOffsetY-=r,f=!0),u&&f)||(u?n.OffsetTiles(0,r):f?n.OffsetTiles(i,0):n.OffsetTiles(i,r))}})},GetBucket:function(n){return Math.floor((n-this.offsetX)/this.columnWidth)},RecalibrateUISettings:function(){this.rowscols=this.GetTileDimensions(this.columnWidth-2,this.canvasHeightUIAdjusted-this.offsetY,this.maxRatio,this.bigCount,this.rowscols)},ResetUISettings:function(){this.rowscols=this.GetRowsAndColumns(this.columnWidth-2,this.canvasHeightUIAdjusted-this.offsetY,this.maxRatio,this.bigCount)},Setup:function(n,t,i,r,u){this.width=n;this.height=t;this.offsetX=i;this.offsetY=r;this.maxRatio=u;this.currentWidth=this.width;this.currentHeight=this.height;this.currentOffsetX=this.offsetX;this.currentOffsetY=this.offsetY;this.rowscols=null;this.bigCount=0},Filter:function(n,t,i){this.sortFacet=i;this.tiles=n;this.filter=t;this.buckets=this.Bucketize(t,this.sortFacet);this.filtered=!1},Activate:function(){var n=this;Modernizr.canvas&&(this._super(),this.filtered&&this.Filter(this.filterEvt.tiles,this.filterEvt.filter,this.filterEvt.sort),this.CreateUI())},CreateUI:function(){var u,f,i,e,t,s,o,h,n;for(this.columnWidth=this.origColumnWidth=(this.width-this.offsetX)/this.buckets.length,this.canvasHeightUIAdjusted=this.height-this.offsetY-this.titleSpace,u=[],this.bigCount=0,t=0;t<this.buckets.length;t++){var r=this.buckets[t],c=t%2==0?"bucketview-bucket-dark":"bucketview-bucket-light",l=r.startRange==r.endRange||r.startLabel==r.endLabel?r.startLabel:r.startLabel+"<br>to<br>"+r.endLabel;u[t]="<div class='pv-bucketview-overlay-bucket "+c+"' id='pv-bucketview-overlay-bucket-"+t+"' style='width: "+(Math.floor(this.columnWidth)-4)+"px; height:"+(this.height-2)+"px; left:"+(t*this.columnWidth-2)+"px;'>";u[t]+="<div class='pv-bucketview-overlay-buckettitle' style='top: "+(this.canvasHeightUIAdjusted+4)+"px;'><div class='pv-bucket-countbox'>"+this.buckets[t].tiles.length+"<br>"+Math.round(this.buckets[t].tiles.length/this.filter.length*100)+"%<\/div>"+l+"<\/div><\/div>";this.bigCount<r.tiles.length&&(this.bigCount=r.tiles.length)}for(f=$(".pv-bucketview-overlay"),f.css("left",this.offsetX+"px"),$(".pv-bucketview-overlay div").fadeOut("slow",function(){$(this).remove()}),f.append(u.join("")),$(".pv-bucketview-overlay div").fadeIn("slow"),t=0;t<this.tiles.length;t++)(i=this.tiles[t],i._locations[0].startx=i._locations[0].x,i._locations[0].starty=i._locations[0].y,i.startwidth=i.width,i.startheight=i.height,!i.filtered||i.missing)&&(i.start=PivotViewer.Utils.Now(),i.end=i.start+1e3,e=Math.atan2(i._locations[0].y-this.currentHeight/2,i._locations[0].x-this.currentWidth/2),i._locations[0].destinationx=this.currentWidth*Math.cos(e)+this.currentWidth/2,i._locations[0].destinationy=this.currentHeight*Math.sin(e)+this.currentHeight/2);for(this.maxRatio=TileController._imageController.GetRatio(this.tiles[0].facetItem.Img),t=0;t<this.filter.length;t++)s=this.filter[t].facetItem,o=TileController._imageController.GetRatio(s.Img),o<this.maxRatio&&(this.maxRatio=o);h=this.filter.length==this.tiles.length?0:500;n=this;setTimeout(function(){var r=$(".pv-toolbarpanel-zoomslider").slider("option","value"),i,t;for(r>0&&(n.selected=selectedTile=null,n.currentOffsetX=n.offsetX,n.currentOffsetY=n.offsetY,n.ResetUISettings(),$(".pv-toolbarpanel-zoomslider").slider("option","value",0)),n.ResetUISettings(),i=TileController._imageController,t=0;t<n.tiles.length;t++)n.tiles[t].origwidth=n.rowscols.TileHeight/i.GetRatio(n.tiles[t].facetItem.Img),n.tiles[t].origheight=n.rowscols.TileHeight,n.tiles[t].destinationwidth=1,n.tiles[t].destinationheight=1;n.SetVisibleTileGraphPositions(n.rowscols,n.offsetX,n.offsetY,!1,!1)},h)},Deactivate:function(){this._super();$(".pv-bucketview-overlay div").fadeOut()},GetUI:function(){return Modernizr.canvas?"<div class='pv-bucketview-overlay'><\/div>":this._super()},GetButtonImage:function(){return"images/bucketview.png"},GetButtonImageSelected:function(){return"images/bucketviewSelected.png"},GetViewName:function(){return"Bucket View"},SetVisibleTileGraphPositions:function(n,t,i,r,u){var a=u&&this.rowscols?this.rowscols.Columns:n.Columns,v,y,e,o,h,f;for(u||(this.rowscols=n),v=[],y=[],e=0;e<this.tiles.length;e++)this.tiles[e].firstFilterItemDone=!1,this.tiles[e]._locations=[this.tiles[e]._locations[0]];for(o=0;o<this.buckets.length;o++){var l=this.buckets[o],s=0,c=0;for(h=0;h<l.tiles.length;h++)f=l.tiles[h],f.firstFilterItemDone?(tileLocation=new PivotViewer.Views.TileLocation,tileLocation.startx=f._locations[0].startx,tileLocation.starty=f._locations[0].starty,tileLocation.x=f._locations[0].x,tileLocation.y=f._locations[0].y,tileLocation.destinationx=o*this.columnWidth+s*n.TileMaxWidth+t,tileLocation.destinationy=this.canvasHeightUIAdjusted-n.TileHeight-c*n.TileHeight+i,f._locations.push(tileLocation)):(r&&(f._locations[0].startx=f._locations[0].x,f._locations[0].starty=f._locations[0].y,f.startwidth=f.width,f.startheight=f.height),f.destinationwidth=n.TileMaxWidth,f.destinationheight=n.TileHeight,f._locations[0].destinationx=o*this.columnWidth+s*n.TileMaxWidth+t,f._locations[0].destinationy=this.canvasHeightUIAdjusted-n.TileHeight-c*n.TileHeight+i,f.start=PivotViewer.Utils.Now(),f.end=f.start+1e3,f.firstFilterItemDone=!0),s==a-1?(s=0,c++):s++}},Bucketize:function(n,t){var g=PivotCollection.GetFacetCategoryByName(t),f,o,r,w,e,b,rt,v,ut,i,k,d,tt,h,u,l,p,it,a,y,s,c;if(n[0].facetItem.FacetByName[t]==undefined)return[{startRange:"(no info)",endRange:"(no info)",tiles:[n[0]],values:["(no info)"],startLabel:"(no info)",endLabel:"(no info)"}];for(f=n[0].facetItem.FacetByName[t].FacetValues[0].Value,i=n.length-1;i>0;i--)if(n[i].facetItem.FacetByName[t]!=undefined)break;if(o=n[i].facetItem.FacetByName[t].FacetValues[0].Value,g.Type==PivotViewer.Models.FacetType.DateTime)return f=new Date(f),o=new Date(o),o.getFullYear()-f.getFullYear()+f.getFullYear()%10>9?GetBuckets(n,t,function(n){var t=new Date(n.Value).getFullYear();return t-t%10},function(n){var t=new Date(n.Value).getFullYear();return t-t%10+"s"}):o.getFullYear()>f.getFullYear()?GetBuckets(n,t,function(n){return new Date(n.Value).getFullYear()},function(n){return new Date(n.Value).getFullYear().toString()}):o.getMonth()>f.getMonth()?GetBuckets(n,t,function(n){return new Date(n.Value).getMonth()},function(n){var t=new Date(n.Value);return GetMonthName(t)+" "+t.getFullYear()}):o.getDate()>f.getDate()?GetBuckets(n,t,function(n){return new Date(n.Value).getDate()},function(n){var t=new Date(n.Value);return GetMonthName(t)+" "+t.getDate()+", "+t.getFullYear()}):o.getHours()>f.getHours()?GetBuckets(n,t,function(n){return new Date(n.Value).getHours()},function(n){var t=new Date(n).Value;return GetMonthName(t)+" "+t.getDate()+", "+t.getFullYear()+" "+GetStandardHour(t)+" "+GetMeridian(t)}):o.getMinutes()>f.getMinutes()?GetBuckets(n,t,function(n){return new Date(n.Value).getMinutes()},function(n){var t=new Date(n.Value);return GetMonthName(t)+" "+t.getDate()+", "+t.getFullYear()+" "+GetStandardHour(t)+":"+GetStandardMinutes(t)+" "+GetMeridian(t)}):GetBuckets(n,t,function(n){return new Date(n.Value).getSeconds()},function(n){var t=new Date(n.Value);return GetMonthName(t)+" "+t.getDate()+", "+t.getFullYear()+" "+GetStandardHour(t)+":"+GetStandardMinutes(t)+"::"+GetStandardSeconds(t)+" "+GetMeridian(t)});if(g.Type==PivotViewer.Models.FacetType.Number){for(r=[],r.ids=[],w=o-f,w==0?e=1:(e=Math.pow(10,Math.ceil(Math.log(w)/Math.log(10))-1),g.integer&&e<=1?e=1:w<=e*5&&(e/=2)),b=Math.floor(f/e)*e,rt=Math.floor((o-b)/e)+1,i=0;i<rt;i++)v=i*e+b,ut=v+e,r[i]={startRange:v,endRange:v,tiles:[],ids:[],startLabel:v.toString(),endLabel:ut.toString()};for(i=0;i<n.length;i++){if(c=n[i].facetItem,k=c.FacetByName[t],k==undefined)break;for(d=0;d<k.FacetValues.length;d++){var nt=k.FacetValues[d].Value,y=Math.floor((nt-b)/e),s=r[y];s.tiles.push(n[i]);s.ids[c.Id]=!0;r.ids[c.Id]=y;s.endRange<nt&&(s.endRange=nt)}}for(tt=0,u=0;u<r.length;u++)r[u].tiles.length==0&&tt++;if(tt>=Math.floor(r.length/2)){for(h=[],h.ids=[],u=0;u<r.length>>1;u++){l=r[2*u];p=r[2*u+1];h.push(l);Array.prototype.push.apply(l.tiles,p.tiles);for(a in l.ids)h.ids[a]=u;for(a in p.ids)l.ids[a]=!0,h.ids[a]=u;l.endRange=p.endRange;l.endLabel=p.endLabel}if(it=2*u,it<r.length){s=r[it];h.push(s);for(a in s.ids)h.ids[a]=u}r=h}if(i!=n.length)for(r.push({startRange:"(no info)",endRange:"(no info)",tiles:[],ids:[],values:["(no info)"],startLabel:"(no info)",endLabel:"(no info)"}),y=r.length-1,s=r[y];i<n.length;i++)c=n[i].facetItem,s.tiles.push(n[i]),s.ids[c.Id]=!0,r.ids[c.Id]=y;return r}return GetBuckets(n,t)},CenterOnTile:function(n){var a=n.facetItem,r=n._locations[n.selectedLoc],u=this.rowscols.TileMaxWidth,t=this.rowscols.PaddingX,i=this.buckets.ids[n.facetItem.Id],f=this.rowscols.Columns,h=Math.round((r.x-this.currentOffsetX-i*(f*u+t))/u),c=i*f+h,l=Math.round((this.canvasHeightUIAdjusted-(r.y-this.currentOffsetY))/n.height)-1,e=n.context.canvas.height,o=n.context.canvas.width-($(".pv-filterpanel").width()+$(".pv-infopanel").width()),s;s=n.height/e>n.height/TileController._imageController.GetRatio(n.facetItem.Img)/o?n.origheight/e:n.origwidth/o;this.selected==null&&$(".pv-toolbarpanel-zoomslider").slider("option","value",Math.round(.75/s*2));t=this.rowscols.PaddingX*i;this.currentOffsetX=this.width/2-this.rowscols.TileMaxWidth*c-this.rowscols.TileMaxWidth/2-t;this.currentOffsetY=this.height/2-this.canvasHeightUIAdjusted+this.rowscols.TileHeight/2+l*this.rowscols.TileHeight;this.SetVisibleTileGraphPositions(this.rowscols,this.currentOffsetX,this.currentOffsetY,!0,!0)},handleSelection:function(n,t,i,r){var f=!1,e=!1,o,u;this.selected!=n&&this.selected==null&&(o=$(".pv-toolbarpanel-zoomslider").slider("option","value"),o!=0&&$(".pv-toolbarpanel-zoomslider").slider("option","value",0));n!=null&&(n.Selected(!0),n.selectedLoc=r,f=!0);this.selected!=null&&n==null&&(e=!0);n!=null&&this.selected!=n?(this.CenterOnTile(n),$(".pv-bucketview-overlay div").fadeOut("slow")):this.selected!=null&&(this.selected=n=null,$(".pv-toolbarpanel-zoomslider").slider("option","value",0),$(".pv-bucketview-overlay div").fadeIn("slow"));$.publish("/PivotViewer/Views/Item/Selected",[{item:n}]);f||e||(u=this.buckets[this.GetBucket(t)],$.publish("/PivotViewer/Views/Item/Filtered",[{Facet:this.sortFacet,Item:u.startRange,MaxRange:u.endRange,Values:u.values,ClearFacetFilters:!0}]))}});
