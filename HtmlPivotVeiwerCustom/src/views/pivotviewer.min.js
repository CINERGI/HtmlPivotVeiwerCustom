var PV=null,PivotCollection=new PivotViewer.Models.Collection,TileController=null,Loader=null,LoadSem=new Semaphore(1);(function(n){var i=[],o=[],w=[],b=[],c=[],p=[],g=[],nt=[],v=[],e=0,r=[],t=[],l=null,k,s=null,h=null,u={View:null,Facet:null,Filters:[]},a=null,y={},tt={},f={visibleCategories:undefined},d={init:function(t){a=this;a.addClass("pv-wrapper");tt=t;n.getJSON("defaults.json").always(function(i){for(var h,l,r,c,o,e,a,v,y,s=Object.keys(i),f=0;f<s.length;f++)t[s[f]]==undefined&&t[s[f]]==i[s[f]];if(t.ViewerState!=undefined)for(h=t.ViewerState.split("&"),f=0,l=h.length;f<l;f++)if(r=h[f].split("="),r.length==2)if(r[0]=="$view$")u.View=parseInt(r[1])-1;else if(r[0]=="$facet0$")u.Facet=PivotViewer.Utils.EscapeItemId(r[1]);else if(r[0]=="$selection$")u.Selection=PivotViewer.Utils.EscapeItemId(r[1]);else if(r[0]=="$tableFacet$")u.TableFacet=PivotViewer.Utils.EscapeItemId(r[1]);else{for(c={Facet:r[0],Predicates:[]},o=r[1].split("_"),e=0,a=o.length;e<a;e++)o[e].indexOf(".")>0&&(v=o[e].substring(0,o[e].indexOf(".")),y=o[e].substring(o[e].indexOf(".")+1),c.Predicates.push({Operator:v,Value:y}));u.Filters.push(c)}if(t.ImageController==undefined)k=new PivotViewer.Views.DeepZoomImageController;else if(t.ImageController instanceof PivotViewer.Views.IImageController)k=t.ImageController;else throw"Image Controller does not inherit from PivotViewer.Views.IImageController.";if(t.Loader==undefined){n(".pv-wrapper").append("<div id='pv-file-selection' class='pv-modal-dialog modal-lg'><div><div id='pv-modal-text'><p>Use Existing Project:<br><select id='pv-server-file' class='pv-server-file'><option>Select a file<\/option><\/select><p>Create New Project:<br><input id='pv-load-file' class='pv-load-file' type=file accept='.csv'><\/div><\/div><\/div>");$pv_server_file=n("#pv-server-file");n.getJSON("../project_list.php",function(t){n.each(t,function(n,t){$pv_server_file.append('<option value="'+t+'">'+t+"<\/option>")})});$pv_server_file.on("change",function(){Loader=$pv_server_file.val().endsWith(".cxml")?new PivotViewer.Models.Loaders.CXMLLoader("projects/"+$pv_server_file.val()):new PivotViewer.Models.Loaders.CSVLoader("projects/"+$pv_server_file.val());InitCollectionLoader(t);window.open("#pv-modal-dialog-close","_self")});n(".pv-load-file").on("change",function(){var i=n("#pv-load-file")[0];Loader=new PivotViewer.Models.Loaders.LocalCSVLoader(i.files[0]);InitCollectionLoader(t)})}else Loader=t.Loader,InitCollectionLoader(t);window.open("#pv-file-selection","_self")}).fail(function(n,t,i){var r=t+", "+i;Debug.Log("Getting defaults file failed: "+r)})}};InitCollectionLoader=function(){if(PV=this,a.append("<div class='pv-loading'><img src='images/loading.gif' alt='Loading' /><span>Loading...<\/span><\/div>"),n(".pv-loading").css("top",n(".pv-wrapper").height()/2-33+"px"),n(".pv-loading").css("left",n(".pv-wrapper").width()/2-43+"px"),Loader==undefined)throw"Collection loader is undefined.";if(Loader instanceof PivotViewer.Models.Loaders.ICollectionLoader)Loader.LoadCollection(PivotCollection);else throw"Collection loader does not inherit from PivotViewer.Models.Loaders.ICollectionLoader.";};CreateBucketizedDateTimeFacets=function(n,t,i){var u=["<ul class='pv-filterpanel-accordion-facet-list'>"],r,f;if(t)for(r=0;r<t.length;r++)f=r+1,u[f]="<li class='pv-filterpanel-accordion-facet-list-item'  id='pv-facet-item-"+CleanName(n)+"__"+CleanName(t[r].name.toString())+"'>",u[f]+="<input itemvalue='"+CleanName(t[r].name.toString())+"' itemfacet='"+CleanName(n.toString())+"' startdate='"+t[r].start.toISOString()+"' enddate='"+t[r].end+"' class='pv-facet-facetitem' type='checkbox' />",u[f]+="<span class='pv-facet-facetitem-label' title='"+t[r].name+"'>"+t[r].name+"<\/span>",u[f]+="<span class='pv-facet-facetitem-count'>0<\/span>",u[f]+="<\/li>";if(u[t.length+1]="<li class='pv-filterpanel-accordion-facet-list-item'  id='pv-facet-item-LineBreak' style='border-bottom:thin solid #E2E2E2;'><\/li>",u[t.length+2]="<\/ul>",u[t.length+3]="<ul class='pv-filterpanel-accordion-facet-list'>",i)for(r=0;r<i.length;r++)f=r+4+t.length,u[f]="<li class='pv-filterpanel-accordion-facet-list-item'  id='pv-facet-item-"+CleanName(n)+"__"+CleanName(i[r].name.toString())+"'>",u[f]+="<input itemvalue='"+CleanName(i[r].name.toString())+"' itemfacet='"+CleanName(n.toString())+"' startdate='"+i[r].start.toISOString()+"' enddate='"+i[r].end.toISOString()+"' class='pv-facet-facetitem' type='checkbox' />",u[f]+="<span class='pv-facet-facetitem-label' title='"+i[r].name+"'>"+i[r].name+"<\/span>",u[f]+="<span class='pv-facet-facetitem-count'>0<\/span>",u[f]+="<\/li>";return u[t.length+i.length+4]="<li class='pv-filterpanel-accordion-facet-list-item'  id='pv-facet-item-LineBreak2' style='border-bottom:thin solid #E2E2E2;'><\/li>",u[t.length+i.length+5]="<\/ul>",u.join("")};CreateCustomRange=function(n){var t=["<ul class='pv-filterpanel-accordion-facet-list'>"];return t[1]="<li class='pv-filterpanel-accordion-facet-list-item'  id='pv-facet-item-"+CleanName(n)+"___CustomRange'>",t[1]+="<input itemvalue='CustomRange' itemfacet='"+CleanName(n)+"' class='pv-facet-facetitem' type='checkbox' />",t[1]+="<span class='pv-facet-facetitem-label' title='Custom Range'>Custom Range<\/span>",t[1]+="<\/li>",t[1]+="<ul class='pv-filterpanel-accordion-facet-list'>",t[1]+="<li class='pv-filterpanel-accordion-facet-list-item' id='pv-custom-range-"+CleanName(n)+"__Start' style='visibility:hidden;float:right'>",t[1]+="<span class='pv-facet-customrange-label' title='Start Date' >Start:<\/span>",t[1]+="<input itemvalue='CustomRangeStart' itemfacet='"+CleanName(n)+"' id='pv-custom-range-"+CleanName(n)+"__StartDate' class='pv-facet-customrange' type='text'/>",t[1]+="<\/li>",t[1]+="<li class='pv-filterpanel-accordion-facet-list-item' id='pv-custom-range-"+CleanName(n)+"__Finish' style='visibility:hidden;float:right'>",t[1]+="<span class='pv-facet-customrange-label' title='End Date'>End:<\/span>",t[1]+="<input itemvalue='CustomRangeFinish' itemfacet='"+CleanName(n)+"' id='pv-custom-range-"+CleanName(n)+"__FinishDate' class='pv-facet-customrange' type='text'/>",t[1]+="<\/li>",t[t.length]="<\/ul>",t.join("")};CreateDatetimeNoInfoFacet=function(n){var r=o[n],i,t;return r==undefined?"":(i=r["(no info)"],t="<ul class='pv-filterpanel-accordion-facet-list'>",i!=undefined&&(t+="<li class='pv-filterpanel-accordion-facet-list-item'  id='"+i.id+"'>",t+="<input itemvalue='"+CleanName(i.value)+"' itemfacet='"+CleanName(n)+"' class='pv-facet-facetitem' type='checkbox' />",t+="<span class='pv-facet-facetitem-label' title='"+i.value+"'>"+i.value+"<\/span>",t+="<span class='pv-facet-facetitem-count'>0<\/span>",t+="<\/li>"),t+="<li class='pv-filterpanel-accordion-facet-list-item'  style='border-bottom:thin solid #E2E2E2;'><\/li>",t+"<\/ul>")};CreateStringFacet=function(n){var t=["<ul class='pv-filterpanel-accordion-facet-list'>"],u=o[n],i=1,f,r;for(f in u.values)r=u.values[f],t[i]="<li class='pv-filterpanel-accordion-facet-list-item'  id='"+r.id+"'>",t[i]+="<input itemvalue='"+CleanName(r.value)+"' itemfacet='"+CleanName(n)+"' class='pv-facet-facetitem' type='checkbox' />",t[i]+="<span class='pv-facet-facetitem-label' title='"+r.value+"'>"+r.value+"<\/span>",t[i]+="<span class='pv-facet-facetitem-count'>0<\/span>",t[i++]+="<\/li>";return t[t.length]="<\/ul>",t.join("")};CreateNumberFacet=function(n,t){CreateHistogram(n,PivotViewer.Utils.Histogram(t))};CreateOrdinalFacet=function(n,t){CreateHistogram(n,PivotViewer.Utils.OrdinalHistogram(t))};CreateHistogram=function(t,i){var c=165,o=80,u=CleanName(t.Name),s=n("#pv-filterpanel-category-numberitem-"+PivotViewer.Utils.EscapeMetaChars(u)),r,e,h,v,y,p;s.empty();s.append("<span class='pv-filterpanel-numericslider-range-val'>&nbsp;<\/span>");var l="<svg class='pv-filterpanel-accordion-facet-chart' width='"+c+"' height='"+o+"'>",a=.5+c/i.binCount|0,f=0;for(r=0,e=i.histogram.length;r<e;r++)f=f<i.histogram[r].length?i.histogram[r].length:f;for(r=0,e=i.histogram.length;r<e;r++)h=.5+o/(f/i.histogram[r].length)|0,v=.5+a*r|0,l+="<rect x='"+v+"' y='"+(o-h)+"' width='"+a+"' height='"+h+"'><\/rect>";s.append(l+"<\/svg>");y=n("#pv-filterpanel-category-numberitem-"+PivotViewer.Utils.EscapeMetaChars(u));y.append('<\/span><div id="pv-filterpanel-numericslider-'+u+'" class="pv-filterpanel-numericslider"><\/div><span class="pv-filterpanel-numericslider-range-min">'+i.min+'<\/span><span class="pv-filterpanel-numericslider-range-max">'+i.max+"<\/span>");p=n("#pv-filterpanel-numericslider-"+PivotViewer.Utils.EscapeMetaChars(u));p.slider({range:!0,min:i.min,max:i.max,values:[i.min,i.max],start:function(n,t){this.startMin=t.values[0];this.startMax=t.values[1]},slide:function(t,i){n(this).parent().find(".pv-filterpanel-numericslider-range-val").text(i.values[0]+" - "+i.values[1])},stop:function(i,r){var u=n(this),f=u.slider("option","min"),e=u.slider("option","max");r.values[0]>f||r.values[1]<e?u.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible"):r.values[0]==f&&r.values[1]==e&&u.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden");FilterCollection({category:t,enlarge:this.startMin>r.values[0]||this.startMax<r.values[1],min:r.values[0],max:r.values[1],rangeMin:f,rangeMax:e})}})};CreateViews=function(){};SelectView=function(t){DeselectInfoPanel();n("#pv-viewpanel-view-"+e+"-image").attr("src",i[e].GetButtonImage());i[e].Deactivate();n("#pv-viewpanel-view-"+t+"-image").attr("src",i[t].GetButtonImageSelected());i[t].Activate();e=t;n(".pv-viewpanel-view").hide();n("#pv-viewpanel-view-"+e).show()};SortFacetItems=function(t){var f,o,u,r;if(PivotCollection.GetFacetCategoryByName(t).Type!=PivotViewer.Models.FacetType.DateTime){var e=n("#pv-cat-"+PivotViewer.Utils.EscapeMetaChars(CleanName(t))+" ul"),s=e.prev().text().replace("Sort: ",""),i=e.children("li").get();if(s=="A-Z")i.sort(function(t,i){var r=n(t).children().first().attr("itemvalue"),u=n(i).children().first().attr("itemvalue");return r<u?1:r>u?-1:0});else if(s=="Quantity")i.sort(function(t,i){var r=parseInt(n(t).children(".pv-facet-facetitem-count").text()),u=parseInt(n(i).children(".pv-facet-facetitem-count").text());return r<u?-1:r>u?1:0});else if(f=PivotCollection.GetFacetCategoryByName(t),f.CustomSort!=undefined){for(o=[],r=f.CustomSort.SortValues.length-1;r>=0;r--)for(u=0;u<i.length;u++)f.CustomSort.SortValues[r]==n(i[u]).children(".pv-facet-facetitem-label").text()&&o.push(i[u]);i=o}for(r=0;r<i.length;r++)e.prepend(i[r])}};SelectStringFacetItem=function(t,i){var r=n('.pv-facet-facetitem[itemfacet="'+t+'"][itemvalue="'+i+'"]');r.prop("checked",!0);r.parent().parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible")};FilterCollection=function(i){var ii=n(".pv-toolbarpanel-sort option:selected").attr("label"),w,h,o,it,ht,at,vt,gt,yt,s,pt,b,st,a,k,ot,c,et,f,e,d,ct,tt,ft,lt,dt,rt,u,ut,kt;if(DeselectInfoPanel(),l=null,n(".pv-filterpanel-clearall").css("visibility","hidden"),i==undefined){for(ht=n(".pv-facet-facetitem:checked"),w=[],h=[],o=[],it=[],u=0;u<ht.length;u++){var f=y[n(ht[u]).attr("itemfacet")],wt=y[n(ht[u]).attr("itemvalue")],s=PivotCollection.GetFacetCategoryByName(f);s.Type==PivotViewer.Models.FacetType.String?(b=w[f],b!=undefined?b.facetValue[wt+"a"]=!0:(b={facet:f,facetValue:[],index:u},b.facetValue[wt+"a"]=!0,w.push(b),w[f]=b,it[f]=!0)):s.Type==PivotViewer.Models.FacetType.DateTime&&(at=n("#pv-custom-range-"+CleanName(f)+"__StartDate")[0].value,vt=n("#pv-custom-range-"+CleanName(f)+"__FinishDate")[0].value,at&&vt?st={facetValue:wt,startDate:new Date(at),endDate:new Date(vt)}:(at=n(ht[u]).attr("startdate"),vt=n(ht[u]).attr("enddate"),st={facetValue:wt,startDate:new Date(at),endDate:new Date(vt)}),k=h[f],k!=undefined?k.facetValue.push(st):(k={facet:f,facetValue:[st]},h.push(k),h[f]=k,it[f]=!0))}for(u=0,ut=PivotCollection.FacetCategories.length;u<ut;u++)if(f=PivotCollection.FacetCategories[u].Name,(PivotCollection.FacetCategories[u].Type==PivotViewer.Models.FacetType.Number||PivotCollection.FacetCategories[u].Type==PivotViewer.Models.FacetType.Ordinal)&&(gt=n("#pv-filterpanel-category-numberitem-"+CleanName(f)),yt=n(gt).find(".pv-filterpanel-numericslider"),yt.length>0)){var bt=yt.slider("values"),ni=yt.slider("option","max"),ti=yt.slider("option","min");(bt[0]!=ti||bt[1]!=ni)&&(o.push({facet:f,selectedMin:bt[0],selectedMax:bt[1],rangeMin:ti,rangeMax:ni}),o[f]=o[u],it[f]=!0)}}else if(w=p,h=nt,o=g,it=v,s=i.category,s.Type==PivotViewer.Models.FacetType.Number||s.Type==PivotViewer.Models.FacetType.Ordinal)numericFacet=o[s.Name],numericFacet==undefined?(numericFacet={facet:s.Name,selectedMin:i.min,selectedMax:i.max,rangeMin:i.rangeMin,rangeMax:i.rangeMax},o.push(numericFacet),o[s.Name]=numericFacet):(numericFacet.selectedMin=i.min,numericFacet.selectedMax=i.max),it[s.Name]=!0;else if(!i.enlarge&&it[s.Name]!=undefined||i.clear){if(s.Type==PivotViewer.Models.FacetType.String)b=w[s.Name],delete b.facetValue[i.value+"a"],b.facetValue.splice(b.facetValue.indexOf(i.value),1),Object.keys(b.facetValue).length==0&&(delete w[s.Name],w.splice(b.index,1),delete it[s.Name]);else for(k=h[s.Name],pt=0;pt<k.facetValue.length;pt++)if(k.facetValue[pt].facetValue==i.value){k.facetValue.splice(pt,1);k.facetValue.length==0&&(delete h[s.Name],h.splice(k.index,1),delete it[s.Name]);break}}else s.Type==PivotViewer.Models.FacetType.String?(b=w[s.Name],b!=undefined?(b.facetValue[i.value+"a"]=!0,b.facetValue.push(i.value)):(b={facet:s.Name,facetValue:[i.value],index:u},b.facetValue[i.value+"a"]=!0,w.push(b),w[s.Name]=b)):(st={facetValue:i.value,startDate:i.min,endDate:i.max},k=h[s.Name],k!=undefined?k.facetValue.push(st):(k={facet:s.Name,facetValue:[st]},h.push(k),h[s.Name]=k)),it[s.Name]=!0;for(t=[],u=0,ut=r.length;u<ut;u++){if(a=r[u],i!=undefined&&(!i.enlarge||a.visible)){if(i.enlarge||a.visible){if(i.enlarge){t.push(a);continue}}else continue;if(i.category.Type==PivotViewer.Models.FacetType.String)if(f=a.facetItem.FacetByName[i.category.Name],f==undefined){if(i.value=="(no info)"==i.clear){a.visible=!1;continue}}else{for(e=0;e<f.FacetValues.length;e++)if(f.FacetValues[e].Value==i.value!=i.clear)break;if(e==f.FacetValues.length){a.visible=!1;continue}}else if(i.category.Type==PivotViewer.Models.FacetType.Number||i.category.Type==PivotViewer.Models.FacetType.Ordinal)if(f=a.facetItem.FacetByName[i.category.Name],f==undefined){a.visible=!1;continue}else{for(e=0,d=f.FacetValues.length;e<d;e++)if(ot=parseFloat(f.FacetValues[e].Value),f=o[s.Name],!isNaN(ot)&&ot>=f.selectedMin&&ot<=f.selectedMax)break;if(e==d){a.visible=!1;continue}}else if(f=a.facetItem.FacetByName[i.category.Name],k=h[i.category.Name],f==undefined){if(i.value=="(no info)"==i.clear){a.visible=!1;continue}}else{for(e=0,d=f.FacetValues.length;e<d;e++){for(ct=new Date(f.FacetValues[e].Value),tt=0,ft=k.facetValue.length;tt<ft;tt++)if(lt=k.facetValue[tt],(ct>=lt.startDate&&ct<=lt.endDate)==i.clear)break;if(tt==ft!=i.clear)break}if(e==d){a.visible=!1;continue}}t.push(a);continue}for(c=0,et=w.length;c<et;c++){if(f=a.facetItem.FacetByName[w[c].facet],f==undefined)if(w[c].facetValue["(no info)a"])continue;else break;for(e=0,d=f.FacetValues.length;e<d;e++)if(w[c].facetValue[f.FacetValues[e].Value+"a"])break;if(e==d)break}if(c<et){a.visible=!1;continue}for(c=0,et=o.length;c<et;c++){if(f=a.facetItem.FacetByName[o[c].facet],f==undefined)if(o[c].selectedMin=="(no info)")continue;else break;for(e=0,d=f.FacetValues.length;e<d;e++)if(ot=parseFloat(f.FacetValues[e].Value),!isNaN(ot)&&ot>=o[c].selectedMin&&ot<=o[c].selectedMax)break;if(e==d)break}if(c<et){a.visible=!1;continue}for(c=0,et=h.length;c<et;c++){if(f=a.facetItem.FacetByName[h[c].facet],f==undefined){for(tt=0,ft=h[c].facetValue.length;tt<ft;tt++)if(h[c].facetValue[tt].facetValue=="(no info)")break;if(tt==ft)break;else continue}for(e=0,d=f.FacetValues.length;e<d;e++){for(ct=new Date(f.FacetValues[e].Value),tt=0,ft=h[c].facetValue.length;tt<ft;tt++)if(lt=h[c].facetValue[tt],ct>=lt.startDate&&ct<=lt.endDate)break;if(tt<ft)break}if(e==d)break}if(c<et){a.visible=!1;continue}a.visible=!0;t.push(a)}for(t.length!=r.length&&n(".pv-filterpanel-clearall").css("visibility","visible"),g=o,p=w,nt=h,v=it,u=0;u<PivotCollection.FacetCategories.length;u++)PivotCollection.FacetCategories[u].recount=!0;if(FilterFacets(n(n(".pv-facet")[n(".pv-filterpanel-accordion").accordion("option","active")])),n("#pv-toolbarpanel-countbox").html(t.length),dt=n(".pv-toolbarpanel-facetbreadcrumb"),dt.empty(),w.length>0||o.length>0||h.length>0){for(rt="|",u=0,ut=w.length;u<ut;u++)rt+="<span class='pv-toolbarpanel-facetbreadcrumb-facet'>"+w[u].facet+":<\/span><span class='pv-toolbarpanel-facetbreadcrumb-values'>",rt+=w[u].facetValue.join(", "),rt+="<\/span><span class='pv-toolbarpanel-facetbreadcrumb-separator'>&gt;<\/span>";for(u=0,ut=o.length;u<ut;u++)rt+="<span class='pv-toolbarpanel-facetbreadcrumb-facet'>"+o[u].facet+":<\/span><span class='pv-toolbarpanel-facetbreadcrumb-values'>",rt+=o[u].selectedMin==o[u].rangeMin?"Under "+o[u].selectedMax:o[u].selectedMax==o[u].rangeMax?"Over "+o[u].selectedMin:o[u].selectedMin==o[u].selectedMax?o[u].selectedMin:o[u].selectedMin+" - "+o[u].selectedMax,rt+="<\/span><span class='pv-toolbarpanel-facetbreadcrumb-separator'>&gt;<\/span>";for(u=0,ut=h.length;u<ut;u++)for(kt=0;kt<h[u].facetValue.length;kt++)rt+="<span class='pv-toolbarpanel-facetbreadcrumb-facet'>"+h[u].facet+":<\/span><span class='pv-toolbarpanel-facetbreadcrumb-values'>",rt+=h[u].facetValue[kt].facetValue,rt+="<\/span><span class='pv-toolbarpanel-facetbreadcrumb-separator'>&gt;<\/span>";dt.append(rt);TileController.SetCircularEasingBoth()}n.publish("/PivotViewer/Views/Filtered",[{tiles:r,filter:t,sort:ii,stringFacets:w}])};InitUIFacet=function(t){Loader.LoadColumn(t);LoadSem.acquire(function(i){var l=n("#pv-cat-"+CleanName(t.Name)),y,s,v,r,e,h,a,f,u;if(t.Type==PivotViewer.Models.FacetType.DateTime){CreateDatetimeBuckets(t);l.append(CreateBucketizedDateTimeFacets(t.Name,t.datetimeBuckets[0],t.datetimeBuckets[1]));l.append(CreateDatetimeNoInfoFacet(t.Name));l.append(CreateCustomRange(t.Name));n("#pv-cat-"+CleanName(t.Name)+" .pv-facet-customrange").on("change",function(){CustomRangeChanged(this)});n("#pv-cat-"+CleanName(t.Name)+" .pv-facet-facetitem").on("click",function(){FacetItemClick(this)});n("#pv-cat-"+CleanName(t.Name)+" .pv-facet-facetitem-label").on("click",function(){var t=n(this).prev();t.prop("checked",!t.prop("checked"));FacetItemClick(t[0])})}else if(t.Type==PivotViewer.Models.FacetType.String){for(s=0;s<PivotCollection.Items.length;s++)if(v=PivotCollection.Items[s],r=v.FacetByName[t.Name],r!=undefined)for(e=0;e<r.FacetValues.length;e++){var h=r.FacetValues[e].Value,a="pv-facet-item-"+CleanName(r.Name)+"__"+CleanName(r.FacetValues[e].Value),f=o[r.Name];f==undefined&&(f=o[r.Name]={values:[],facet:r.Name,filtered:!0});u=f.values[h];u==undefined?(f.values[h]={id:a,value:h,count:1},c.push({facet:r.Name,value:h})):u.count++}else a="pv-facet-item-"+CleanName(t.Name)+"__"+CleanName("(no info)"),f=o[t.Name],f==undefined&&(f=o[t.Name]={values:[],facet:t.Name,filtered:!0}),u=f.values["(no info)"],u==undefined?f.values["(no info)"]={id:a,value:"(no info)",count:1}:u.count++;t.CustomSort!=undefined||t.CustomSort!=null?l.append("<span class='pv-filterpanel-accordion-facet-sort' customSort='"+t.CustomSort.Name+"'>Sort: "+t.CustomSort.Name+"<\/span>"):l.append("<span class='pv-filterpanel-accordion-facet-sort'>Sort: A-Z<\/span>");l.append(CreateStringFacet(t.Name));y=o[t.Name];for(h in y.values)u=y.values[h],u.valueItem=n("#"+u.id),u.itemCount=u.valueItem.find("span").last();n("#pv-cat-"+CleanName(t.Name)+" .pv-facet-facetitem").on("click",function(){FacetItemClick(this)});n("#pv-cat-"+CleanName(t.Name)+" .pv-facet-facetitem-label").on("click",function(){var t=n(this).prev();t.prop("checked",!t.prop("checked"));FacetItemClick(t[0])});n("#pv-cat-"+CleanName(t.Name)+" .pv-filterpanel-accordion-facet-sort").on("click",function(){var t=n(this),i=t.text(),u=t.parent().prev().children("a").text(),r=t.attr("customSort");i=="Sort: A-Z"?n(this).text("Sort: Quantity"):i=="Sort: Quantity"&&r==undefined?n(this).text("Sort: A-Z"):i=="Sort: Quantity"?n(this).text("Sort: "+r):n(this).text("Sort: A-Z");SortFacetItems(u)})}else if(t.Type==PivotViewer.Models.FacetType.Number){for(s=0;s<PivotCollection.Items.length;s++)if(v=PivotCollection.Items[s],r=v.FacetByName[t.Name],r!=undefined)for(e=0;e<r.FacetValues.length;e++)h=r.FacetValues[e].Value,u=w[r.Name],u!=undefined?u.values.push(h):w[r.Name]={facet:r.Name,values:[h],filtered:!0};else a="pv-facet-item-"+CleanName(t.Name)+"__"+CleanName("(no info)"),f=o[t.Name],f==undefined&&(f=o[t.Name]={values:[],facet:t.Name,filtered:!0}),u=f.values["(no info)"],u==undefined?f.values["(no info)"]={id:a,value:"(no info)",count:1}:u.count++;l.append("<div id='pv-filterpanel-category-numberitem-"+CleanName(t.Name)+"'><\/div>");CreateNumberFacet(t,w[t.Name].values)}else if(t.Type==PivotViewer.Models.FacetType.Ordinal){for(s=0;s<PivotCollection.Items.length;s++)if(v=PivotCollection.Items[s],r=v.FacetByName[t.Name],r!=undefined)for(e=0;e<r.FacetValues.length;e++)h=r.FacetValues[e].Value,u=b[r.Name],u!=undefined?u.values.push(h):b[r.Name]={facet:r.Name,values:[h],filtered:!0};else a="pv-facet-item-"+CleanName(t.Name)+"__"+CleanName("(no info)"),f=o[t.Name],f==undefined&&(f=o[t.Name]={values:[],facet:t.Name,filtered:!0}),u=f.values["(no info)"],u==undefined?f.values["(no info)"]={id:a,value:"(no info)",count:1}:u.count++;l.append("<div id='pv-filterpanel-category-numberitem-"+CleanName(t.Name)+"'><\/div>");CreateOrdinalFacet(t,b[t.Name].values)}t.uiInit=!0;i()})};FilterFacets=function(i){var u=PivotCollection.GetFacetCategoryByName(i.children()[0].innerHTML);u.IsFilterVisible&&u.recount&&(u.uiInit||InitUIFacet(u),LoadSem.acquire(function(i){var k=[],g,c,tt,f,a,e,p,s,nt,y,h,l,d;if(t.length*2<r.length)k=t;else for(h=0;h<r.length;h++)r[h].visible||k.push(r[h]);if(u.Type==PivotViewer.Models.FacetType.String){for(c=[],tt=PivotViewer.Utils.EscapeMetaChars("pv-facet-item-"+CleanName(u.Name)+"__"+CleanName("(no info)")),e=0;e<k.length;e++){if(l=k[e].facetItem.FacetByName[u.Name],l==undefined){a=c[tt];a!=undefined?a.count++:c[tt]={count:1};continue}for(s=0;s<l.FacetValues.length;s++)f=PivotViewer.Utils.EscapeMetaChars("pv-facet-item-"+CleanName(u.Name)+"__"+CleanName(l.FacetValues[s].Value)),a=c[f],a!=undefined?a.count++:c[f]={count:1}}if(k==t){y=o[u.Name].values;for(g in y)f=y[g],c[f.id]==undefined?v[u.Name]||f.valueItem.hide():(f.valueItem.show(),f.itemCount.text(c[f.id].count))}else{y=o[u.Name].values;for(g in y)f=y[g],nt=c[f.id]==undefined?o[u.Name].values[g].count:o[u.Name].values[g].count-c[f.id].count,nt==0?v[u.Name]||f.valueItem.hide():(f.valueItem.show(),f.itemCount.text(nt))}SortFacetItems(u.Name)}else if(u.Type==PivotViewer.Models.FacetType.DateTime){for(c=[],tt=PivotViewer.Utils.EscapeMetaChars("#pv-facet-item-"+CleanName(u.Name)+"__"+CleanName("(no info)")),h=0;h<k.length;h++)if(l=k[h].facetItem.FacetByName[u.Name],l==undefined)a=c[tt],a!=undefined?a.count++:c[f]={count:1};else for(e=0;e<u.datetimeBuckets.length&&e<2;e++)for(p=u.datetimeBuckets[e],s=0;s<p.length;s++)if(p[s].items[k[h].facetItem.Id+"a"]!=undefined){f=PivotViewer.Utils.EscapeMetaChars("#pv-facet-item-"+CleanName(u.Name)+"__"+CleanName(p[s].name.toString()));a=c[f];a!=undefined?a.count++:c[f]={count:1};break}if(k==t)for(e=0;e<u.datetimeBuckets.length&&e<2;e++)for(p=u.datetimeBuckets[e],s=0;s<p.length;s++)f=PivotViewer.Utils.EscapeMetaChars("#pv-facet-item-"+CleanName(u.Name)+"__"+CleanName(p[s].name.toString())),c[f]==undefined?v[u.Name]||n(f).hide():(n(f).show(),n(f).find("span").last().text(c[f].count));else for(e=0;e<u.datetimeBuckets.length&&e<2;e++)for(p=u.datetimeBuckets[e],s=0;s<p.length;s++)f=PivotViewer.Utils.EscapeMetaChars("#pv-facet-item-"+CleanName(u.Name)+"__"+CleanName(p[s].name.toString())),nt=c[f]==undefined?p[s].items.length:p[s].items.length-c[f].count,nt==0?v[u.Name]||n(f).hide():(n(f).show(),n(f).find("span").last().text(nt))}else if(u.Type==PivotViewer.Models.FacetType.Number)if(t.length==r.length)CreateNumberFacet(u,w[u.Name].values);else{for(y=[],h=0;h<t.length;h++)if(l=t[h].facetItem.FacetByName[u.Name],l!=undefined)for(d=0;d<l.FacetValues.length;d++)y.push(l.FacetValues[d].Value);CreateNumberFacet(u,y)}else if(u.Type==PivotViewer.Models.FacetType.Ordinal)if(t.length==r.length)CreateOrdinalFacet(u,b[u.Name].values);else{for(y=[],h=0;h<t.length;h++)if(l=t[h].facetItem.FacetByName[u.Name],l!=undefined)for(d=0;d<l.FacetValues.length;d++)y.push(l.FacetValues[d].Value);CreateOrdinalFacet(u,y)}u.recount=!1;i()}))};DeselectInfoPanel=function(){n(".pv-infopanel").fadeOut();n(".pv-infopanel-heading").empty();n(".pv-infopanel-details").empty()};CleanName=function(n){return name=n.replace(/[^\w]/gi,"_"),y[name]=n,name};n.subscribe("/PivotViewer/Models/Collection/Loaded",function(){var s,t,h,c,e,o,i,u,l;if(n.cookie.json=!0,f.visibleCategories=n.cookie(PivotCollection.CollectionName+"_visible_categories"),f.visibleCategories==undefined)for(f.visibleCategories=[],s=0;s<PivotCollection.FacetCategories.length;s++)f.visibleCategories.push(s);t="<div class='pv-toolbarpanel'>";h=PivotCollection.BrandImage;h.length>0&&(t+="<img class='pv-toolbarpanel-brandimage' src='"+h+"'><\/img>");t+="<span class='pv-toolbarpanel-name'>"+PivotCollection.CollectionName+"<\/span>";t+="<span class='pv-countbox' id='pv-toolbarpanel-countbox' width=25><\/span>";t+="<div class='pv-toolbarpanel-facetbreadcrumb'><\/div>";t+="<div class='pv-toolbarpanel-zoomcontrols'><div class='pv-toolbarpanel-zoomslider'><\/div>";t+="<div class='pv-toolbarpanel-timelineselector'><\/div>";t+="<div class='pv-toolbarpanel-maplegend'><\/div><\/div>";t+="<div class='pv-toolbarpanel-viewcontrols'><\/div>";t+="<div class='pv-toolbarpanel-sortcontrols'><\/div>";t+="<\/div>";a.append(t);c=0;n(".pv-toolbarpanel-zoomslider").slider({max:100,change:function(t,i){var r=i.value-c;n.publish("/PivotViewer/Views/Canvas/Zoom",[{x:n(".pv-viewarea-canvas").width()/2,y:n(".pv-viewarea-canvas").height()/2,delta:.5*r}]);c=i.value}});a.append("<div class='pv-mainpanel'><\/div>");e=n(window).height()-n(".pv-toolbarpanel").height()-30;n(".pv-mainpanel").css("height",e+"px");n(".pv-mainpanel").append("<div class='pv-filterpanel'><\/div>");n(".pv-mainpanel").append("<div class='pv-viewpanel'><canvas class='pv-viewarea-canvas' width='"+a.width()+"' height='"+e+"px'><\/canvas><\/div>");n(".pv-mainpanel").append("<div class='pv-infopanel'><\/div>");n(".pv-viewpanel").append("<div class='pv-tableview-table' id='pv-table'><\/div>");n(".pv-viewpanel").append("<div class='pv-mapview-canvas' id='pv-map-canvas'><\/div>");n(".pv-mainpanel").append("<div class='pv-mapview-legend' id='pv-map-legend'><\/div>");n(".pv-viewpanel").append("<div class='pv-timeview-canvas' id='pv-time-canvas'><\/div>");n(".pv-mapview-legend").css("left",n(".pv-mainpanel").offset().left+n(".pv-mainpanel").width()-205+"px").css("height",e-28+"px");o=n(".pv-filterpanel");o.append("<div class='pv-filterpanel-clearall'>Clear All<\/div>").append("<input class='pv-filterpanel-search' type='text' placeholder='Search...' /><div class='pv-filterpanel-search-autocomplete'><\/div>").css("height",e-13+"px");navigator.userAgent.match(/iPad/i)!=null?n(".pv-filterpanel-search").css("width",o.width()-10+"px"):n(".pv-filterpanel-search").css("width",o.width()-2+"px");n(".pv-filterpanel-search-autocomplete").css("width",o.width()-8+"px").hide();i=n(".pv-infopanel");i.css("left",n(".pv-mainpanel").offset().left+n(".pv-mainpanel").width()-205+"px").css("height",e-28+"px");i.append("<div class='pv-infopanel-controls'><\/div>");n(".pv-infopanel-controls").append("<div><div class='pv-infopanel-controls-navleft'><\/div><div class='pv-infopanel-controls-navleftdisabled'><\/div><div class='pv-infopanel-controls-navbar'><\/div><div class='pv-infopanel-controls-navright'><\/div><div class='pv-infopanel-controls-navrightdisabled'><\/div><\/div>");n(".pv-infopanel-controls-navleftdisabled").hide();n(".pv-infopanel-controls-navrightdisabled").hide();i.append("<div class='pv-infopanel-heading'><\/div>");i.append("<div class='pv-infopanel-details'><\/div>");PivotCollection.MaxRelatedLinks>0&&i.append("<div class='pv-infopanel-related'><\/div>");PivotCollection.CopyrightName!=""&&i.append("<div class='pv-infopanel-copyright'><a href=\""+PivotCollection.CopyrightHref+'" target="_blank">'+PivotCollection.CopyrightName+"<\/a><\/div>");i.hide();u=PivotCollection.ImageBase;u.indexOf("http",0)>=0||u.indexOf("www.",0)>=0||(u=PivotCollection.CollectionBase.substring(0,PivotCollection.CollectionBase.lastIndexOf("/")+1)+u);l=n(".pv-viewarea-canvas")[0].getContext("2d");TileController=new PivotViewer.Views.TileController(k);r=TileController.initTiles(PivotCollection.Items,u,l);k.Setup(u.replace("\\","/"))});n.subscribe("/PivotViewer/Settings/Categories/Changed",function(t){var i=PivotCollection.FacetCategories[t.visibleCategories[0]];i.uiInit||InitUIFacet(i);LoadSem.acquire(function(i){var r,u;for(n(".pv-facet").hide(),n(".pv-toolbarpanel-sort option").remove(),r=0;r<t.visibleCategories.length;r++)n(".pv-facet").eq(t.visibleCategories[r]).show(),u=PivotCollection.FacetCategories[t.visibleCategories[r]],n(".pv-toolbarpanel-sort").append("<option value='"+CleanName(u.Name)+"' label='"+u.Name+"'>"+u.Name+"<\/option>");FilterFacets(n(n(".pv-facet")[t.visibleCategories[0]]));n(".pv-filterpanel-accordion").accordion("option","active",parseFloat(t.visibleCategories[0]));n(".pv-filterpanel-accordion").accordion("refresh");n(".pv-toolbarpanel-sort").val(n(n(".pv-toolbarpanel-sort option")[0]).val());i()})});n.subscribe("/PivotViewer/ImageController/Collection/Loaded",function(){for(var g,k,nt,v,ut,d,b,y,w=["<div class='pv-filterpanel-accordion'>"],it=[],rt=0,o=0;o<PivotCollection.FacetCategories.length;o++)(v=PivotCollection.FacetCategories[o],v.IsFilterVisible)&&(rt++,w[o+1]="<h3 class='pv-facet' style='display:inherit'><a href='#' title='"+v.Name+"'>",w[o+1]+=v.Name,w[o+1]+="<\/a><div class='pv-filterpanel-accordion-heading-clear' facetType='"+v.Type+"'>&nbsp;<\/div><\/h3>",w[o+1]+="<div style='display:'inherit' style='height:30%' id='pv-cat-"+CleanName(v.Name)+"'>",w[o+1]+="<\/div>",it[o]="<option value='"+CleanName(v.Name)+"' label='"+v.Name+"'>"+v.Name+"<\/option>");w[w.length]="<\/div>";n(".pv-filterpanel").append(w.join(""));n(".pv-filterpanel-accordion").css("height",n(".pv-filterpanel").height()-n(".pv-filterpanel-search").height()-75+"px");n(".pv-filterpanel-accordion").accordion({icons:!1});n(".pv-toolbarpanel-sortcontrols").append('<select class="pv-toolbarpanel-sort">'+it.join("")+"<\/select>");n(".pv-filterpanel-accordion").accordion("option","active",rt);var ft=n(".pv-viewpanel"),et=a.width(),ot=n(".pv-mainpanel").height(),st=n(".pv-filterpanel").width()+18;for(i.push(new PivotViewer.Views.GridView),i.push(new PivotViewer.Views.BucketView),i.push(new PivotViewer.Views.GraphView),i.push(new PivotViewer.Views.TableView),g=new PivotViewer.Views.MapView2,g.SetOptions(tt),i.push(g),i.push(new PivotViewer.Views.TimeView),o=0;o<i.length;o++)try{i[o]instanceof PivotViewer.Views.IPivotViewerView?(i[o].Setup(et,ot,st,4,TileController.GetMaxTileRatio()),ft.append("<div class='pv-viewpanel-view' id='pv-viewpanel-view-"+o+"'>"+i[o].GetUI()+"<\/div>"),n(".pv-toolbarpanel-viewcontrols").append("<div class='pv-toolbarpanel-view' id='pv-toolbarpanel-view-"+o+"' title='"+i[o].GetViewName()+"'><img id='pv-viewpanel-view-"+o+"-image' src='"+i[o].GetButtonImage()+"' alt='"+i[o].GetViewName()+"' /><\/div>")):(k="",k=k+"View does not inherit from PivotViewer.Views.IPivotViewerView<br>",n(".pv-wrapper").append('<div id="pv-view-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X<\/a><h2>HTML5 PivotViewer<\/h2><p>'+k+"<\/p><\/div><\/div>"),window.open("#pv-view-error","_self"))}catch(ht){alert(ht.Message)}for(n(".pv-loading").remove(),u.Facet==null&&(u.Facet=PivotCollection.FacetCategories[0].Name),n(".pv-toolbarpanel-sort option[value="+CleanName(u.Facet)+"]").prop("selected","selected"),nt=n(".pv-toolbarpanel-sort option").eq(f.visibleCategories[0]).attr("label"),v=PivotCollection.GetFacetCategoryByName(nt),v.uiInit||InitUIFacet(v),LoadSem.acquire(function(t){var i,a,l,s,v,o,e,c,h,y;for(r.sort(tile_sort_by(nt,!1,p)),i=0,a=u.Filters.length;i<a;i++)for(l=!1,s=0,v=u.Filters[i].Predicates.length;s<v;s++)if(o=u.Filters[i].Predicates[s].Operator,o=="GT"||o=="GE"||o=="LT"||o=="LE")if(e=n("#pv-filterpanel-numericslider-"+CleanName(u.Filters[i].Facet)),e.length>0){c=parseFloat(u.Filters[i].Predicates[s].Value);switch(o){case"GT":e.slider("values",0,c+1);break;case"GE":e.slider("values",0,c);break;case"LT":e.slider("values",1,c-1);break;case"LE":e.slider("values",1,c)}e.parent().find(".pv-filterpanel-numericslider-range-val").text(e.slider("values",0)+" - "+e.slider("values",1));e.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible")}else{h=CleanName(u.Filters[i].Facet);y=n("#pv-facet-item-"+h+"___CustomRange")[0].firstElementChild;y.checked=!0;l||(GetCustomDateRange(h),l=!0);switch(o){case"GE":n("#pv-custom-range-"+h+"__StartDate")[0].value=new Date(u.Filters[i].Predicates[s].Value);CustomRangeChanged(n("#pv-custom-range-"+h+"__StartDate")[0]);break;case"LE":n("#pv-custom-range-"+h+"__FinishDate")[0].value=new Date(u.Filters[i].Predicates[s].Value);CustomRangeChanged(n("#pv-custom-range-"+h+"__FinishDate")[0])}}else o=="EQ"?SelectStringFacetItem(CleanName(u.Filters[i].Facet),CleanName(u.Filters[i].Predicates[s].Value)):o=="NT"&&SelectStringFacetItem(CleanName(u.Filters[i].Facet),"_no_info_");FilterCollection();f.visibleCategories.length<PivotCollection.FacetCategories.length&&n.publish("/PivotViewer/Settings/Categories/Changed",[f]);t()}),ut=n(".pv-toolbarpanel").innerWidth()-(n(".pv-toolbarpanel-brandimage").outerWidth(!0)+25+n(".pv-toolbarpanel-name").outerWidth(!0)+30+n(".pv-toolbarpanel-zoomcontrols").outerWidth(!0)+174+n(".pv-toolbarpanel-sortcontrols").outerWidth(!0)),n(".pv-toolbarpanel-facetbreadcrumb").css("width",ut+"px"),d=n(".pv-filterpanel"),d.append("<div class='pv-filterpanel-version'><a href='#pv-open-version'>About<\/a>&nbsp<a href='#pv-open-settings'>Settings<\/a><\/div>"),d.append("<div id='pv-open-version' class='pv-modal-dialog'><div><a href='#pv-modal-dialog-close' title='Close' class='pv-modal-dialog-close'>X<\/a><h2>HTML5 PivotViewer<\/h2><p>Version: "+n(PivotViewer)[0].Version+"<\/p><p>The sources are available on <a href=\"https://github.com/openlink/html5pivotviewer\" target='_blank'>github<\/a><\/p><\/div><\/div>"),d.append("<div id='pv-open-settings' class='pv-modal-dialog modal-xl'><div><a href='#pv-modal-dialog-close' title='Close' class='pv-modal-dialog-close'>X<\/a><h2>Settings<\/h2><div id='pv-options-text'>&nbsp;<\/div><\/div><\/div>"),b="<table><tr><td>All Columns:<\/th><td>Columns to Display:<\/th><tr><td><select id='all-columns' multiple style='width:250px' size=20>",o=0;o<PivotCollection.FacetCategories.length;o++)b+="<option value="+o+" id='"+PivotCollection.FacetCategories[o].Name+"'>"+PivotCollection.FacetCategories[o].Name+"<\/option>";if(b+="<\/select><\/td><td><select id='column-select' multiple style='width:250px' size=20>",f.visibleCategories.length==0)b+="<option value='-1'>Select Categories...<\/option>";else for(o=0;o<f.visibleCategories.length;o++)b+="<option value="+f.visibleCategories[o]+" id='"+PivotCollection.FacetCategories[f.visibleCategories[o]].Name+"'>"+PivotCollection.FacetCategories[f.visibleCategories[o]].Name+"<\/option>";b+="<\/select><\/td><td><input id='column-search' placeholder='Search For Variable...' type='text' size=20><p><button id='select-all'>Select All<\/button><p><button id='deselect-all'>Deselect All<\/button><p><button id='submit'>Submit<\/button><p><button id='cancel'>Cancel<\/button><\/td><\/table>";n("#pv-options-text").html(b);n("#all-columns").dblclick(function(){var r=parseFloat(n("#all-columns").val()),u=PivotCollection.FacetCategories[r],i,t;for(n("#column-select option[value='-1']").length==1&&n("#column-select option[value='-1']").remove(),i=n("#column-select option"),t=0;t<i.length;t++)if(parseFloat(i[t].value)==r)break;else if(parseFloat(i[t].value)>r){n(i[t]).before(n("<option><\/option>").attr("id",u.Name).val(r).html(u.Name));break}t==i.length&&n("#column-select").append("<option value="+r+" id='"+u.Name+"'>"+u.Name+"<\/option>")});n("#column-select").dblclick(function(){var t=parseFloat(n("#column-select").val()),i=PivotCollection.FacetCategories[t];n("#column-select option[value='"+t+"']").remove();n("#column-select option").length==0&&n("#column-select").append("<option value='-1'>Select Categories...<\/option>")});n("#select-all").click(function(){var i,t;for(n("#column-select option").remove(),i=n("#all-columns option"),t=0;t<i.length;t++)n("#column-select").append("<option value="+i[t].value+" id='"+PivotCollection.FacetCategories[parseFloat(i[t].value)].Name+"'>"+PivotCollection.FacetCategories[parseFloat(i[t].value)].Name+"<\/option>")});n("#deselect-all").click(function(){n("#column-select option").remove();n("#column-select").append("<option value='-1'>Select Categories...<\/option>")});n("#submit").click(function(){var e,i,u,o;for(f.visibleCategories=[],e=n("#column-select option"),i=0;i<e.length;i++)f.visibleCategories.push(e[i].value);n.cookie(PivotCollection.CollectionName+"_visible_categories",f.visibleCategories,{expires:365});n.publish("/PivotViewer/Settings/Categories/Changed",[f]);window.open("#pv-modal-dialog-close","_self");u=n(".pv-toolbarpanel-sort option").eq(0).attr("label");o=PivotCollection.GetFacetCategoryByName(u);o.uiInit||InitUIFacet(o);LoadSem.acquire(function(i){r.sort(tile_sort_by(u,!1,p));t=[];for(var f=0;f<r.length;f++)r[f].visible&&t.push(r[f]);n.publish("/PivotViewer/Views/Filtered",[{tiles:r,filter:t,sort:u}]);i()})});n("#cancel").click(function(){window.open("#pv-modal-dialog-close","_self")});n("#column-search").on("keyup",function(t){n("#all-columns option").show();!t.target.value==""&&n("#all-columns option:not([id*='"+t.target.value+"'])").hide();n("#column-select option").show();!t.target.value==""&&n("#column-select option:not([id*='"+t.target.value+"'])").hide()});n(".pv-toolbarpanel-view").on("click",function(){var n=this.id.substring(this.id.lastIndexOf("-")+1,this.id.length);n!=null&&SelectView(parseInt(n))});n(".pv-toolbarpanel-sort").on("change",function(){var i=n(".pv-toolbarpanel-sort option:selected").attr("label"),u=PivotCollection.GetFacetCategoryByName(i);u.uiInit||InitUIFacet(u);LoadSem.acquire(function(u){r.sort(tile_sort_by(i,!1,p));t=[];for(var f=0;f<r.length;f++)r[f].visible&&t.push(r[f]);n.publish("/PivotViewer/Views/Filtered",[{tiles:r,filter:t,sort:i}]);u()})});n(".pv-facet").on("click",function(){FilterFacets(n(this))});n(".pv-filterpanel-clearall").on("click",function(){var r=n(".pv-facet-facetitem:checked"),u,t;for(r.prop("checked",!1),t=0;t<r.length;t++)n(r[t]).attr("itemvalue")=="CustomRange"&&HideCustomDateRange(n(r[t]).attr("itemfacet"));for(u=n(".pv-filterpanel-numericslider"),t=0;t<u.length;t++){var i=n(u[t]),f=i.slider("option","min"),e=i.slider("option","max");i.slider("values",0,f);i.slider("values",1,e);i.prev().prev().html("&nbsp;")}n(".pv-filterpanel-search").val("");n(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden");FilterCollection()});n(".pv-filterpanel-accordion-heading-clear").on("click",function(){var i=this.attributes.facetType.value,r,u;if(i=="DateTime")for(r=n(this.parentElement).next().find(".pv-facet-facetitem:checked"),r.prop("checked",!1),u=0;u<r.length;u++)HideCustomDateRange(n(r[u]).attr("itemfacet"));else if(i=="String")n(this.parentElement).next().find(".pv-facet-facetitem:checked").prop("checked",!1);else if(i=="Number"||i=="Ordinal"){var t=n(this.parentElement).next().find(".pv-filterpanel-numericslider"),f=t.slider("option","min"),e=t.slider("option","max");t.slider("values",0,f);t.slider("values",1,e);t.prev().prev().html("&nbsp;")}FilterCollection();n(this).css("visibility","hidden")});n(".pv-facet-customrange").on("change",function(){CustomRangeChanged(this)});n(".pv-infopanel-details").on("click",".detail-item-value-filter",function(){return n.publish("/PivotViewer/Views/Item/Filtered",[{Facet:n(this).parent().children().attr("pv-detail-item-title"),Item:this.getAttribute("pv-detail-item-value"),Values:null,ClearFacetFilters:!0}]),!1});n(".pv-infopanel-details").on("click",".pv-infopanel-detail-description-more",function(){var t=n(this),i=t.prev();t.text()=="More"?(i.css("height",""),t.text("Less")):(i.css("height","100px"),t.text("More"))});n(".pv-infopanel-controls-navleft").on("click",function(){for(var u,r=1;r<t.length;r++)if(t[r].facetItem.Id==l.facetItem.Id){u=t[r-1];n.publish("/PivotViewer/Views/Item/Selected",[{item:u,bkt:0}]);(e==0||e==1)&&(selectedCol=i[e].GetSelectedCol(u),selectedRow=i[e].GetSelectedRow(u),i[e].CenterOnSelectedTile(selectedCol,selectedRow));break}});n(".pv-infopanel-controls-navright").on("click",function(){for(var u,r=0;r<t.length-1;r++)if(t[r].facetItem.Id==l.facetItem.Id){u=t[r+1];n.publish("/PivotViewer/Views/Item/Selected",[{item:u,bkt:0}]);(e==0||e==1)&&(selectedCol=i[e].GetSelectedCol(u),selectedRow=i[e].GetSelectedRow(u),i[e].CenterOnSelectedTile(selectedCol,selectedRow));break}});n(".pv-filterpanel-search").on("keyup",function(t){var u=[],f=n(".pv-filterpanel-search-autocomplete"),i,e,r;if(f.empty(),t.keyCode==27){n(t.target).blur();return}for(i=0,e=c.length;i<e;i++)r=c[i].value.toLowerCase(),r.indexOf(t.target.value.toLowerCase())>=0&&n.inArray(r,u)==-1&&(u.push(r),f.append('<span facet="'+c[i].facet+'">'+c[i].value+"<\/span>"),t.keyCode==13&&(SelectStringFacetItem(CleanName(c[i].facet),CleanName(c[i].value)),FilterCollection({category:PivotCollection.GetFacetCategoryByName(c[i].facet),enlarge:!1,value:c[i].value})));n(".pv-filterpanel-search-autocomplete > span").on("mousedown",function(t){t.preventDefault();n(".pv-filterpanel-search").val(t.target.textContent);n(".pv-filterpanel-search-autocomplete").hide();SelectStringFacetItem(CleanName(t.target.attributes[0].value),CleanName(t.target.textContent));FilterCollection({category:PivotCollection.GetFacetCategoryByName(c[i].facet),enlarge:!1,value:c[i].value})});u.length>0&&f.show()});n(".pv-filterpanel-search").on("blur",function(t){t.target.value="";n(".pv-filterpanel-search-autocomplete").hide()});y=n(".pv-viewarea-canvas");y.on("mouseup",function(t){var i=n(this).offset(),r=t.clientX-i.left,u=t.clientY-i.top;h&&(h.x!=0||h.y!=0)||n.publish("/PivotViewer/Views/Canvas/Click",[{x:r,y:u}]);s=null;h=!1});y.on("mouseout",function(){s=null;h=!1});y.on("mousedown",function(t){var i=n(this).offset(),r=t.clientX-i.left,u=t.clientY-i.top;s={x:r,y:u}});y.on("mousemove",function(t){var u=n(this).offset(),i=t.clientX-u.left,r=t.clientY-u.top;s==null?n.publish("/PivotViewer/Views/Canvas/Hover",[{x:i,y:r}]):(h={x:i-s.x,y:r-s.y},s={x:i,y:r},n.publish("/PivotViewer/Views/Canvas/Drag",[h]))});y.on("mousewheel",function(t,i){var u=n(this).offset(),f=t.clientX-u.left,e=t.clientY-u.top,r;TileController.SetQuarticEasingOut();TileController.DrawHelpers([{x:f,y:e}]);r=n(".pv-toolbarpanel-zoomslider").slider("option","value");i>0?r=r<5?5:r+5:i<0&&(r=r-5);r=Math.max(0,Math.min(100,r));n(".pv-toolbarpanel-zoomslider").slider("option","value",r)});y.on("touchstart",function(t){var i=t.originalEvent,r=n(this).offset(),u=i.touches[0].pageX-r.left,f=i.touches[0].pageY-r.top;s={x:u,y:f}});y.on("touchmove",function(t){var i,r,l,a;try{if(i=t.originalEvent,t.preventDefault(),i.touches.length>1){t.preventDefault();var u=1e7,f=1e7,e=0,o=0,c=[];for(r=0;r<i.touches.length;r++)c.push({x:i.touches[r].pageX,y:i.touches[r].pageY}),i.touches[r].pageX<u&&(u=i.touches[r].pageX),i.touches[r].pageX>e&&(e=i.touches[r].pageX),i.touches[r].pageY<f&&(f=i.touches[r].pageY),i.touches[r].pageY>o&&(o=i.touches[r].pageY);l=(u+e)/2;a=(f+o)/2;TileController.SetLinearEasingBoth();c.push({x:l,y:a});TileController.DrawHelpers(c);TileController.DrawHelperText("Scale: "+i.scale);n.publish("/PivotViewer/Views/Canvas/Zoom",[{x:l,y:a,scale:i.scale}]);return}var v=n(this).offset(),y=i.touches[0].pageX-v.left,p=i.touches[0].pageY-v.top;h={x:y-s.x,y:p-s.y};s={x:y,y:p};n.publish("/PivotViewer/Views/Canvas/Drag",[h])}catch(w){Debug.Log(w.message)}});y.on("touchend",function(t){var i=t.originalEvent;if(i.touches.length==1&&s==null){var r=n(this).offset(),u=i.touches[0].pageX-r.left,f=i.touches[0].pageY-r.top;h&&(h.x!=0||h.y!=0)||n.publish("/PivotViewer/Views/Canvas/Click",[{x:u,y:f}])}s=null;h=!1;return});LoadSem.acquire(function(n){u.View!=null?SelectView(u.View):SelectView(0);TileController.BeginAnimation();n()})});n.subscribe("/PivotViewer/Views/Item/Selected",function(r){var u,p,y,c,a,k,b,v,o;if(r.item===undefined||r.item==null){DeselectInfoPanel();l!=null&&l.Selected(!1);i[e].SetSelected(null);return}if(u=r.item,u!=null){p=!0;n(".pv-infopanel-heading").empty();n(".pv-infopanel-heading").append('<a href="'+u.facetItem.Href+'" target="_blank">'+u.facetItem.Name+"<\/a><\/div>");y=n(".pv-infopanel-details");y.empty();u.Description!=undefined&&u.Description.length>0&&y.append("<div class='pv-infopanel-detail-description' style='height:100px;'>"+u.Description+"<\/div><div class='pv-infopanel-detail-description-more'>More<\/div>");u.facetItem.Id==t[0].Id?(n(".pv-infopanel-controls-navleft").hide(),n(".pv-infopanel-controls-navleftdisabled").show()):(n(".pv-infopanel-controls-navleft").show(),n(".pv-infopanel-controls-navleftdisabled").hide());u.facetItem.Id==t[t.length-1].Id?(n(".pv-infopanel-controls-navright").hide(),n(".pv-infopanel-controls-navrightdisabled").show()):(n(".pv-infopanel-controls-navright").show(),n(".pv-infopanel-controls-navrightdisabled").hide());var s=[],h=0,w=Loader.GetRow(u.facetItem.Id);for(c=0,o=0;c<w.length;c++){for(a=PivotCollection.GetFacetCategoryByName(w[c].Name);f.visibleCategories[o]<a.index&&o<f.visibleCategories.length;)o++;if(o==f.visibleCategories.length)break;else if(f.visibleCategories[o]>a.index)continue;if(k=(!1).IsFilterVisible=!1,a.IsMetaDataVisible&&(k=!0,IsFilterVisible=!0),k){for(s[h]="<div class='pv-infopanel-detail "+(p?"detail-dark":"detail-light")+"'><div class='pv-infopanel-detail-item detail-item-title' pv-detail-item-title='"+a.Name+"'>"+a.Name+"<\/div>",b=0;b<w[c].FacetValues.length;b++)v=w[c].FacetValues[b],s[h]+="<div pv-detail-item-value='"+v.Value+"' class='pv-infopanel-detail-item detail-item-value"+(IsFilterVisible?" detail-item-value-filter":"")+"'>",s[h]+=v.Href!=null?"<a class='detail-item-link' href='"+v.Href+"'>"+v.Label+"<\/a>":v.Label,s[h]+="<\/div>";s[h]+="<\/div>";h++;p=!p}}if(u.facetItem.Links.length>0)for(n(".pv-infopanel-related").empty(),o=0;o<u.facetItem.Links.length;o++)n(".pv-infopanel-related").append("<a href='"+u.facetItem.Links[o].Href+"'>"+u.facetItem.Links[o].Name+"<\/a><br>");y.append(s.join(""));n(".pv-infopanel").fadeIn();y.css("height",n(".pv-infopanel").height()-(n(".pv-infopanel-controls").height()+n(".pv-infopanel-heading").height()+n(".pv-infopanel-copyright").height()+n(".pv-infopanel-related").height())-20+"px");l!=null&&l.Selected(!1);u.Selected(!0);l=u;_selectedItemBkt=r.bkt;i[e].SetSelected(l)}});n.subscribe("/PivotViewer/Views/Item/Filtered",function(t){if(t!=undefined&&t!=null){var i=PivotCollection.GetFacetCategoryByName(t.Facet);i.uiInit||InitUIFacet(i);LoadSem.acquire(function(r){var e,u,l,h,f;if(i.Type==PivotViewer.Models.FacetType.String)if(t.ClearFacetFilters==!0&&n('.pv-facet-facetitem[itemfacet="'+CleanName(t.Facet)+'"]:checked').prop("checked",!1),t.Values)if(t.Values.length==1)u=n(PivotViewer.Utils.EscapeMetaChars("#pv-facet-item-"+CleanName(t.Facet)+"__"+CleanName(t.Values[0].toString()))+" input"),u.prop("checked",!0),FacetItemClick(u[0]);else{for(e=0;e<t.Values.length;e++)n(PivotViewer.Utils.EscapeMetaChars("#pv-facet-item-"+CleanName(t.Facet)+"__"+CleanName(t.Values[e].toString()))+" input").prop("checked",!0);FilterCollection()}else u=n(PivotViewer.Utils.EscapeMetaChars("#pv-facet-item-"+CleanName(t.Facet)+"__"+CleanName(t.Item.toString()))+" input"),u.prop("checked",!0),FacetItemClick(u[0]);else if(i.Type==PivotViewer.Models.FacetType.Number||i.Type==PivotViewer.Models.FacetType.Ordinal)l=n("#pv-filterpanel-numericslider-"+PivotViewer.Utils.EscapeMetaChars(CleanName(t.Facet))),t.MaxRange==undefined&&(t.MaxRange=t.Item),FacetSliderDrag(l,t.Item,t.MaxRange);else if(i.Type==PivotViewer.Models.FacetType.DateTime){n("#pv-facet-item-"+i.Name+"___CustomRange")[0].firstElementChild.checked=!0;GetCustomDateRange(i.Name);var c=n("#pv-custom-range-"+CleanName(i.Name)+"__StartDate"),a=n("#pv-custom-range-"+CleanName(i.Name)+"__FinishDate"),o=new Date(t.Item),s=new Date(t.MaxRange);for(c[0].value=o.getMonth()+1+"/"+o.getDate()+"/"+o.getFullYear(),a[0].value=s.getMonth()+1+"/"+s.getDate()+"/"+s.getFullYear(),c.datepicker("option","minDate",o),a.datepicker("option","maxDate",s),h=n(c[0].parentElement.parentElement.parentElement.parentElement.children).next().find(".pv-facet-facetitem:checked"),f=0;f<h.length;f++)n(h[f]).attr("itemvalue")!="CustomRange"&&n(h[f]).prop("checked",!1);FilterCollection()}r()})}});FacetItemClick=function(t){var u=PivotCollection.GetFacetCategoryByName(y[n(t).attr("itemfacet")]),f=y[n(t).attr("itemvalue")],i,r;if(n(t).prop("checked")){if(n(t.parentElement.parentElement.parentElement).prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible"),n(t).attr("itemvalue")=="CustomRange"){GetCustomDateRange(n(t).attr("itemfacet"));return}i=n("input[itemfacet|='"+n(t).attr("itemfacet")+"']:checked").length>1;r=!1}else n(t).prop("checked")||(n(t).attr("itemvalue")=="CustomRange"&&HideCustomDateRange(n(t).attr("itemfacet")),n("input[itemfacet|='"+n(t).attr("itemfacet")+"']:checked").length==0?(i=!0,n(t.parentElement.parentElement.parentElement).prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden")):i=!1,r=!0);u.Type==PivotViewer.Models.FacetType.String?FilterCollection({category:u,enlarge:i,clear:r,value:f}):(start=n(t).attr("startdate"),end=n(t).attr("enddate"),FilterCollection({category:u,enlarge:i,clear:r,value:f,min:new Date(start),max:new Date(end)}))};FacetSliderDrag=function(t,i,r){var u=n(t),f=u.slider("option","min"),e=u.slider("option","max");i=="(no info)"&&(i=0);i>f||r<e?(u.parent().find(".pv-filterpanel-numericslider-range-val").text(i+" - "+r),u.slider("values",0,i),u.slider("values",1,r),u.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible")):i==f&&r==e&&u.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden");FilterCollection()};Bucketize=function(n,t,i,r,u){var e,f;n[t]==undefined&&(n[t]=[]);e=n[t];f=e[i+"a"];f!=undefined?(f.items[r+"a"]=r,f.items.push(r),f.start>u?f.start=u:f.end<u&&(f.end=u)):(f=new PivotViewer.Models.DateTimeInfo(i,u,u),f.items[r+"a"]=r,f.items.push(r),e.push(f),e[i+"a"]=f)};CreateDatetimeBuckets=function(n){for(var t,u,s,h,c,l,a,v,d,e=new Date(864e13),o=new Date(-864e13),y=!1,p=!1,w=!1,r=0;r<PivotCollection.Items.length;r++)(u=PivotCollection.Items[r],s=u.FacetByName[n.Name],s!=undefined)&&(t=new Date(s.FacetValues[0].Value),t<e&&(e=t),t>o&&(o=t),t.getHours()!=0&&(y=!0),t.getMinutes()!=0&&(p=!0),t.getSeconds()!=0&&(w=!0));var g=o.getFullYear()-e.getFullYear()+e.getFullYear()%10>9,b=o.getFullYear()>e.getFullYear(),k=b||o.getMonth()>e.getMonth(),nt=k||o.getDate()>e.getDate();for(r=0;r<PivotCollection.Items.length;r++)if(u=PivotCollection.Items[r],s=u.FacetByName[n.Name],s!=undefined){var t=new Date(s.FacetValues[0].Value),i=0,f=t.getFullYear(),tt=f-f%10;g&&(Bucketize(n.datetimeBuckets,i,tt+"s",u.Id,t),n.datetimeBuckets.decade=n.datetimeBuckets[i++]);b&&(Bucketize(n.datetimeBuckets,i,f,u.Id,t),n.datetimeBuckets.year=n.datetimeBuckets[i++]);h=GetMonthName(t);k&&(Bucketize(n.datetimeBuckets,i,h+", "+f,u.Id,t),n.datetimeBuckets.month=n.datetimeBuckets[i++]);c=t.getDate();nt&&(Bucketize(n.datetimeBuckets,i,h+" "+c+", "+f,u.Id,t),n.datetimeBuckets.day=n.datetimeBuckets[i++]);l=GetStandardHour(t);a=GetMeridian(t);y&&(Bucketize(n.datetimeBuckets,i,h+" "+c+", "+f+" "+l+" "+a,u.Id,t),n.datetimeBuckets.hour=n.datetimeBuckets[i++]);v=GetStandardMinutes(t);p&&(Bucketize(n.datetimeBuckets,i,h+" "+c+", "+f+" "+l+":"+v+" "+a,u.Id,t),n.datetimeBuckets.minute=n.datetimeBuckets[i++]);d=GetStandardSeconds(t);w&&(Bucketize(n.datetimeBuckets,i,h+" "+c+", "+f+" "+l+":"+v+":"+d+" "+a,u.Id,t),n.datetimeBuckets.second=n.datetimeBuckets[i])}for(r=0;r<n.datetimeBuckets.length;r++)n.datetimeBuckets[r].sort(function(n,t){return n.start-t.start})};HideCustomDateRange=function(t){n("#pv-custom-range-"+t+"__Start").css("visibility","hidden");n("#pv-custom-range-"+t+"__Finish").css("visibility","hidden");n("#pv-custom-range-"+t+"__StartDate").datepicker("setDate",null);n("#pv-custom-range-"+t+"__FinishDate").datepicker("setDate",null);n("#pv-custom-range-"+t+"__FinishDate").datepicker("option","minDate",null);n("#pv-custom-range-"+t+"__StartDate").datepicker("option","minDate",null);n("#pv-custom-range-"+t+"__FinishDate").datepicker("option","maxDate",null);n("#pv-custom-range-"+t+"__StartDate").datepicker("option","maxDate",null)};GetCustomDateRange=function(t){var o=y[t],i=PivotCollection.GetFacetCategoryByName(o),r,u,f,e;n("#pv-custom-range-"+t+"__Start").css("visibility","visible");n("#pv-custom-range-"+t+"__Finish").css("visibility","visible");n("#pv-custom-range-"+t+"__StartDate").datepicker({showOn:"button",changeMonth:!0,changeYear:!0,buttonText:"Show Date",buttonImageOnly:!0,buttonImage:"http://jqueryui.com/resources/demos/datepicker/images/calendar.gif"});n("#pv-custom-range-"+t+"__FinishDate").datepicker({showOn:"button",changeMonth:!0,changeYear:!0,buttonText:"Show Date",buttonImageOnly:!0,buttonImage:"http://jqueryui.com/resources/demos/datepicker/images/calendar.gif"});i.datetimeBuckets.day.length>0&&(f=i.datetimeBuckets.day[i.datetimeBuckets.day.length-1].start,e=i.datetimeBuckets.day[0].start,n("#pv-custom-range-"+t+"__StartDate").datepicker("option","defaultDate",e),n("#pv-custom-range-"+t+"__FinishDate").datepicker("option","defaultDate",f),i.datetimeBuckets.year.length>0&&(r=i.datetimeBuckets.year[i.datetimeBuckets.year.length-1].name,u=i.datetimeBuckets.year[0].name,n("#pv-custom-range-"+t+"__StartDate").datepicker("option","yearRange",u+":"+r),n("#pv-custom-range-"+t+"__FinishDate").datepicker("option","yearRange",u+":"+r)))};CustomRangeChanged=function(t){var i,r,f,u;if(n(t).attr("itemvalue")=="CustomRangeStart"?(i=n(t)[0].value,r=n("#pv-custom-range-"+n(t).attr("itemfacet")+"__FinishDate")[0].value,r==""&&n("#pv-custom-range-"+n(t).attr("itemfacet")+"__FinishDate").datepicker("option","minDate",new Date(i))):n(t).attr("itemvalue")=="CustomRangeFinish"&&(r=n(t)[0].value,i=n("#pv-custom-range-"+n(t).attr("itemfacet")+"__StartDate")[0].value,i==""&&n("#pv-custom-range-"+n(t).attr("itemfacet")+"__StartDate").datepicker("option","maxDate",new Date(r))),i&&r){for(f=n(t.parentElement.parentElement.parentElement.parentElement.children).next().find(".pv-facet-facetitem:checked"),u=0;u<f.length;u++)n(f[u]).attr("itemvalue")!="CustomRange"&&n(f[u]).prop("checked",!1);FilterCollection()}};n.fn.PivotViewer=function(t){if(d[t])return d[t].apply(this,Array.prototype.slice.call(arguments,1));if(typeof t!="object"&&t)n.error("Method "+t+" does not exist on jQuery.PivotViewer");else return d.init.apply(this,arguments)}})(jQuery);
