var PV=null,PivotCollection=new PivotViewer.Models.Collection,TileController=null,Loader=null,LoadSem=new Semaphore(1),Settings={showMissing:!1,visibleCategories:undefined};(function($){var _views=[],n=[],t=[],i=[],_longStringFacet=null,_longStringCategories=[],r,u;_stringFacets=[];_numericFacets=[];_datetimeFacets=[];_selectedFacets=[];_currentView=0;_currentSort=null;_tiles=[];_filterList=[];_selectedItem=null;_imageController=null;_mouseDrag=null;_mouseMove=null;_self=null;_nameMapping=[];_options={};r={init:function(n){_self=this;_self.addClass("pv-wrapper");_options=n;$.getJSON("defaults.json").always(function(t){for(var r=Object.keys(t),i=0;i<r.length;i++)n[r[i]]==undefined&&n[r[i]]==t[r[i]];if(n.ImageController==undefined)_imageController=new PivotViewer.Views.DeepZoomImageController;else if(n.ImageController instanceof PivotViewer.Views.IImageController)_imageController=n.ImageController;else throw"Image Controller does not inherit from PivotViewer.Views.IImageController.";if(n.Loader==undefined){$(".pv-wrapper").append("<div id='pv-file-selection' class='pv-modal-dialog modal-lg'><div><div id='pv-modal-text'><p>Use Existing Project:<br><select id='pv-server-file' class='pv-server-file'><option>Select a file<\/option><\/select><p>Create New Project:<br><input id='pv-load-file' class='pv-load-file' type=file accept='.csv'><\/div><\/div><\/div>");$pv_server_file=$("#pv-server-file");$.getJSON("../project_list.php",function(n){$.each(n,function(n,t){$pv_server_file.append('<option value="'+t+'">'+t+"<\/option>")})});$pv_server_file.on("change",function(){Loader=$pv_server_file.val().endsWith(".cxml")?new PivotViewer.Models.Loaders.CXMLLoader("projects/"+$pv_server_file.val()):new PivotViewer.Models.Loaders.CSVLoader("projects/"+$pv_server_file.val());initCollectionLoader(n);window.open("#pv-modal-dialog-close","_self")});$(".pv-load-file").on("change",function(){var t=$("#pv-load-file")[0];Loader=new PivotViewer.Models.Loaders.LocalCSVLoader(t.files[0]);initCollectionLoader(n)})}else Loader=n.Loader,initCollectionLoader(n);window.open("#pv-file-selection","_self")}).fail(function(n,t,i){var r=t+", "+i;Debug.log("Getting defaults file failed: "+r)})}};initCollectionLoader=function(){if(PV=this,_self.append("<div class='pv-loading'><img src='images/loading.gif' alt='Loading' /><span>Loading...<\/span><\/div>"),$(".pv-loading").css("top",$(".pv-wrapper").height()/2-33+"px"),$(".pv-loading").css("left",$(".pv-wrapper").width()/2-43+"px"),Loader==undefined)throw"Collection loader is undefined.";if(Loader instanceof PivotViewer.Models.Loaders.ICollectionLoader)Loader.loadCollection(PivotCollection);else throw"Collection loader does not inherit from PivotViewer.Models.Loaders.ICollectionLoader.";};bucketizeDateTimeFacet=function(n,t,i){var u=["<ul class='pv-filterpanel-accordion-facet-list'>"],r,f;if(t)for(r=0;r<t.length;r++)f=r+1,u[f]="<li class='pv-filterpanel-accordion-facet-list-item'  id='pv-facet-item-"+cleanName(n)+"__"+cleanName(t[r].name.toString())+"'>",u[f]+="<input itemvalue='"+cleanName(t[r].name.toString())+"' itemfacet='"+cleanName(n.toString())+"' startdate='"+t[r].start.toISOString()+"' enddate='"+t[r].end.toISOString()+"' class='pv-facet-facetitem' type='checkbox' />",u[f]+="<span class='pv-facet-facetitem-label'>"+t[r].name+"<\/span>",u[f]+="<span class='pv-facet-facetitem-count'>0<\/span>",u[f]+="<\/li>";if(u[t.length+1]="<li class='pv-filterpanel-accordion-facet-list-item'  id='pv-facet-item-LineBreak' style='border-bottom:thin solid #E2E2E2;'><\/li>",u[t.length+2]="<\/ul>",u[t.length+3]="<ul class='pv-filterpanel-accordion-facet-list'>",i)for(r=0;r<i.length;r++)f=r+4+t.length,u[f]="<li class='pv-filterpanel-accordion-facet-list-item'  id='pv-facet-item-"+cleanName(n)+"__"+cleanName(i[r].name.toString())+"'>",u[f]+="<input itemvalue='"+cleanName(i[r].name.toString())+"' itemfacet='"+cleanName(n.toString())+"' startdate='"+i[r].start.toISOString()+"' enddate='"+i[r].end.toISOString()+"' class='pv-facet-facetitem' type='checkbox' />",u[f]+="<span class='pv-facet-facetitem-label'>"+i[r].name+"<\/span>",u[f]+="<span class='pv-facet-facetitem-count'>0<\/span>",u[f]+="<\/li>";return u[t.length+i.length+4]="<li class='pv-filterpanel-accordion-facet-list-item'  id='pv-facet-item-LineBreak2' style='border-bottom:thin solid #E2E2E2;'><\/li>",u[t.length+i.length+5]="<\/ul>",u.join("")};createCustomRange=function(n){var t=["<ul class='pv-filterpanel-accordion-facet-list'>"];return t[1]="<li class='pv-filterpanel-accordion-facet-list-item'  id='pv-facet-item-"+cleanName(n)+"___CustomRange'>",t[1]+="<input itemvalue='CustomRange' itemfacet='"+cleanName(n)+"' class='pv-facet-facetitem' type='checkbox' />",t[1]+="<span class='pv-facet-facetitem-label'>Custom Range<\/span>",t[1]+="<\/li>",t[1]+="<ul class='pv-filterpanel-accordion-facet-list'>",t[1]+="<li class='pv-filterpanel-accordion-facet-list-item' id='pv-custom-range-"+cleanName(n)+"__Start' style='visibility:hidden;float:right'>",t[1]+="<span class='pv-facet-customrange-label'>Start:<\/span>",t[1]+="<input itemvalue='CustomRangeStart' itemfacet='"+cleanName(n)+"' id='pv-custom-range-"+cleanName(n)+"__StartDate' class='pv-facet-customrange' type='text'/>",t[1]+="<\/li>",t[1]+="<li class='pv-filterpanel-accordion-facet-list-item' id='pv-custom-range-"+cleanName(n)+"__Finish' style='visibility:hidden;float:right'>",t[1]+="<span class='pv-facet-customrange-label'>End:<\/span>",t[1]+="<input itemvalue='CustomRangeFinish' itemfacet='"+cleanName(n)+"' id='pv-custom-range-"+cleanName(n)+"__FinishDate' class='pv-facet-customrange' type='text'/>",t[1]+="<\/li>",t[t.length]="<\/ul>",t.join("")};createDatetimeNoInfoFacet=function(t){var u=n[t],r,i;return u==undefined?"":(r=u["(no info)"],i="<ul class='pv-filterpanel-accordion-facet-list'>",r!=undefined&&(i+="<li class='pv-filterpanel-accordion-facet-list-item'  id='"+r.id+"'>",i+="<input itemvalue='"+cleanName(r.value)+"' itemfacet='"+cleanName(t)+"' class='pv-facet-facetitem' type='checkbox' />",i+="<span class='pv-facet-facetitem-label'>"+r.value+"<\/span>",i+="<span class='pv-facet-facetitem-count'>0<\/span>",i+="<\/li>"),i+="<li class='pv-filterpanel-accordion-facet-list-item'  style='border-bottom:thin solid #E2E2E2;'><\/li>",i+"<\/ul>")};createStringFacet=function(t){var i=["<ul class='pv-filterpanel-accordion-facet-list'>"],f=n[t],r=1,e,u;for(e in f.values)u=f.values[e],i[r]="<li class='pv-filterpanel-accordion-facet-list-item'  id='"+u.id+"'>",i[r]+="<input itemvalue='"+cleanName(u.value)+"' itemfacet='"+cleanName(t)+"' class='pv-facet-facetitem' type='checkbox' />",i[r]+="<span class='pv-facet-facetitem-label'>"+u.value+"<\/span>",i[r]+="<span class='pv-facet-facetitem-count'>0<\/span>",i[r++]+="<\/li>";return i[i.length]="<\/ul>",i.join("")};createNumberFacet=function(n,t){createHistogram(n,PivotViewer.Utils.getHistogram(t))};createOrdinalFacet=function(n,t){createHistogram(n,PivotViewer.Utils.getOrdinalHistogram(t))};createHistogram=function(n,t){var s=165,u=80,i=cleanName(n.name),f=$("#pv-filterpanel-category-numberitem-"+PivotViewer.Utils.escapeMetaChars(i)),r,e,l,a,v,o;f.empty();f.append("<span class='pv-filterpanel-numericslider-range-val'>&nbsp;<\/span>");var h="<svg class='pv-filterpanel-accordion-facet-chart' width='"+s+"' height='"+u+"'>",c=.5+s/t.histogram.length|0,y=t.histogram.length>1?Math.max.apply(null,t.histogram):1;for(r=0;r<t.histogram.length;r++)e=.5+u/y*t.histogram[r],l=.5+c*r|0,h+="<rect x='"+l+"' y='"+(u-e)+"' width='"+c+"' height='"+e+"'><\/rect>";f.append(h+"<\/svg>");a=$("#pv-filterpanel-category-numberitem-"+PivotViewer.Utils.escapeMetaChars(i));a.append('<\/span><div id="pv-filterpanel-numericslider-'+i+'" class="pv-filterpanel-numericslider"><\/div><span class="pv-filterpanel-numericslider-range-min">'+t.min+'<\/span><span class="pv-filterpanel-numericslider-range-max">'+t.max+"<\/span>");v=$("#pv-filterpanel-numericslider-"+PivotViewer.Utils.escapeMetaChars(i));o=t.max-t.min;v.slider({range:!0,min:t.min,max:t.max,step:o<10?o/t.histogram.length:1,values:[t.min,t.max],start:function(n,t){this.startMin=t.values[0];this.startMax=t.values[1]},slide:function(n,t){$(this).parent().find(".pv-filterpanel-numericslider-range-val").text(t.values[0]+" - "+t.values[1])},stop:function(t,r){sliderStop($("#pv-filterpanel-numericslider-"+i),n,t,r)}})};sliderStop=function(n,t,i,r){var n=$("#pv-filterpanel-numericslider-"+cleanName(t.name)),u=n.slider("option","min"),f=n.slider("option","max");r.values[0]>u||r.values[1]<f?n.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible"):r.values[0]==u&&r.values[1]==f&&n.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden");filterCollection({category:t,enlarge:n[0].startMin>r.values[0]||n[0].startMax<r.values[1],min:r.values[0],max:r.values[1],rangeMin:u,rangeMax:f})};selectView=function(n){var t,i;if(typeof n=="string"||n instanceof String){for(i=0;i<_views.length;i++)if(_views[i].getViewName().toLowerCase().startsWith(n.toLowerCase())){t=i;break}}else t=n;deselectInfoPanel();$("#pv-viewpanel-view-"+_currentView+"-image").attr("src",_views[_currentView].getButtonImage());_views[_currentView].deactivate();$("#pv-viewpanel-view-"+t+"-image").attr("src",_views[t].getButtonImageSelected());_views[t].activate();_currentView=t;$(".pv-viewpanel-view").hide();$("#pv-viewpanel-view-"+_currentView).show()};sortFacetItems=function(n){var f,e,r,i;if(PivotCollection.getCategoryByName(n).type!=PivotViewer.Models.FacetType.DateTime){var u=$("#pv-cat-"+PivotViewer.Utils.escapeMetaChars(cleanName(n))+" ul"),o=u.prev().text().replace("Sort: ",""),t=u.children("li").get();if(o=="A-Z")t.sort(function(n,t){var i=$(n).children().first().attr("itemvalue"),r=$(t).children().first().attr("itemvalue");return i<r?1:i>r?-1:0});else if(o=="Quantity")t.sort(function(n,t){var i=parseInt($(n).children(".pv-facet-facetitem-count").text()),r=parseInt($(t).children(".pv-facet-facetitem-count").text());return i<r?-1:i>r?1:0});else if(f=PivotCollection.getCategoryByName(n),f.customSort!=undefined){for(e=[],i=f.customSort.sortValues.length-1;i>=0;i--)for(r=0;r<t.length;r++)facet.customSort.sortValues[i]==$(t[r]).children(".pv-facet-facetitem-label").text()&&e.push(t[r]);t=e}for(i=0;i<t.length;i++)u.prepend(t[i])}};filterCollection=function(n){var g,tt,h,f,u,p,at,rt,et,ot,yt,st,e,ht,c,nt,it,o,l,k,s,b,i,r,a,ut,v,w,ft,vt,y,t,d;if(deselectInfoPanel(),_selectedItem=null,g=[],tt=null,n==undefined){if(_longStringFacet!=null){for(at=0,tt=[],t=0,it=_tiles.length;t<it;t++)i=_tiles[t].item.getFacetByName(_longStringFacet.facet),i!=undefined&&i.values[0].value.toLowerCase().indexOf(_longStringFacet.value)>=0?(tt[t]=!0,at++):tt[t]=!1;if(at==0){$("#pv-long-search").css("text-decoration","line-through").css("color","red");return}}for(rt=$(".pv-facet-facetitem:checked"),g=[],h=[],f=[],u=[],p=[],t=0;t<rt.length;t++){var i=_nameMapping[$(rt[t]).attr("itemfacet")],ct=_nameMapping[$(rt[t]).attr("itemvalue")],e=PivotCollection.getCategoryByName(i);e.type==PivotViewer.Models.FacetType.String?(c=h[i],c!=undefined?c.facetValue[ct+"a"]=!0:(c={facet:i,facetValue:[],index:t},c.facetValue[ct+"a"]=!0,h.push(c),h[i]=c,p[i]=!0)):e.type==PivotViewer.Models.FacetType.DateTime&&(et=$("#pv-custom-range-"+cleanName(i)+"__StartDate")[0].value,ot=$("#pv-custom-range-"+cleanName(i)+"__FinishDate")[0].value,et&&ot?nt={facetValue:ct,startDate:new Date(et),endDate:new Date(ot)}:(et=$(rt[t]).attr("startdate"),ot=$(rt[t]).attr("enddate"),nt={facetValue:ct,startDate:new Date(et),endDate:new Date(ot)}),l=f[i],l!=undefined?l.facetValue.push(nt):(l={facet:i,facetValue:[nt]},f.push(l),f[i]=l,p[i]=!0))}for(t=0,it=PivotCollection.categories.length;t<it;t++)if(i=PivotCollection.categories[t].name,(PivotCollection.categories[t].type==PivotViewer.Models.FacetType.Number||PivotCollection.categories[t].type==PivotViewer.Models.FacetType.Ordinal)&&(yt=$("#pv-filterpanel-category-numberitem-"+cleanName(i)),st=$(yt).find(".pv-filterpanel-numericslider"),st.length>0)){var lt=st.slider("values"),pt=st.slider("option","max"),wt=st.slider("option","min");(lt[0]!=wt||lt[1]!=pt)&&(u.push({facet:i,selectedMin:lt[0],selectedMax:lt[1],rangeMin:wt,rangeMax:pt}),u[i]=u[t],p[i]=!0)}}else if(g=[],h=_stringFacets,f=_datetimeFacets,u=_numericFacets,p=_selectedFacets,e=n.category,e.type==PivotViewer.Models.FacetType.Number||e.type==PivotViewer.Models.FacetType.Ordinal)numericFacet=u[e.name],numericFacet==undefined?(numericFacet={facet:e.name,selectedMin:n.min,selectedMax:n.max,rangeMin:n.rangeMin,rangeMax:n.rangeMax},u.push(numericFacet),u[e.name]=numericFacet):(numericFacet.selectedMin=n.min,numericFacet.selectedMax=n.max),p[e.name]=!0;else if(!n.enlarge&&p[e.name]!=undefined||n.clear){if(e.type==PivotViewer.Models.FacetType.String)c=h[e.name],delete c.facetValue[n.value+"a"],c.facetValue.splice(c.facetValue.indexOf(n.value),1),Object.keys(c.facetValue).length==0&&(delete h[e.name],h.splice(c.index,1),delete p[e.name]);else for(l=f[e.name],ht=0;ht<l.facetValue.length;ht++)if(l.facetValue[ht].facetValue==n.value){l.facetValue.splice(ht,1);l.facetValue.length==0&&(delete f[e.name],f.splice(l.index,1),delete p[e.name]);break}}else e.type==PivotViewer.Models.FacetType.String?(c=h[e.name],c!=undefined?(c.facetValue[n.value+"a"]=!0,c.facetValue.push(n.value)):(c={facet:e.name,facetValue:[n.value],index:t},c.facetValue[n.value+"a"]=!0,h.push(c),h[e.name]=c)):(nt={facetValue:n.value,startDate:n.min,endDate:n.max},l=f[e.name],l!=undefined?l.facetValue.push(nt):(l={facet:e.name,facetValue:[nt]},f.push(l),f[e.name]=l)),p[e.name]=!0;for(t=0,it=_tiles.length;t<it;t++){if(o=_tiles[t],n!=undefined&&(!n.enlarge||o.filtered)){if(n.enlarge||o.filtered){if(n.enlarge){g.push(o);continue}}else continue;if(n.category.type==PivotViewer.Models.FacetType.String)if(i=o.item.getFacetByName(n.category.name),i==undefined){if(n.value=="(no info)"==n.clear){o.filtered=!1;continue}}else{for(r=0;r<i.values.length;r++)if(i.values[r].value==n.value!=n.clear)break;if(r==i.values.length){o.filtered=!1;continue}}else if(n.category.type==PivotViewer.Models.FacetType.Number||n.category.type==PivotViewer.Models.FacetType.Ordinal)if(i=o.item.getFacetByName(n.category.name),i==undefined){o.filtered=!1;continue}else{for(r=0,a=i.values.length;r<a;r++)if(k=parseFloat(i.values[r].value),i=u[e.name],!isNaN(k)&&k>=i.selectedMin&&k<=i.selectedMax)break;if(r==a){o.filtered=!1;continue}}else if(i=o.item.getFacetByName(n.category.name),l=f[n.category.name],i==undefined){if(n.value=="(no info)"==n.clear){o.filtered=!1;continue}}else{for(r=0,a=i.values.length;r<a;r++){for(ut=new Date(i.values[r].value),v=0,w=l.facetValue.length;v<w;v++)if(ft=l.facetValue[v],(ut>=ft.startDate&&ut<=ft.endDate)==n.clear)break;if(v==w!=n.clear)break}if(r==a){o.filtered=!1;continue}}g.push(o);continue}if(tt!=null){if(!tt[t]){o.filtered=!1;continue}}else if(_longStringFacet!=null&&(i=_tiles[t].item.getFacetByName(_longStringFacet.facet),i==undefined||i.values[0].value.toLowerCase().indexOf(_longStringFacet.value)<0)){o.filtered=!1;continue}for(s=0,b=h.length;s<b;s++){if(i=o.item.getFacetByName(h[s].facet),i==undefined)if(h[s].facetValue["(no info)a"])continue;else break;for(r=0,a=i.values.length;r<a;r++)if(h[s].facetValue[i.values[r].value+"a"])break;if(r==a)break}if(s<b){o.filtered=!1;continue}for(s=0,b=u.length;s<b;s++){if(i=o.item.getFacetByName(u[s].facet),i==undefined)if(u[s].selectedMin=="(no info)")continue;else break;for(r=0,a=i.values.length;r<a;r++)if(k=parseFloat(i.values[r].value),!isNaN(k)&&k>=u[s].selectedMin&&k<=u[s].selectedMax)break;if(r==a)break}if(s<b){o.filtered=!1;continue}for(s=0,b=f.length;s<b;s++){if(i=o.item.getFacetByName(f[s].facet),i==undefined){for(v=0,w=f[s].facetValue.length;v<w;v++)if(f[s].facetValue[v].facetValue=="(no info)")break;if(v==w)break;else continue}for(r=0,a=i.values.length;r<a;r++){for(ut=new Date(i.values[r].value),v=0,w=f[s].facetValue.length;v<w;v++)if(ft=f[s].facetValue[v],ut>=ft.startDate&&ut<=ft.endDate)break;if(v<w)break}if(r==a)break}if(s<b){o.filtered=!1;continue}o.filtered=!0;g.push(o)}for(_filterList=g,_numericFacets=u,_stringFacets=h,_datetimeFacets=f,_selectedFacets=p,_longStringFacet!=null||_numericFacets.length!=0||_stringFacets.length!=0||_datetimeFacets.length!=0?$(".pv-filterpanel-clearall").css("visibility","visible"):$(".pv-filterpanel-clearall").css("visibility","hidden"),t=0;t<PivotCollection.categories.length;t++)PivotCollection.categories[t].recount=!0;if(filterFacets($(".pv-facet").eq($(".pv-filterpanel-accordion").accordion("option","active"))),$("#pv-toolbarpanel-countbox").html(_filterList.length),vt=$(".pv-toolbarpanel-facetbreadcrumb"),vt.empty(),h.length>0||u.length>0||f.length>0){for(y="|",t=0;t<h.length;t++)y+="<span class='pv-toolbarpanel-facetbreadcrumb-facet'>"+h[t].facet+":<\/span><span class='pv-toolbarpanel-facetbreadcrumb-values'>",y+=h[t].facetValue.join(", "),y+="<\/span><span class='pv-toolbarpanel-facetbreadcrumb-separator'>&gt;<\/span>";for(t=0;t<u.length;t++)y+="<span class='pv-toolbarpanel-facetbreadcrumb-facet'>"+u[t].facet+":<\/span><span class='pv-toolbarpanel-facetbreadcrumb-values'>",y+=u[t].selectedMin==u[t].rangeMin?"Under "+u[t].selectedMax:u[t].selectedMax==u[t].rangeMax?"Over "+u[t].selectedMin:u[t].selectedMin==u[t].selectedMax?u[t].selectedMin:u[t].selectedMin+" - "+u[t].selectedMax,y+="<\/span><span class='pv-toolbarpanel-facetbreadcrumb-separator'>&gt;<\/span>";for(t=0;t<f.length;t++)for(d=0;d<f[t].facetValue.length;d++){if(y+="<span class='pv-toolbarpanel-facetbreadcrumb-facet'>"+f[t].facet+":<\/span><span class='pv-toolbarpanel-facetbreadcrumb-values'>",f[t].facetValue[d].startDate!=undefined&&f[t].facetValue[d].endDate!=undefined){var bt=new Date(f[t].facetValue[d].startDate),kt=new Date(f[t].facetValue[d].endDate),dt=PivotViewer.Utils.getTimeLabelFunction(bt,kt);y+=dt({value:bt})+" - "+dt({value:kt})}else y+=f[t].facetValue[d].facetValue;y+="<\/span><span class='pv-toolbarpanel-facetbreadcrumb-separator'>&gt;<\/span>"}vt.append(y);TileController.setCircularEasingBoth()}$.publish("/PivotViewer/Views/Filtered",[{tiles:_tiles,filterList:_filterList,sort:_currentSort,stringFacets:h}])};initUIFacet=function(r){Loader.loadColumn(r);LoadSem.acquire(function(u){var l=$("#pv-cat-"+cleanName(r.name)),h,a,f,s,c,v,o,e;if(r.type==PivotViewer.Models.FacetType.DateTime){createDatetimeBuckets(r);l.append(bucketizeDateTimeFacet(r.name,r.datetimeBuckets[0],r.datetimeBuckets[1]));l.append(createDatetimeNoInfoFacet(r.name));l.append(createCustomRange(r.name));$("#pv-cat-"+cleanName(r.name)+" .pv-facet-customrange").on("change",function(){customRangeChanged(this)});$("#pv-cat-"+cleanName(r.name)+" .pv-facet-facetitem").click(function(){facetItemClick(this)});$("#pv-cat-"+cleanName(r.name)+" .pv-facet-facetitem-label").click(function(){var n=$(this).prev();n.prop("checked",!n.prop("checked"));facetItemClick(n[0])})}else if(r.type==PivotViewer.Models.FacetType.String){for(h=0;h<PivotCollection.items.length;h++)if(a=PivotCollection.items[h],f=a.getFacetByName(r.name),f!=undefined)for(s=0;s<f.values.length;s++){var c=f.values[s].value,v="pv-facet-item-"+cleanName(f.name)+"__"+cleanName(f.values[s].value),o=n[f.name];o==undefined&&(o=n[f.name]={values:[],facet:f.name,filtered:!0});e=o.values[c];e==undefined?o.values[c]={id:v,value:c,count:1}:e.count++}else v="pv-facet-item-"+cleanName(r.name)+"__"+cleanName("(no info)"),o=n[r.name],o==undefined&&(o=n[r.name]={values:[],facet:r.name,filtered:!0}),e=o.values["(no info)"],e==undefined?o.values["(no info)"]={id:v,value:"(no info)",count:1}:e.count++;l.append("<input class='pv-value-search' id='pv-value-search-"+cleanName(r.name)+"' type='text' placeholder='Search values...' size=15><div class='pv-search-clear' id='pv-value-search-clear-"+cleanName(r.name)+"'>&nbsp;<\/div><br>");r.customSort!=undefined||r.customSort!=null?l.append("<span class='pv-filterpanel-accordion-facet-sort' customSort='"+r.customSort.name+"'>Sort: "+r.customSort.name+"<\/span>"):l.append("<span class='pv-filterpanel-accordion-facet-sort'>Sort: A-Z<\/span>");l.append(createStringFacet(r.name));a=n[r.name];for(c in a.values)e=a.values[c],e.valueItem=$("#"+e.id),e.itemCount=e.valueItem.find("span").last();$("#pv-value-search-"+cleanName(r.name)).on("keyup",function(){var n=cleanName(r.name),i=cleanName(this.value.toLowerCase()),t;i!=""?(t=[],t=$('.pv-filterpanel-accordion-facet-list-item[id^="pv-facet-item-'+n+'"]'),t.hide(),t.filter(function(){return cleanName($(this).children().eq(0).attr("itemvalue").toLowerCase()).indexOf(i)>=0&&$(this).children().eq(2).html()>0}).show(),$("#pv-value-search-clear-"+n).css("visibility","visible")):($('.pv-filterpanel-accordion-facet-list-item[id^="pv-facet-item-'+n+'"]').show(),$("#pv-value-search-clear-"+n).css("visibility","hidden"))});$("#pv-value-search-clear-"+cleanName(r.name)).click(function(){var n=cleanName(r.name);$("#pv-value-search-"+n).val("");$("#pv-value-search-clear-"+n).css("visibility","hidden");$('.pv-filterpanel-accordion-facet-list-item[id^="pv-facet-item-'+n+'"]').show()});$("#pv-cat-"+cleanName(r.name)+" .pv-facet-facetitem").click(function(){facetItemClick(this)});$("#pv-cat-"+cleanName(r.name)+" .pv-facet-facetitem-label").click(function(){var n=$(this).prev();n.prop("checked",!n.prop("checked"));facetItemClick(n[0])});$("#pv-cat-"+cleanName(r.name)+" .pv-filterpanel-accordion-facet-sort").click(function(){var n=$(this),t=n.text(),r=n.parent().prev().children("a").text(),i=n.attr("customSort");t=="Sort: A-Z"?$(this).text("Sort: Quantity"):t=="Sort: Quantity"&&i==undefined?$(this).text("Sort: A-Z"):t=="Sort: Quantity"?$(this).text("Sort: "+i):$(this).text("Sort: A-Z");sortFacetItems(r)})}else if(r.type==PivotViewer.Models.FacetType.Number){for(h=0;h<PivotCollection.items.length;h++)if(a=PivotCollection.items[h],f=a.getFacetByName(r.name),f!=undefined)for(s=0;s<f.values.length;s++)c=f.values[s].value,e=t[f.name],e!=undefined?e.values.push(c):t[f.name]={facet:f.name,values:[c],filtered:!0};else v="pv-facet-item-"+cleanName(r.name)+"__"+cleanName("(no info)"),o=n[r.name],o==undefined&&(o=n[r.name]={values:[],facet:r.name,filtered:!0}),e=o.values["(no info)"],e==undefined?o.values["(no info)"]={id:v,value:"(no info)",count:1}:e.count++;l.append("<div id='pv-filterpanel-category-numberitem-"+cleanName(r.name)+"'><\/div>")}else if(r.type==PivotViewer.Models.FacetType.Ordinal){for(h=0;h<PivotCollection.items.length;h++)if(a=PivotCollection.items[h],f=a.getFacetByName(r.name),f!=undefined)for(s=0;s<f.values.length;s++)c=f.values[s].value,e=i[f.name],e!=undefined?e.values.push(c):i[f.name]={facet:f.name,values:[c],filtered:!0};else v="pv-facet-item-"+cleanName(r.name)+"__"+cleanName("(no info)"),o=n[r.name],o==undefined&&(o=n[r.name]={values:[],facet:r.name,filtered:!0}),e=o.values["(no info)"],e==undefined?o.values["(no info)"]={id:v,value:"(no info)",count:1}:e.count++;l.append("<div id='pv-filterpanel-category-numberitem-"+cleanName(r.name)+"'><\/div>")}r.uiInit=!0;u()})};filterFacets=function(r){var u=PivotCollection.getCategoryByName(r.children().html());u.isFilterVisible&&u.recount&&(u.uiInit||initUIFacet(u),LoadSem.acquire(function(r){var y=[],w,h,k,f,l,e,v,o,b,a,s,c,p;if(_filterList.length*2<_tiles.length)y=_filterList;else for(s=0;s<_tiles.length;s++)_tiles[s].filtered||y.push(_tiles[s]);if(u.type==PivotViewer.Models.FacetType.String){for(h=[],k=PivotViewer.Utils.escapeMetaChars("pv-facet-item-"+cleanName(u.name)+"__"+cleanName("(no info)")),e=0;e<y.length;e++){if(c=y[e].item.getFacetByName(u.name),c==undefined){l=h[k];l!=undefined?l.count++:h[k]={count:1};continue}for(o=0;o<c.values.length;o++)f=PivotViewer.Utils.escapeMetaChars("pv-facet-item-"+cleanName(u.name)+"__"+cleanName(c.values[o].value)),l=h[f],l!=undefined?l.count++:h[f]={count:1}}if(y==_filterList){a=n[u.name].values;for(w in a)f=a[w],h[f.id]==undefined?_selectedFacets[u.name]||f.valueItem.hide():(f.valueItem.show(),f.itemCount.text(h[f.id].count))}else{a=n[u.name].values;for(w in a)f=a[w],b=h[f.id]==undefined?n[u.name].values[w].count:n[u.name].values[w].count-h[f.id].count,b==0?_selectedFacets[u.name]||f.valueItem.hide():(f.valueItem.show(),f.itemCount.text(b))}sortFacetItems(u.name)}else if(u.type==PivotViewer.Models.FacetType.DateTime){for(h=[],k=PivotViewer.Utils.escapeMetaChars("#pv-facet-item-"+cleanName(u.name)+"__"+cleanName("(no info)")),s=0;s<y.length;s++)if(c=y[s].item.getFacetByName(u.name),c==undefined)l=h[k],l!=undefined?l.count++:h[f]={count:1};else for(e=0;e<u.datetimeBuckets.length&&e<2;e++)for(v=u.datetimeBuckets[e],o=0;o<v.length;o++)if(v[o].items[y[s].item.id+"a"]!=undefined){f=PivotViewer.Utils.escapeMetaChars("#pv-facet-item-"+cleanName(u.name)+"__"+cleanName(v[o].name.toString()));l=h[f];l!=undefined?l.count++:h[f]={count:1};break}if(y==_filterList)for(e=0;e<u.datetimeBuckets.length&&e<2;e++)for(v=u.datetimeBuckets[e],o=0;o<v.length;o++)f=PivotViewer.Utils.escapeMetaChars("#pv-facet-item-"+cleanName(u.name)+"__"+cleanName(v[o].name.toString())),h[f]==undefined?_selectedFacets[u.name]||$(f).hide():($(f).show(),$(f).find("span").last().text(h[f].count));else for(e=0;e<u.datetimeBuckets.length&&e<2;e++)for(v=u.datetimeBuckets[e],o=0;o<v.length;o++)f=PivotViewer.Utils.escapeMetaChars("#pv-facet-item-"+cleanName(u.name)+"__"+cleanName(v[o].name.toString())),b=h[f]==undefined?v[o].items.length:v[o].items.length-h[f].count,b==0?_selectedFacets[u.name]||$(f).hide():($(f).show(),$(f).find("span").last().text(b))}else if(u.type==PivotViewer.Models.FacetType.Number){if(!_selectedFacets[u.name])if(_filterList.length==_tiles.length)createNumberFacet(u,t[u.name].values);else{for(a=[],s=0;s<_filterList.length;s++)if(c=_filterList[s].item.getFacetByName(u.name),c!=undefined)for(p=0;p<c.values.length;p++)a.push(c.values[p].value);createNumberFacet(u,a)}}else if(u.type==PivotViewer.Models.FacetType.Ordinal&&!_selectedFacets[u.name])if(_filterList.length==_tiles.length)createOrdinalFacet(u,i[u.name].values);else{for(a=[],s=0;s<_filterList.length;s++)if(c=_filterList[s].item.getFacetByName(u.name),c!=undefined)for(p=0;p<c.values.length;p++)a.push(c.values[p].value);createOrdinalFacet(u,a)}Settings.showMissing?$("#pv-facet-item-"+cleanName(u.name)+"__"+cleanName("(no info)")).show():$("#pv-facet-item-"+cleanName(u.name)+"__"+cleanName("(no info)")).hide();u.recount=!1;r()}))};deselectInfoPanel=function(){$(".pv-infopanel").fadeOut();$(".pv-infopanel-heading").empty();$(".pv-infopanel-details").empty()};cleanName=function(n){return name=n.replace(/[^\w]/gi,"_"),_nameMapping[name]=n,name};$.subscribe("/PivotViewer/Models/Collection/Loaded",function(){var n=Lawnchair({name:PivotCollection.name});n.get("Settings",function(n){var t;if(n!=null)for(Settings=n.value,t=0;t<Settings.visibleCategories.length;t++)Settings.visibleCategories[PivotCollection.categories[Settings.visibleCategories[t]].name]=!0;else for(Settings.showMissing=!1,Settings.visibleCategories=[],t=0;t<PivotCollection.categories.length;t++)Settings.visibleCategories.push(t),Settings.visibleCategories[PivotCollection.categories[t].name]=!0;$.publish("/PivotView/Models/Settings/Loaded")})});$.subscribe("/PivotView/Models/Settings/Loaded",function(){var n="<div class='pv-toolbarpanel'>",f=PivotCollection.brandImage,r,u,t,i,e;f.length>0&&(n+="<img class='pv-toolbarpanel-brandimage' src='"+f+"'><\/img>");n+="<span class='pv-toolbarpanel-name'>"+PivotCollection.name+"<\/span>";n+="<span class='pv-countbox' id='pv-toolbarpanel-countbox' width=25><\/span>";n+="<div class='pv-toolbarpanel-facetbreadcrumb'><\/div>";n+="<div class='pv-toolbarpanel-viewcontrols'><\/div>";n+="<div id='pv-primsortcontrols' class='pv-toolbarpanel-sortcontrols'><\/div>";n+="<div class='pv-toolbarpanel-zoomcontrols'><div class='pv-toolbarpanel-zoomslider'><\/div><\/div>";n+="<div class='pv-toolbarpanel-info'><\/div>";n+="<\/div>";_self.append(n);$("#pv-altsort").hide();$(".pv-toolbarpanel-zoomslider").slider({max:100,stop:function(n,t){zoom(t.value)}});_self.append("<div class='pv-mainpanel'><\/div>");r=$(window).height()-$(".pv-toolbarpanel").height()-30;$(".pv-mainpanel").css("height",r+"px");$(".pv-mainpanel").append("<div class='pv-filterpanel'><\/div>");$(".pv-mainpanel").append("<div class='pv-viewpanel'><canvas class='pv-canvas' width='"+_self.width()+"' height='"+r+"px'><\/canvas><\/div>");$(".pv-mainpanel").append("<div class='pv-infopanel'><\/div>");u=$(".pv-filterpanel");u.append("<div class='pv-filterpanel-clearall'>Clear All<\/div>").append("<input class='pv-filterpanel-search' type='text' placeholder='Search variables...' /><div class='pv-search-clear' id='pv-filterpanel-search-clear'>&nbsp;<\/div>").css("height",r-13+"px");$(".pv-filterpanel-search").css("width",u.width()-15+"px");t=$(".pv-infopanel");t.css("left",$(".pv-mainpanel").offset().left+$(".pv-mainpanel").width()-205+"px").css("height",r-28+"px");t.append("<div class='pv-infopanel-controls'><\/div>");$(".pv-infopanel-controls").append("<div><div class='pv-infopanel-controls-navleft'><\/div><div class='pv-infopanel-controls-navleftdisabled'><\/div><div class='pv-infopanel-controls-navbar'><\/div><div class='pv-infopanel-controls-navright'><\/div><div class='pv-infopanel-controls-navrightdisabled'><\/div><\/div>");$(".pv-infopanel-controls-navleftdisabled").hide();$(".pv-infopanel-controls-navrightdisabled").hide();t.append("<div class='pv-infopanel-heading'><\/div>");t.append("<div class='pv-infopanel-details'><\/div>");PivotCollection.maxRelatedLinks>0&&t.append("<div class='pv-infopanel-related'><\/div>");PivotCollection.copyrightName!=""&&t.append("<div class='pv-infopanel-copyright'><a href=\""+PivotCollection.copyrightHref+'" target="_blank">'+PivotCollection.copyrightName+"<\/a><\/div>");t.hide();i=PivotCollection.imageBase;i.indexOf("http",0)>=0||i.indexOf("www.",0)>=0||(i=PivotCollection.base.substring(0,PivotCollection.base.lastIndexOf("/")+1)+i);e=$(".pv-canvas")[0].getContext("2d");TileController=new PivotViewer.Views.TileController(_imageController);_tiles=TileController.initTiles(PivotCollection.items,i,e);_imageController.setup(i.replace("\\","/"))});$.subscribe("/PivotViewer/Settings/Changed",function(n){var t=PivotCollection.categories[n.visibleCategories[0]];t.uiInit||initUIFacet(t);selectView(0);LoadSem.acquire(function(i){var u=$(".pv-facet"),o=$(".pv-toolbarpanel-sort"),e=$("#pv-long-search-cat"),f,r;for(u.hide(),u.attr("visible","invisible"),$(".pv-toolbarpanel-sort option").remove(),$("#pv-long-search-cat option").remove(),_longStringCategories=[],f=0;f<n.visibleCategories.length;f++)(r=PivotCollection.categories[n.visibleCategories[f]],r.isFilterVisible)&&(r.type==PivotViewer.Models.FacetType.LongString?(e.append("<option value='"+cleanName(r.name.toLowerCase())+"'>"+r.name+"<\/option>"),_longStringCategories.push(r)):(r.recount=!0,u.eq(r.visIndex).show(),u.eq(r.visIndex).attr("visible","visible"),o.append("<option value='"+f+"' search='"+cleanName(r.name.toLowerCase())+"'>"+r.name+"<\/option>")));$("#pv-long-search-cat option").length==0?(e.hide(),$("#pv-long-search").hide()):(e.show(),$("#pv-long-search").show());filterFacets(u.eq(t.visIndex));$(".pv-filterpanel-accordion").accordion("option","active",t.visIndex);$("#pv-primsort").trigger("change");i()})});$.subscribe("/PivotViewer/ImageController/Collection/Loaded",function(){for(var viewName,controlsWidth,filterPanel,html,canvas,category,facets=["<div class='pv-filterpanel-accordion'>"],longSearch=["<div id='pv-long-search-box'><br><select id='pv-long-search-cat'>"],sort=[],activeNumber=0,i=0;i<PivotCollection.categories.length;i++)category=PivotCollection.categories[i],category.isFilterVisible&&(category.type==PivotViewer.Models.FacetType.LongString?(longSearch.push("<option value='"+cleanName(category.name.toLowerCase())+"'>"+category.name+"<\/option>"),_longStringCategories.push(category)):(activeNumber++,facets.push("<h3 class='pv-facet' style='display:inherit' facet='"+cleanName(category.name.toLowerCase())+"'><a href='#' title='"+category.name+"'>"+category.name+"<\/a><div class='pv-filterpanel-accordion-heading-clear' facetType='"+category.type+"'>&nbsp;<\/div><\/h3><div style='display:'inherit' style='height:30%' id='pv-cat-"+cleanName(category.name)+"'><\/div>"),sort.push("<option value='"+i+"' search='"+cleanName(category.name.toLowerCase())+"'>"+category.name+"<\/option>")));if(longSearch.length>1){longSearch.push("<\/div><\/select>");$(".pv-filterpanel").append(longSearch.join("")+"<span class='pv-search-clear' id='pv-long-search-clear'>&nbsp;<\/span><input type=text length=25 id='pv-long-search' placeholder='Search text...'>");$("#pv-long-search").on("keyup",function(n){var i=this.value.toLowerCase(),t;n.keyCode==13?(t=PivotCollection.getCategoryByName([$("#pv-long-search-cat").val()]),t.uiInit||(Loader.loadColumn(t),t.uiInit=!0),LoadSem.acquire(function(n){_longStringFacet=$("#pv-long-search").val()!=null&&$("#pv-long-search").val()!=""?{facet:_nameMapping[$("#pv-long-search-cat").val()],value:$("#pv-long-search").val().toLowerCase()}:null;filterCollection();n()})):$("#pv-long-search").css("text-decoration","").css("color","black");$("#pv-long-search-clear").css("visibility","visible")});$("#pv-long-search-clear").click(function(){$("#pv-long-search").val("");$("#pv-long-search-clear").css("visibility","hidden");_longStringFacet!=null&&(_longStringFacet=null,filterCollection())});$("#pv-long-search-cat").on("mousedown",function(){var i,n,t,r;if($(this).attr("dirty")==1)for($("#pv-long-search-cat option").remove(),i=$(".pv-filterpanel-search").val(),n=0;n<_longStringCategories.length;n++)(t=_longStringCategories[n],r=cleanName(t.name.toLowerCase()),i!=""&&r.indexOf(i)<0)||$("#pv-long-search-cat").append("<option value='"+cleanName(t.name.toLowerCase())+"'>"+t.name+"<\/option>");$(this).attr("dirty",0)})}facets.push("<\/div>");$(".pv-filterpanel").append(facets.join(""));$(".pv-filterpanel-accordion").css("height",$(".pv-filterpanel").height()-$(".pv-filterpanel-search").height()-75-$("#pv-long-search-box").height()+"px");$(".pv-filterpanel-accordion").accordion({icons:!1});$("#pv-primsortcontrols").append('<select id="pv-primsort" class="pv-toolbarpanel-sort">'+sort.join("")+"<\/select>");$(".pv-filterpanel-accordion").accordion("option","active",activeNumber);var viewPanel=$(".pv-viewpanel"),width=_self.width(),height=$(".pv-mainpanel").height(),offsetX=$(".pv-filterpanel").width()+18,offsetY=4;for(PivotCollection.config==undefined&&(PivotCollection.config=[]),PivotCollection.config.views==undefined&&(PivotCollection.config.views=["grid","bucket","crosstab"]),_options.View!=undefined&&PivotCollection.config.views.indexOf(_options.View)<0&&PivotCollection.config.views.push(_options.View),i=0;i<PivotCollection.config.views.length;i++)viewName=PivotCollection.config.views[i],PivotViewer.Utils.loadScript("src/views/"+viewName.toLowerCase()+"view.js"),eval("var view = new PivotViewer.Views."+viewName.charAt(0).toUpperCase()+viewName.substring(1)+"View()"),view.setOptions(_options),_views.push(view);for(i=0;i<_views.length;i++)_views[i]instanceof PivotViewer.Views.IPivotViewerView&&(_views[i].setup(width,height,offsetX,offsetY,TileController.getMaxTileRatio()),viewPanel.append("<div class='pv-viewpanel-view' id='pv-viewpanel-view-"+i+"'>"+_views[i].getUI()+"<\/div>"),$(".pv-toolbarpanel-viewcontrols").append("<div class='pv-toolbarpanel-view' id='pv-toolbarpanel-view-"+i+"' title='"+_views[i].getViewName()+"'><img id='pv-viewpanel-view-"+i+"-image' src='"+_views[i].getButtonImage()+"' alt='"+_views[i].getViewName()+"' /><\/div>"));for($(".pv-loading").remove(),controlsWidth=$(".pv-toolbarpanel").innerWidth()-($(".pv-toolbarpanel-brandimage").outerWidth(!0)+25+$(".pv-toolbarpanel-name").outerWidth(!0)+30+$(".pv-toolbarpanel-zoomcontrols").outerWidth(!0)+_views.length*29+2*$(".pv-toolbarpanel-sortcontrols").outerWidth(!0)),$(".pv-toolbarpanel-facetbreadcrumb").css("width",controlsWidth+"px"),filterPanel=$(".pv-filterpanel"),filterPanel.append("<div class='pv-filterpanel-version'><a href='#pv-open-version'>About<\/a>&nbsp<a href='#pv-open-Settings'>Settings<\/a><\/div>"),filterPanel.append("<div id='pv-open-version' class='pv-modal-dialog'><div><a href='#pv-modal-dialog-close' title='Close' class='pv-modal-dialog-close'>X<\/a><h2>SuAVE: <u>Su<\/u>rvey <u>A<\/u>nalysis <u>V<\/u>isualization and <u>E<\/u>xploration<\/h2><p>This app was designed and developed at the <a href='www.sdsc.edu'>San Diego Supercomputer Center<\/a> for the purpose of enabling innovative visualization of common analytical and statistical techniques with the particular application to education.<p>Project Leads:<br>Ilya Zaslavsky, SDSC (<a href='mailto:zaslavsk@sdsc.edu'>zaslavsk@sdsc.edu<\/a>)<br>Prof. Akos Rona-Tas, UCSD Sociology (<a href='mailto:aronatas@ucsd.edu'>aronatas@ucsd.edu<\/a>)<br>Prof. Kevin Lewis, UCSD Sociology (<a href='mailto:lewis@ucsd.edu'>lewis@ucsd.edu<\/a>)<p>Lead Programmer:<br>Ren&eacute; Patnode, UCSD Sociology (<a href='mailto:rpatnode@ucsd.edu'>rpatnode@ucsd.edu<\/a>)<p>Funded by <a href='http://www.nsf.gov/awardsearch/showAward?AWD_ID=1443082'>NSF Grant ACI-1443082<\/a>.<\/div><\/div>"),filterPanel.append("<div id='pv-open-Settings' class='pv-modal-dialog modal-xl'><div><h2>Settings<\/h2><div id='pv-options-text'>&nbsp;<\/div><\/div><\/div>"),html="<input type='checkbox' id='show-missing'"+(Settings.showMissing?" checked":"")+"> Display missing values<p><h3>Visible Variables (Double-click to select)<\/h3><p>",html+="<table><tr><th>All Variables:<\/th><th>Variables to Display:<\/th><tr><td><select id='pv-all-columns' multiple style='width:250px' size=20>",i=0;i<PivotCollection.categories.length;i++)category=PivotCollection.categories[i],html+="<option value="+i+" search='"+cleanName(category.name.toLowerCase())+"'>"+category.name+"<\/option>";if(html+="<\/select><\/td><td><select id='pv-column-select' multiple style='width:250px' size=20>",Settings.visibleCategories.length==0)html+="<option value='-1'>Select Variables...<\/option>";else for(i=0;i<Settings.visibleCategories.length;i++)category=PivotCollection.categories[Settings.visibleCategories[i]],html+="<option value="+Settings.visibleCategories[i]+" search='"+cleanName(category.name.toLowerCase())+"'>"+category.name+"<\/option>";html+="<\/select><\/td><td width=200><input id='pv-column-search' placeholder='Search For Variable...' type='text' size=20><div class='pv-search-clear' id='pv-column-search-clear'>&nbsp;<\/div><p><button id='pv-column-select-all'>Select All<\/button><p><button id='pv-column-deselect-all'>Deselect All<\/button><p><button id='pv-settings-submit'>Submit<\/button><p><button id='pv-Settings-cancel'>Cancel<\/button><\/td><\/table>";$("#pv-options-text").html(html);$("#pv-all-columns").dblclick(function(){var t,r,i,n;if(!($("#pv-all-columns option[value='-1']").length>0)){for(t=parseFloat($("#pv-all-columns").val()),r=PivotCollection.categories[t],$("#pv-column-select option[value='-1']").length>0&&$("#pv-column-select option[value='-1']").remove(),i=$("#pv-column-select option"),n=0;n<i.length;n++)if(parseFloat(i[n].value)==t)break;else if(parseFloat(i[n].value)>t){$(i[n]).before($("<option><\/option>").attr("search",cleanName(r.name.toLowerCase())).val(t).html(r.name));break}n==i.length&&$("#pv-column-select").append("<option value="+t+" search='"+cleanName(r.name.toLowerCase())+"'>"+r.name+"<\/option>")}});$("#pv-column-select").dblclick(function(){if(!($("#pv-column-select option[value='-1']").length>0)){var n=parseFloat($("#pv-column-select").val()),t=PivotCollection.categories[n];$("#pv-column-select option[value='"+n+"']").remove();$("#pv-column-select option").length==0&&$("#pv-column-select").append("<option value='-1'>Select Variables...<\/option>")}});$("#pv-column-select-all").click(function(){var f=$("#pv-all-columns option"),r=$("#pv-column-select option"),t,n,i,u;if(f.eq(0).val()!=-1)for(r.eq(0).val()==-1&&$("#pv-column-select option").remove(),t=0,n=0;t<f.length;)i=parseFloat(f.eq(t).val()),u=PivotCollection.categories[i],n==r.length?($("#pv-column-select").append($("<option><\/option>").attr("search",cleanName(u.name.toLowerCase())).val(i).html(u.name)),t++):i==parseFloat(r[n].value)?(t++,n++):parseFloat(r[n].value)>i?($(r[n]).before($("<option><\/option>").attr("search",cleanName(u.name.toLowerCase())).val(i).html(u.name)),t++):n++});$("#pv-column-deselect-all").click(function(){$("#pv-column-select option").remove();$("#pv-column-select").append("<option value='-1'>Select Variables...<\/option>")});$("#pv-settings-submit").click(function(){var t,n,r,i;for(Settings.visibleCategories=[],t=$("#pv-column-select option"),n=0;n<t.length;n++)Settings.visibleCategories.push(t[n].value),Settings.visibleCategories[t[n].innerHTML]=!0;Settings.showMissing=$("#show-missing").prop("checked");r=Lawnchair({name:PivotCollection.name});r.save({key:"Settings",value:Settings});$.publish("/PivotViewer/Settings/Changed",[Settings]);window.open("#pv-modal-dialog-close","_self");_currentSort=$("#pv-primsort option").eq(0).html();i=PivotCollection.getCategoryByName(_currentSort);i.uiInit||initUIFacet(i);LoadSem.acquire(function(n){var t,r;for(_tiles.sort(tileSortBy(_currentSort,!1,_stringFacets)),_filterList=[],t=0;t<_tiles.length;t++)r=_tiles[t],r.missing=!Settings.showMissing&&r.item.getFacetByName(i.name)==undefined,r.filtered&&_filterList.push(_tiles[t]);$.publish("/PivotViewer/Views/Filtered",[{tiles:_tiles,filterList:_filterList,sort:_currentSort}]);n()})});$("#pv-Settings-cancel").click(function(){window.open("#pv-modal-dialog-close","_self");$("#show-missing").prop("checked",Settings.showMissing);$("#pv-all-columns option").eq(0).val()==-1&&$("#pv-all-columns option").remove();initAllSelect("#pv-all-columns");$("#pv-column-select option").eq(0).val()==-1&&$("#pv-column-select option").remove();initVisibleSelect("#pv-column-select",!0);$("#pv-column-search").val("");$("#pv-column-search-clear").css("visibility","hidden")});$("#pv-column-search").on("keyup",function(){var n=this.value.toLowerCase();n!=""?($("#pv-all-columns option").eq(0).val()==-1&&$("#pv-all-columns option").remove(),initAllSelect("#pv-all-columns",n),$("#pv-column-search-clear").css("visibility","visible"),$("#pv-all-columns option").length==0&&$("#pv-all-columns").append("<option value='-1' css:'display: block'>No matching variables.<\/option>")):($("#pv-column-search-clear").css("visibility","hidden"),initAllSelect("#pv-all-columns"))});$("#pv-column-search-clear").click(function(){$("#pv-column-search").val("");$("#pv-column-search-clear").css("visibility","hidden");$("#pv-all-columns option").eq(0).val()==-1&&$("#pv-all-columns option").remove();initAllSelect("#pv-all-columns")});$(".pv-toolbarpanel-view").click(function(){var n=this.id.substring(this.id.lastIndexOf("-")+1,this.id.length);n!=null&&selectView(parseInt(n))});$("#pv-primsort").on("change",function(){_currentSort=$("#pv-primsort option:selected").html();var n=PivotCollection.getCategoryByName(_currentSort);n.uiInit||initUIFacet(n);LoadSem.acquire(function(n){var t,i;for(_tiles.sort(tileSortBy(_currentSort,!1,_stringFacets)),_filterList=[],t=0;t<_tiles.length;t++)i=_tiles[t],i.missing=!Settings.showMissing&&i.item.getFacetByName(_currentSort)==undefined,i.filtered&&_filterList.push(_tiles[t]);$.publish("/PivotViewer/Views/Filtered",[{tiles:_tiles,filterList:_filterList,sort:_currentSort}]);n()})});$(".pv-facet").click(function(){filterFacets($(this))});$(".pv-filterpanel-clearall").click(function(){var i=$(".pv-facet-facetitem:checked"),r,n,t;for(i.prop("checked",!1),n=0;n<i.length;n++)i.eq(n).attr("itemvalue")=="CustomRange"&&HideCustomDateRange($(i[n]).attr("itemfacet"));for(r=$(".pv-filterpanel-numericslider"),n=0;n<r.length;n++)t=r.eq(n),t.slider("values",0,t.slider("option","min")),t.slider("values",1,t.slider("option","max")),t.prev().prev().html("&nbsp;");$(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden");$("#pv-long-search-clear").css("visibility","hidden");$("#pv-long-search").val("");_longStringFacet=null;filterCollection()});$(".pv-filterpanel-accordion-heading-clear").click(function(){var t=this.attributes.facetType.value,i,r,n;if(t=="DateTime")for(i=$(this).parent().next().find(".pv-facet-facetitem:checked"),i.prop("checked",!1),r=0;r<i.length;r++)HideCustomDateRange($(i[r]).attr("itemfacet"));else t=="String"?$(this).parent().next().find(".pv-facet-facetitem:checked").prop("checked",!1):(t=="Number"||t=="Ordinal")&&(n=$(this).parent().next().find(".pv-filterpanel-numericslider"),n.slider("values",0,n.slider("option","min")),n.slider("values",1,n.slider("option","max")),n.prev().prev().html("&nbsp;"));filterCollection();$(this).css("visibility","hidden")});$(".pv-facet-customrange").on("change",function(){customRangeChanged(this)});$(".pv-infopanel-details").on("click",".detail-item-value-filter",function(){return $.publish("/PivotViewer/Views/Item/Filtered",[{Facet:$(this).parent().children().attr("pv-detail-item-title"),Item:this.getAttribute("pv-detail-item-value"),Values:null}]),!1});$(".pv-infopanel-details").on("click",".pv-infopanel-detail-description-more",function(){var n=$(this),t=n.prev();n.text()=="More"?(t.css("height",""),n.text("Less")):(t.css("height","100px"),n.text("More"))});$(".pv-infopanel-controls-navleft").click(function(){for(var t,n=1;n<_filterList.length;n++)if(_filterList[n].item.id==_selectedItem.item.id){t=_filterList[n-1];$.publish("/PivotViewer/Views/Item/Selected",[{item:t}]);_views[_currentView].centerOnTile(t);break}});$(".pv-infopanel-controls-navright").click(function(){for(var t,n=0;n<_filterList.length-1;n++)if(_filterList[n].item.id==_selectedItem.item.id){t=_filterList[n+1];$.publish("/PivotViewer/Views/Item/Selected",[{item:t,bkt:0}]);_views[_currentView].centerOnTile(t);break}});$(".pv-toolbarpanel-sort").on("mousedown",function(){$(this).attr("dirty")==1&&initVisibleSelect("#"+$(this).attr("id"),!1,cleanName($(".pv-filterpanel-search").val().toLowerCase()));$(this).attr("dirty",0)});$(".pv-value-search").on("keyup",function(){var i=cleanName(this.value.toLowerCase()),t,n;i!=""?(t=PivotCollection.getCategoryByName(_nameMapping[$(".pv-facet").eq($(".pv-filterpanel-accordion").accordion("option","active")).attr("facet")]),n=[],t.type==PivotViewer.Models.FacetType.String&&t.name.toLowerCase().indexOf(i)==-1&&(n=$('.pv-filterpanel-accordion-facet-list-item[id^="pv-facet-item-'+cleanName(t.name)+'"]'),n.hide(),n=n.filter(function(){return cleanName($(this).children().eq(0).attr("itemvalue").toLowerCase()).indexOf(i)>=0&&$(this).children().eq(2).html()>0}),n.show())):$(".pv-filterpanel-accordion-facet-list-item").show()});$("#pv-value-search-clear").click(function(){$(".pv-value-search").val("");$("#pv-value-search-clear").css("visibility","hidden");$(".pv-filterpanel-accordion").accordion("option","collapsible",!1);$(".pv-filterpanel-accordion-facet-list-item").show()});$(".pv-filterpanel-search").on("keyup",function(){var t=cleanName(this.value.toLowerCase()),n,i;t!=""?(n=$(".pv-facet[facet*='"+t+"'][visible='visible']"),n.show(),$(".pv-toolbarpanel-sort").attr("dirty",1),$("#pv-long-search-cat").attr("dirty",1),$("#pv-long-search-cat").val($("#pv-long-search-cat option[value*='"+t+"']").eq(0).val()),$(".pv-facet:not([facet*='"+t+"'][visible='visible'])").hide(),$("#pv-filterpanel-search-clear").css("visibility","visible"),n.length>0?(i=PivotCollection.getCategoryByName(_nameMapping[n.eq(0).attr("facet")]),i.uiInit||initUIFacet(i),LoadSem.acquire(function(t){$(".pv-filterpanel-accordion").accordion("option","collapsible",!1);$(".pv-filterpanel-accordion").accordion("option","active",i.visIndex);filterFacets(n.eq(0));t()})):($(".pv-filterpanel-accordion").accordion("option","collapsible",!0),$(".pv-filterpanel-accordion").accordion("option","active",!1))):($(".pv-facet[visible='visible']").show(),$(".pv-toolbarpanel-sort").attr("dirty",1),$("#pv-long-search-cat").attr("dirty",1),$(".pv-filterpanel-accordion").accordion("option","collapsible",!1),$("#pv-filterpanel-search-clear").css("visibility","hidden"))});$("#pv-filterpanel-search-clear").click(function(){$(".pv-filterpanel-search").val("");$(".pv-toolbarpanel-sort").attr("dirty",1);$("#pv-long-search-cat").attr("dirty",1);$("#pv-filterpanel-search-clear").css("visibility","hidden");$(".pv-filterpanel-accordion").accordion("option","collapsible",!1);$(".pv-facet[visible='visible']").show()});canvas=$(".pv-canvas");canvas.on("mouseup",function(n){var t=$(this).offset(),i=n.clientX-t.left,r=n.clientY-t.top;_mouseMove&&(_mouseMove.x!=0||_mouseMove.y!=0)||$.publish("/PivotViewer/Views/Canvas/Click",[{x:i,y:r}]);_mouseDrag=null;_mouseMove=!1});canvas.on("mouseout",function(){_mouseDrag=null;_mouseMove=!1});canvas.on("mousedown",function(n){var t=$(this).offset(),i=n.clientX-t.left,r=n.clientY-t.top;_mouseDrag={x:i,y:r}});canvas.on("mousemove",function(n){var r=$(this).offset(),t=n.clientX-r.left,i=n.clientY-r.top;_mouseDrag==null?$.publish("/PivotViewer/Views/Canvas/Hover",[{x:t,y:i}]):(_mouseMove={x:t-_mouseDrag.x,y:i-_mouseDrag.y},_mouseDrag={x:t,y:i},$.publish("/PivotViewer/Views/Canvas/Drag",[_mouseMove]))});canvas.on("mousewheel",function(n,t){var r=$(this).offset(),u=n.clientX-r.left,f=n.clientY-r.top,i;TileController.setQuarticEasingOut();i=$(".pv-toolbarpanel-zoomslider").slider("option","value");t>0?i=i<5?5:i+5:t<0&&(i=i-5);i=Math.max(0,Math.min(100,i));zoom(i,u,f)});canvas.on("touchstart",function(n){var t=n.originalEvent,i=$(this).offset(),r=t.touches[0].pageX-i.left,u=t.touches[0].pageY-i.top;_mouseDrag={x:r,y:u}});canvas.on("touchmove",function(n){var t,i,o,s;try{if(t=n.originalEvent,n.preventDefault(),t.touches.length>1){n.preventDefault();var r=1e7,u=1e7,f=0,e=0;for(i=0;i<t.touches.length;i++)t.touches[i].pageX<r&&(r=t.touches[i].pageX),t.touches[i].pageX>f&&(f=t.touches[i].pageX),t.touches[i].pageY<u&&(u=t.touches[i].pageY),t.touches[i].pageY>e&&(e=t.touches[i].pageY);o=(r+f)/2;s=(u+e)/2;TileController.setLinearEasingBoth();$.publish("/PivotViewer/Views/Canvas/Zoom",[{x:o,y:s,scale:t.scale}]);return}var h=$(this).offset(),c=t.touches[0].pageX-h.left,l=t.touches[0].pageY-h.top;_mouseMove={x:c-_mouseDrag.x,y:l-_mouseDrag.y};_mouseDrag={x:c,y:l};$.publish("/PivotViewer/Views/Canvas/Drag",[_mouseMove])}catch(a){Debug.log(a.message)}});canvas.on("touchend",function(n){var t=n.originalEvent;if(t.touches.length==1&&_mouseDrag==null){var i=$(this).offset(),r=t.touches[0].pageX-i.left,u=t.touches[0].pageY-i.top;_mouseMove&&(_mouseMove.x!=0||_mouseMove.y!=0)||$.publish("/PivotViewer/Views/Canvas/Click",[{x:r,y:u}])}_mouseDrag=null;_mouseMove=!1;return});_currentSort=$("#pv-primsort option").eq(0).html();category=PivotCollection.getCategoryByName(_currentSort);category.uiInit||initUIFacet(category);LoadSem.acquire(function(n){var t,i;for(_tiles.sort(tileSortBy(_currentSort,!1,_stringFacets)),t=0;t<_tiles.length;t++)i=_tiles[t],i.missing=!Settings.showMissing&&i.item.getFacetByName(_currentSort)==undefined;filterCollection();Settings.visibleCategories.length<PivotCollection.categories.length?$.publish("/PivotViewer/Settings/Changed",[Settings]):$(".pv-facet").attr("visible","visible");_options.View!=undefined?selectView(_options.View):selectView(0);TileController.beginAnimation();n()})});u=0;zoom=function(n,t,i){t==undefined&&(t=$(".pv-canvas").width()/2);i==undefined&&(i=$(".pv-canvas").height()/2);$(".pv-toolbarpanel-zoomslider").slider("option","value",n);$.publish("/PivotViewer/Views/Canvas/Zoom",[{x:t,y:i,delta:.5*(n-u)}]);u=n};initAllSelect=function(n,t){var r,i,e,u,f;for(t==undefined&&(t=""),r=$(n),i=0;i<r.length;i++){for(e=r.eq(i).val(),r.eq(i).children().remove(),u=0;u<PivotCollection.categories.length;u++)f=PivotCollection.categories[u],(u==e||f.name.toLowerCase().indexOf(t)!=-1)&&r.eq(i).append("<option value="+u+" search='"+cleanName(f.name.toLowerCase())+"'>"+f.name+"<\/option>");r.eq(i).val(e)}};initVisibleSelect=function(n,t,i){var u,r,o,e,s,f;for(i==undefined&&(i=""),t==undefined&&(t=!1),u=$(n),r=0;r<u.length;r++){for(o=u.eq(r).val(),u.eq(r).children().remove(),e=0;e<Settings.visibleCategories.length;e++)s=Settings.visibleCategories[e],f=PivotCollection.categories[s],(f.isFilterVisible&&f.type!=PivotViewer.Models.FacetType.LongString||t)&&(s==o||cleanName(f.name).toLowerCase().indexOf(i)!=-1)&&u.eq(r).append("<option value="+Settings.visibleCategories[e]+" search='"+cleanName(f.name.toLowerCase())+"'>"+f.name+"<\/option>");u.eq(r).val(o)}};$.subscribe("/PivotViewer/Views/Item/Selected",function(n){var t,h,o,f,s,l,i,e;if(n.item===undefined||n.item==null){deselectInfoPanel();_selectedItem!=null&&_selectedItem.Selected(!1);_views[_currentView].setSelected(null);return}if(t=n.item,t!=null){h=!0;$(".pv-infopanel-heading").empty();$(".pv-infopanel-heading").append('<a href="'+t.item.href+'" target="_blank">'+t.item.name+"<\/a><\/div>");o=$(".pv-infopanel-details");o.empty();t.item.description!=undefined&&t.item.description.length>0&&o.append("<div class='pv-infopanel-detail-description' style='height:100px;'>"+t.item.description+"<\/div><div class='pv-infopanel-detail-description-more'>More<\/div>");t.item.id==_filterList[0].id?($(".pv-infopanel-controls-navleft").hide(),$(".pv-infopanel-controls-navleftdisabled").show()):($(".pv-infopanel-controls-navleft").show(),$(".pv-infopanel-controls-navleftdisabled").hide());t.item.id==_filterList[_filterList.length-1].id?($(".pv-infopanel-controls-navright").hide(),$(".pv-infopanel-controls-navrightdisabled").show()):($(".pv-infopanel-controls-navright").show(),$(".pv-infopanel-controls-navrightdisabled").hide());var r=[],u=0,c=Loader.getRow(t.item.id);for(f=0,e=0;f<c.length;f++)if(s=PivotCollection.getCategoryByName(c[f].name),Settings.visibleCategories[s.name]){for(r[u]="<div class='pv-infopanel-detail "+(h?"detail-dark":"detail-light")+"'><div class='pv-infopanel-detail-item detail-item-title' pv-detail-item-title='"+s.name+"'>"+s.name+"<\/div>",l=0;l<c[f].values.length;l++)i=c[f].values[l],r[u]+="<div pv-detail-item-value='"+i.value+"' class='pv-infopanel-detail-item detail-item-value"+(s.isFilterVisible?" detail-item-value-filter":"")+"'>",r[u]+=i.href!=null&&i.href!=""?"<a class='detail-item-link' href='"+i.href+"'>"+i.label+"<\/a>":i.label,r[u]+="<\/div>";r[u]+="<\/div>";u++;h=!h}if(t.item.links.length>0)for($(".pv-infopanel-related").empty(),e=0;e<t.item.links.length;e++)$(".pv-infopanel-related").append("<a href='"+t.item.links[e].href+"'>"+t.item.links[e].name+"<\/a><br>");o.append(r.join(""));$(".pv-infopanel").fadeIn();o.css("height",$(".pv-infopanel").height()-($(".pv-infopanel-controls").height()+$(".pv-infopanel-heading").height()+$(".pv-infopanel-copyright").height()+$(".pv-infopanel-related").height())-20+"px");_selectedItem!=null&&_selectedItem.Selected(!1);t.Selected(!0);_selectedItem=t;_views[_currentView].setSelected(_selectedItem)}});$.subscribe("/PivotViewer/Views/Item/Filtered",function(n){var f,e,r,u;if(n!=undefined&&n!=null){for(f=[],n.length!=undefined?f=n:f.push(n),e=0;e<f.length;e++)r=f[e],u=PivotCollection.getCategoryByName(r.Facet),u.uiInit||(initUIFacet(u),u.type==PivotViewer.Models.FacetType.Number?createNumberFacet(u,t[u.name].values):u.type==PivotViewer.Models.FacetType.Ordinal&&createOrdinalFacet(u,i[u.name].values)),LoadSem.acquire(function(n){var i,l,e,o,t;if(u.type==PivotViewer.Models.FacetType.String)if($('.pv-facet-facetitem[itemfacet="'+PV.cleanName(r.Facet)+'"]:checked').prop("checked",!1),r.values)if(r.values.length==1)i=$(PivotViewer.Utils.escapeMetaChars("#pv-facet-item-"+PV.cleanName(r.Facet)+"__"+PV.cleanName(r.values[0].toString()))+" input"),i.prop("checked",!0),f.length==1&&facetItemClick(i[0]);else{for(t=0;t<r.values.length;t++)$(PivotViewer.Utils.escapeMetaChars("#pv-facet-item-"+PV.cleanName(r.Facet)+"__"+PV.cleanName(r.values[t].toString()))+" input").prop("checked",!0);$(PivotViewer.Utils.escapeMetaChars("#pv-facet-item-"+PV.cleanName(r.Facet)+"__"+PV.cleanName(r.values[0].toString()))+" input").parent().parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible");f.length==1&&filterCollection()}else i=$(PivotViewer.Utils.escapeMetaChars("#pv-facet-item-"+PV.cleanName(r.Facet)+"__"+PV.cleanName(r.Item.toString()))+" input"),i.prop("checked",!0),f.length==1&&facetItemClick(i[0]);else if(u.type==PivotViewer.Models.FacetType.Number||u.type==PivotViewer.Models.FacetType.Ordinal)l=$("#pv-filterpanel-numericslider-"+PivotViewer.Utils.escapeMetaChars(PV.cleanName(r.Facet))),r.MaxRange==undefined&&(r.MaxRange=r.Item),facetSliderDrag(l,r.Item,r.MaxRange,f.length==1);else if(u.type==PivotViewer.Models.FacetType.DateTime){e=PV.cleanName(u.name);$("#pv-facet-item-"+e+"___CustomRange")[0].firstElementChild.checked=!0;getCustomDateRange(e);var c=$("#pv-custom-range-"+e+"__StartDate"),a=$("#pv-custom-range-"+e+"__FinishDate"),s=new Date(r.Item),h=new Date(r.MaxRange);for(c[0].value=s.getMonth()+1+"/"+s.getDate()+"/"+s.getFullYear(),a[0].value=h.getMonth()+1+"/"+h.getDate()+"/"+h.getFullYear(),c.datepicker("option","minDate",s),a.datepicker("option","maxDate",h),o=$(c).parent().parent().parent().parent().children().next().find(".pv-facet-facetitem:checked"),t=0;t<o.length;t++)$(o).eq(t).attr("itemvalue")!="CustomRange"&&$(o).eq(t).prop("checked",!1);$(o).parent().parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible");f.length==1&&filterCollection()}n()});f.length>1&&filterCollection()}});facetItemClick=function(n){var r=PivotCollection.getCategoryByName(_nameMapping[$(n).attr("itemfacet")]),u=_nameMapping[$(n).attr("itemvalue")],t,i;if($(n).prop("checked")){if($(n).parent().parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible"),$(n).attr("itemvalue")=="CustomRange"){getCustomDateRange($(n).attr("itemfacet"));return}t=$("input[itemfacet|='"+$(n).attr("itemfacet")+"']:checked").length>1;i=!1}else $(n).prop("checked")||($(n).attr("itemvalue")=="CustomRange"&&HideCustomDateRange($(n).attr("itemfacet")),$("input[itemfacet|='"+$(n).attr("itemfacet")+"']:checked").length==0?(t=!0,$(n).parent().parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden")):t=!1,i=!0);r.type==PivotViewer.Models.FacetType.String?filterCollection({category:r,enlarge:t,clear:i,value:u}):(start=$(n).attr("startdate"),end=$(n).attr("enddate"),filterCollection({category:r,enlarge:t,clear:i,value:u,min:new Date(start),max:new Date(end)}))};facetSliderDrag=function(n,t,i,r){var u=$(n),f=u.slider("option","min"),e=u.slider("option","max");t=="(no info)"&&(t=0);t>f||i<e?(u.parent().find(".pv-filterpanel-numericslider-range-val").text(t+" - "+i),u.slider("values",0,t),u.slider("values",1,i),u.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible")):t==f&&i==e&&u.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden");r!=!1&&filterCollection()};bucketize=function(n,t,i,r,u){n[t]==undefined&&(n[t]=[]);var e=n[t],f=e[i+"a"];f!=undefined?(f.items[r+"a"]=r,f.items.push(r),f.start>u?f.start=u:f.end<u&&(f.end=u)):(f=new PivotViewer.Models.DateTimeInfo(i,u,u),f.items[r+"a"]=r,f.items.push(r),e.push(f),e[i+"a"]=f)};createDatetimeBuckets=function(n){for(var t,u,s,h,c,l,a,k,nt,i,e=new Date(864e13),o=new Date(-864e13),v=!1,y=!1,p=!1,r=0;r<PivotCollection.items.length;r++)(u=PivotCollection.items[r],s=u.getFacetByName(n.name),s!=undefined)&&(t=new Date(s.values[0].value),t<e&&(e=t),t>o&&(o=t),t.getHours()!=0&&(v=!0),t.getMinutes()!=0&&(y=!0),t.getSeconds()!=0&&(p=!0));var d=o.getFullYear()-e.getFullYear()+e.getFullYear()%10>9,w=o.getFullYear()>e.getFullYear(),b=w||o.getMonth()>e.getMonth(),g=b||o.getDate()>e.getDate();for(r=0;r<PivotCollection.items.length;r++)if(u=PivotCollection.items[r],s=u.getFacetByName(n.name),s!=undefined){var t=new Date(s.values[0].value),i=0,f=t.getFullYear(),tt=f-f%10;d&&bucketize(n.datetimeBuckets,i++,tt+"s",u.id,t);w&&bucketize(n.datetimeBuckets,i++,f,u.id,t);h=PivotViewer.Utils.getMonthName(t);b&&bucketize(n.datetimeBuckets,i++,h+", "+f,u.id,t);c=t.getDate();g&&bucketize(n.datetimeBuckets,i++,h+" "+c+", "+f,u.id,t);l=PivotViewer.Utils.getHour(t);a=PivotViewer.Utils.getMeridian(t);v&&bucketize(n.datetimeBuckets,i++,h+" "+c+", "+f+" "+l+" "+a,u.id,t);k=PivotViewer.Utils.getMinutes(t);y&&bucketize(n.datetimeBuckets,i++,h+" "+c+", "+f+" "+l+":"+k+" "+a,u.id,t);nt=PivotViewer.Utils.getSeconds(t);p&&bucketize(n.datetimeBuckets,i,h+" "+c+", "+f+" "+l+":"+k+":"+nt+" "+a,u.id,t)}for(r=0;r<n.datetimeBuckets.length;r++)n.datetimeBuckets[r].sort(function(n,t){return n.start-t.start});i=0;d&&(n.datetimeBuckets.decade=n.datetimeBuckets[i++]);w&&(n.datetimeBuckets.year=n.datetimeBuckets[i++]);b&&(n.datetimeBuckets.month=n.datetimeBuckets[i++]);g&&(n.datetimeBuckets.day=n.datetimeBuckets[i++]);v&&(n.datetimeBuckets.hour=n.datetimeBuckets[i++]);y&&(n.datetimeBuckets.minute=n.datetimeBuckets[i++]);p&&(n.datetimeBuckets.second=n.datetimeBuckets[i])};HideCustomDateRange=function(n){$("#pv-custom-range-"+n+"__Start").css("visibility","hidden");$("#pv-custom-range-"+n+"__Finish").css("visibility","hidden");$("#pv-custom-range-"+n+"__StartDate").datepicker("setDate",null);$("#pv-custom-range-"+n+"__FinishDate").datepicker("setDate",null);$("#pv-custom-range-"+n+"__FinishDate").datepicker("option","minDate",null);$("#pv-custom-range-"+n+"__StartDate").datepicker("option","minDate",null);$("#pv-custom-range-"+n+"__FinishDate").datepicker("option","maxDate",null);$("#pv-custom-range-"+n+"__StartDate").datepicker("option","maxDate",null)};getCustomDateRange=function(n){var e=_nameMapping[n],t=PivotCollection.getCategoryByName(e),i,r,u,f;$("#pv-custom-range-"+n+"__Start").css("visibility","visible");$("#pv-custom-range-"+n+"__Finish").css("visibility","visible");$("#pv-custom-range-"+n+"__StartDate").datepicker({showOn:"button",changeMonth:!0,changeYear:!0,buttonText:"Show Date",buttonImageOnly:!0,buttonImage:"http://jqueryui.com/resources/demos/datepicker/images/calendar.gif"});$("#pv-custom-range-"+n+"__FinishDate").datepicker({showOn:"button",changeMonth:!0,changeYear:!0,buttonText:"Show Date",buttonImageOnly:!0,buttonImage:"http://jqueryui.com/resources/demos/datepicker/images/calendar.gif"});t.datetimeBuckets.day.length>0&&(u=t.datetimeBuckets.day[t.datetimeBuckets.day.length-1].start,f=t.datetimeBuckets.day[0].start,$("#pv-custom-range-"+n+"__StartDate").datepicker("option","defaultDate",f),$("#pv-custom-range-"+n+"__FinishDate").datepicker("option","defaultDate",u),t.datetimeBuckets.year.length>0&&(i=t.datetimeBuckets.year[t.datetimeBuckets.year.length-1].name,r=t.datetimeBuckets.year[0].name,$("#pv-custom-range-"+n+"__StartDate").datepicker("option","yearRange",r+":"+i),$("#pv-custom-range-"+n+"__FinishDate").datepicker("option","yearRange",r+":"+i)))};customRangeChanged=function(n){var t,i,u,r;if($(n).attr("itemvalue")=="CustomRangeStart"?(t=$(n)[0].value,i=$("#pv-custom-range-"+$(n).attr("itemfacet")+"__FinishDate")[0].value,i==""&&$("#pv-custom-range-"+$(n).attr("itemfacet")+"__FinishDate").datepicker("option","minDate",new Date(t))):$(n).attr("itemvalue")=="CustomRangeFinish"&&(i=$(n)[0].value,t=$("#pv-custom-range-"+$(n).attr("itemfacet")+"__StartDate")[0].value,t==""&&$("#pv-custom-range-"+$(n).attr("itemfacet")+"__StartDate").datepicker("option","maxDate",new Date(i))),t&&i){for(u=$(n).parent().parent().parent().parent().children().next().find(".pv-facet-facetitem:checked"),r=0;r<u.length;r++)$(u[r]).attr("itemvalue")!="CustomRange"&&$(u[r]).prop("checked",!1);filterCollection()}};$.fn.PivotViewer=function(n){if(r[n])return r[n].apply(this,Array.prototype.slice.call(arguments,1));if(typeof n!="object"&&n)$.error("Method "+n+" does not exist on jQuery.PivotViewer");else return r.init.apply(this,arguments)}})(jQuery)
