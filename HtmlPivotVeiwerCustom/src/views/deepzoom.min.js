PivotViewer.Views.DeepZoomImageController=PivotViewer.Views.IImageController.subClass({init:function(){this._items=[];this._itemsById=[];this._collageItems=[];this._baseUrl="";this._collageMaxLevel=0;this._tileSize=256;this._format="";this._ratio=1;this.MaxRatio=1;this._zooming=!1;var n=this;$.subscribe("/PivotViewer/ImageController/Zoom",function(t){n._zooming=t})},Setup:function(n){this._baseUrl=n.substring(0,n.lastIndexOf("/"));this._collageUrl=n.substring(n.lastIndexOf("/")+1).replace(".xml","_files");var t=this;$.ajax({type:"GET",url:n,dataType:"xml",success:function(n){var c=$(n).find("Collection"),r,e,o,l;if(t._tileSize=$(c).attr("TileSize"),t._format=$(c).attr("Format"),t._collageMaxLevel=$(c).attr("MaxLevel"),r=$(n).find("I"),r.length==0){$(".pv-loading").remove();e="No items in the DeepZoom Collection<br><br>";e+="URL        : "+this.url+"<br>";e+="<br>Pivot Viewer cannot continue until this problem is resolved<br>";$(".pv-wrapper").append('<div id="pv-dzloading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X<\/a><h2>HTML5 PivotViewer<\/h2><p>'+e+"<\/p><\/div><\/div>");setTimeout(function(){window.open("#pv-dzloading-error","_self")},1e3);return}if(o=$(r[0]).find("Size"),o.length>0)for(t.MaxWidth=parseInt(o.attr("Width")),t.Height=parseInt(o.attr("Height")),t.MaxRatio=t.Height/t.MaxWidth,i=0;i<r.length;i++){itemSize=$(r[i]).find("Size");var u=parseInt(itemSize.attr("Width")),s=parseInt(itemSize.attr("Height")),v=u>s?u:s,y=Math.ceil(Math.log(v)/Math.log(2));t._ratio=s/u;var f=$(r[i]).attr("Source"),a=$(r[i]).attr("Id"),p=$(r[i]).attr("N"),w=f.substring(f.lastIndexOf("/")+1).replace(/\.xml/gi,"").replace(/\.dzi/gi,""),h=f.substring(0,f.lastIndexOf("/"));h.length>0&&(h=h+"/");u>t.MaxWidth&&(t.MaxWidth=u);t._ratio<t.MaxRatio&&(t.MaxRatio=t._ratio);l=new PivotViewer.Views.DeepZoomItem(a,w,p,h,t._ratio,u,s,y,t._baseUrl,f);t._items.push(l);t._itemsById[a]=l}$.publish("/PivotViewer/ImageController/Collection/Loaded",null)},error:function(n,t,i){$(".pv-loading").remove();var r="Error loading from DeepZoom Cache<br><br>";r+="URL        : "+this.url+"<br>";r+="Status : "+n.status+" "+i+"<br>";r+="Details    : "+n.responseText+"<br>";r+="<br>Pivot Viewer cannot continue until this problem is resolved<br>";$(".pv-wrapper").append('<div id="pv-dzloading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X<\/a><h2>HTML5 PivotViewer<\/h2><p>'+r+"<\/p><\/div><\/div>");setTimeout(function(){window.open("#pv-dzloading-error","_self")},1e3)}})},GetImages:function(n,t,i){var u=t>i?t:i,r=Math.ceil(Math.log(u)/Math.log(2));return(r==Infinity||r==-Infinity)&&(r=0),this._level=r,this.GetImagesAtLevel(n,r)},GetImagesAtLevel:function(n,t){var i,f,r,e,u;t=t<=0?6:t;i=this._itemsById[n];t=t>i.MaxLevel?i.MaxLevel:t;var o=i.DZN.toString(2),s="",h="";for(f=0;f<o.length;f++)f%2==0?s+=o[f]:h+=o[f];if(dzCol=parseInt(s,2),dzRow=parseInt(h,2),i.Levels!=undefined&&i.Levels.length!=0||this._zooming)i.Levels.length<t&&!this._zooming&&(e=this.GetImageList(n,this._baseUrl+"/"+i.BasePath+i.DZId+"_files/"+t+"/",t),u=new PivotViewer.Views.LoadImageSetHelper,u.LoadImages(e),i.Levels.splice(t,0,u));else return e=this.GetImageList(n,this._baseUrl+"/"+i.BasePath+i.DZId+"_files/6/",6),u=new PivotViewer.Views.LoadImageSetHelper,u.LoadImages(e),i.Levels.push(u),null;for(r=t;r>-1;r--){if(i.Levels[r]!=undefined&&i.Levels[r].IsLoaded())return i.Levels[r].GetImages();r!=t||i.Levels[r]!=undefined||this._zooming||(e=this.GetImageList(n,this._baseUrl+"/"+i.BasePath+i.DZId+"_files/"+r+"/",r),u=new PivotViewer.Views.LoadImageSetHelper,u.LoadImages(e),i.Levels.splice(r,0,u))}return null},GetImageList:function(n,t,i){for(var r,e=[],o=this._tileSize,c=this._format,u=this._itemsById[n],l=u.Ratio,s=u.Height,h=u.MaxLevel,a=Math.ceil(s/l/Math.pow(2,h-i)),v=Math.ceil(s/Math.pow(2,h-i)),y=Math.ceil(a/o),p=Math.ceil(v/o),f=0;f<y;f++)for(r=0;r<p;r++)e.push(t+f+"_"+r+"."+c);return e},GetWidthForImage:function(n,t){return Math.floor(t/this._itemsById[n].Ratio)},GetDzi:function(n){var t=this._itemsById[n];return this._baseUrl+"/"+t.BasePath+t.DZId+".dzi"},GetMaxLevel:function(n){return this._itemsById[n].MaxLevel},GetWidth:function(n){return this._itemsById[n].Width},GetHeight:function(n){return this._itemsById[n].Height},GetOverlap:function(n){return this._itemsById[n].Overlap},GetRatio:function(n){return this._itemsById[n].Ratio}});PivotViewer.Views.DeepZoomItem=Object.subClass({init:function(n,t,i,r,u,f,e,o,s,h){this.ItemId=n;this.DZId=t;this.DZN=parseInt(i);this.BasePath=r;this.Levels=[];this.Ratio=u;this.Width=f;this.Height=e;this.MaxLevel=o;var c=this;$.ajax({type:"GET",url:s+"/"+h,dataType:"xml",success:function(n){var t=$(n).find("Image"),i;t.length!=0&&(i=$(t[0]),c.Overlap=i.attr("Overlap"))},error:function(){c.Overlap=0}})}});
