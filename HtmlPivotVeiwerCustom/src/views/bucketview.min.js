PivotViewer.Views.BucketView=PivotViewer.Views.TileBasedView.subClass({init:function(n){this._super();var t=this;this.buckets=[];this.Scale=1;this.canvasHeightUIAdjusted=0;this.titleSpace=62;this.dontZoom=!1;this.collection=n;$.subscribe("/PivotViewer/Views/Canvas/Click",function(n){var r,u,i,f;if(t.isActive){for(r=null,u=null,i=0;i<t.tiles.length;i++)f=t.tiles[i].Contains(n.x,n.y),f>=0?(r=t.tiles[i],u=f):t.tiles[i].Selected(!1);t.handleSelection(r,n.x,u)}});$.subscribe("/PivotViewer/Views/Canvas/Hover",function(n){var u,f,i,r;if(t.isActive)for($(".pv-viewarea-bucketview-overlay-bucket").removeClass("bucketview-bucket-hover"),u=Math.floor((n.x-t.offsetX)/t.columnWidth),f=$("#pv-viewarea-bucketview-overlay-bucket-"+u),f.addClass("bucketview-bucket-hover"),i=0;i<t.tiles.length;i++)r=t.tiles[i].Contains(n.x,n.y),r>=0?(t.tiles[i].Selected(!0),t.tiles[i].selectedLoc=r):t.tiles[i].Selected(!1)});$.subscribe("/PivotViewer/Views/Canvas/Zoom",function(n){var u,f,e,i;if(t.isActive){if(t.dontZoom){t.dontZoom=!1;return}var r=t.Scale,o=t.currentWidth,s=t.currentHeight,h=n.scale!=undefined?0:1e3;if(n.scale!=undefined?n.scale>=1?t.Scale+=n.scale-1:(t.Scale-=n.scale,t.Scale=t.Scale<1?1:t.Scale):n.delta!=undefined&&(t.Scale=n.delta==0?1:t.Scale+n.delta),isNaN(t.Scale)&&(t.Scale=1),u=(t.width-t.offsetX)*t.Scale,f=t.height*t.Scale,u<t.width||t.Scale==1?(t.currentOffsetX=t.offsetX,t.currentOffsetY=t.offsetY,t.currentWidth=t.width,t.currentHeight=t.height,t.canvasHeightUIAdjusted=t.height-t.offsetY-t.titleSpace,t.columnWidth=(t.width-t.offsetX)/t.buckets.length,t.Scale=1,$(".pv-viewarea-bucketview-overlay div").fadeIn("slow"),t.dontZoom=!0,$(".pv-toolbarpanel-zoomslider").slider("option","value",0)):(t.currentOffsetX=n.x-(n.x-t.currentOffsetX)/r*t.Scale,e=(n.y-t.currentOffsetY)/r*t.Scale,t.currentOffsetY=n.y-e,t.canvasHeightUIAdjusted=f-(t.offsetY+t.titleSpace)/r*t.Scale,t.currentWidth=u,t.currentHeight=f,t.columnWidth=u/t.buckets.length,$(".pv-viewarea-bucketview-overlay div").fadeOut("slow")),t.rowscols=t.GetRowsAndColumns(t.columnWidth-2,t.canvasHeightUIAdjusted,t.maxRatio,t.bigCount),t.rowscols.TileHeight<10&&(t.rowscols.TileHeight=10),t.SetVisibleTileGraphPositions(t.rowscols,t.currentOffsetX,t.currentOffsetY,!0,!0),t.Scale==1&&r!=1){for(i=0;i<t.tiles.length;i++)t.tiles[i].Selected(!1),t.tiles[i].selectedLoc=0;t.selected=null;$.publish("/PivotViewer/Views/Item/Selected",[{item:t.selected,bkt:0}])}}});$.subscribe("/PivotViewer/Views/Canvas/Drag",function(n){if(t.isActive){var i=n.x,r=n.y,u=!1,f=!1;(t.currentOffsetX+=i,t.currentOffsetY+=r,i>0&&t.currentOffsetX>t.offsetX&&(t.currentOffsetX-=i,u=!0),r>0&&t.currentOffsetY+t.canvasHeightUIAdjusted>t.currentHeight+t.offsetY&&(t.currentOffsetY-=r,f=!0),t.currentOffsetX<t.offsetX&&t.currentWidth==t.width&&(t.currentOffsetX-=i,u=!0),i<0&&t.currentOffsetX<-1*(t.currentWidth-t.width)&&(t.currentOffsetX-=i,u=!0),t.currentOffsetY<t.offsetY&&t.currentHeight==t.height&&(t.currentOffsetY-=r,f=!0),r<0&&t.currentOffsetY-t.offsetY<-1*(t.currentHeight-t.height)&&(t.currentOffsetY-=r,f=!0),u&&f)||(u?t.OffsetTiles(0,r):f?t.OffsetTiles(i,0):t.OffsetTiles(i,r))}})},Setup:function(n,t,i,r,u){this.width=n;this.height=t;this.offsetX=i;this.offsetY=r;this.maxRatio=u;this.currentWidth=this.width;this.currentHeight=this.height;this.currentOffsetX=this.offsetX;this.currentOffsetY=this.offsetY;this.rowscols=null;this.bigCount=0},Filter:function(n,t,i){this.sortFacet=i;this.tiles=n;this.filter=t;this.buckets=this.Bucketize(n,t,this.sortFacet);this.filtered=!1},Activate:function(){var t=this,i,e,o,r,u,n,s,f,h;if(Modernizr.canvas){for(this._super(),this.filtered&&this.Filter(this.filterEvt.tiles,this.filterEvt.filter,this.filterEvt.sort),this.columnWidth=(this.width-this.offsetX)/this.buckets.length,this.canvasHeightUIAdjusted=this.height-this.offsetY-this.titleSpace,i=[],this.bigCount=0,n=0;n<this.buckets.length;n++)e=n%2==0?"bucketview-bucket-dark":"bucketview-bucket-light",o=this.buckets[n].startRange==this.buckets[n].endRange||this.buckets[n].startLabel==this.buckets[n].endLabel?this.buckets[n].startLabel:this.buckets[n].startLabel+"<br>to<br>"+this.buckets[n].endLabel,i[n]="<div class='pv-viewarea-bucketview-overlay-bucket "+e+"' id='pv-viewarea-bucketview-overlay-bucket-"+n+"' style='width: "+(Math.floor(this.columnWidth)-4)+"px; height:"+(this.height-2)+"px; left:"+(n*this.columnWidth-2)+"px;'>",i[n]+="<div class='pv-viewarea-bucketview-overlay-buckettitle' style='top: "+(this.canvasHeightUIAdjusted+4)+"px;'><div class='pv-bucket-countbox'>"+this.buckets[n].tiles.length+"<\/div>"+o+"<\/div><\/div>",this.bigCount<this.buckets[n].tiles.length&&(this.bigCount=this.buckets[n].tiles.length);for(r=$(".pv-viewarea-bucketview-overlay"),r.css("left",this.offsetX+"px"),$(".pv-viewarea-bucketview-overlay div").fadeOut("slow",function(){$(this).remove()}),r.append(i.join("")),$(".pv-viewarea-bucketview-overlay div").fadeIn("slow"),n=0;n<this.tiles.length;n++)(this.tiles[n]._locations[0].startx=this.tiles[n]._locations[0].x,this.tiles[n]._locations[0].starty=this.tiles[n]._locations[0].y,this.tiles[n].startwidth=this.tiles[n].width,this.tiles[n].startheight=this.tiles[n].height,this.tiles[n].visible)||(this.tiles[n].start=PivotViewer.Utils.Now(),this.tiles[n].end=this.tiles[n].start+1e3,u=Math.atan2(this.tiles[n]._locations[0].y-this.currentHeight/2,this.tiles[n]._locations[0].x-this.currentWidth/2),this.tiles[n]._locations[0].destinationx=this.currentWidth*Math.cos(u)+this.currentWidth/2,this.tiles[n]._locations[0].destinationy=this.currentHeight*Math.sin(u)+this.currentHeight/2);for(this.maxRatio=TileController._imageController.GetRatio(this.tiles[0].facetItem.Img),n=0;n<this.filter.length;n++)s=this.filter[n].facetItem,f=TileController._imageController.GetRatio(s.Img),f<this.maxRatio&&(this.maxRatio=f);h=this.filter.length==this.tiles.length?0:500;setTimeout(function(){var r=$(".pv-toolbarpanel-zoomslider").slider("option","value"),i,n;for(r>0&&(this.selected=selectedTile=null,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,$(".pv-toolbarpanel-zoomslider").slider("option","value",0)),t.rowscols=t.GetRowsAndColumns(t.columnWidth-2,t.canvasHeightUIAdjusted-t.offsetY,t.maxRatio,t.bigCount),t.rowscols.TileHeight<10&&(t.rowscols.TileHeight=10),i=TileController._imageController,n=0;n<t.tiles.length;n++)t.tiles[n].origwidth=t.rowscols.TileHeight/i.GetRatio(t.tiles[n].facetItem.Img),t.tiles[n].origheight=t.rowscols.TileHeight,t.tiles[n].destinationwidth=1,t.tiles[n].destinationheight=1;t.SetVisibleTileGraphPositions(t.rowscols,t.offsetX,t.offsetY,!1,!1)},h)}},Deactivate:function(){this._super();$(".pv-viewarea-bucketview-overlay div").fadeOut()},GetUI:function(){return Modernizr.canvas?"<div class='pv-viewarea-bucketview-overlay'><\/div>":this._super()},GetButtonImage:function(){return"images/bucketview.png"},GetButtonImageSelected:function(){return"images/bucketviewSelected.png"},GetViewName:function(){return"Bucket View"},SetVisibleTileGraphPositions:function(n,t,i,r,u){var a=u&&this.rowscols?this.rowscols.Columns:n.Columns,v,y,e,o,h,f;for(u||(this.rowscols=n),v=[],y=[],e=0;e<this.tiles.length;e++)this.tiles[e].firstFilterItemDone=!1,this.tiles[e]._locations=[this.tiles[e]._locations[0]];for(o=0;o<this.buckets.length;o++){var l=this.buckets[o],s=0,c=0;for(h=0;h<l.tiles.length;h++)f=l.tiles[h],f.firstFilterItemDone?(tileLocation=new PivotViewer.Views.TileLocation,tileLocation.startx=f._locations[0].startx,tileLocation.starty=f._locations[0].starty,tileLocation.x=f._locations[0].x,tileLocation.y=f._locations[0].y,tileLocation.destinationx=o*this.columnWidth+s*n.TileMaxWidth+t,tileLocation.destinationy=this.canvasHeightUIAdjusted-n.TileHeight-c*n.TileHeight+i,f._locations.push(tileLocation)):(r&&(f._locations[0].startx=f._locations[0].x,f._locations[0].starty=f._locations[0].y,f.startwidth=f.width,f.startheight=f.height),f.destinationwidth=n.TileMaxWidth,f.destinationheight=n.TileHeight,f._locations[0].destinationx=o*this.columnWidth+s*n.TileMaxWidth+t,f._locations[0].destinationy=this.canvasHeightUIAdjusted-n.TileHeight-c*n.TileHeight+i,f.start=PivotViewer.Utils.Now(),f.end=f.start+1e3,f.firstFilterItemDone=!0),s==a-1?(s=0,c++):s++}},Bucketize:function(n,t,i){var u,f,o,l,e,a,p,h,w,r,v,y,c,s;if(category=PivotCollection.GetFacetCategoryByName(i),t[0].facetItem.FacetByName[i]==undefined)return[{startRange:"(no info)",endRange:"(no info)",tiles:[t[0]],values:["(no info)"],startLabel:"(no info)",endLabel:"(no info)"}];for(u=t[0].facetItem.FacetByName[i].FacetValues[0].Value,r=t.length-1;r>0;r--)if(t[r].facetItem.FacetByName[i]!=undefined)break;if(f=t[r].facetItem.FacetByName[i].FacetValues[0].Value,category.Type==PivotViewer.Models.FacetType.DateTime)return u=new Date(u),f=new Date(f),f.getFullYear()-u.getFullYear()+u.getFullYear()%10>9?GetBuckets(t,i,function(n){var t=new Date(n.Value).getFullYear();return t-t%10},function(n){var t=new Date(n.Value).getFullYear();return t-t%10+"s"}):f.getFullYear()>u.getFullYear()?GetBuckets(t,i,function(n){return new Date(n.Value).getFullYear()},function(n){return new Date(n.Value).getFullYear().toString()}):f.getMonth()>u.getMonth()?GetBuckets(t,i,function(n){return new Date(n.Value).getMonth()},function(n){var t=new Date(n.Value);return GetMonthName(t)+" "+t.getFullYear()}):f.getDate()>u.getDate()?GetBuckets(t,i,function(n){return new Date(n.Value).getDate()},function(n){var t=new Date(n.Value);return GetMonthName(t)+" "+t.getDate()+", "+t.getFullYear()}):f.getHours()>u.getHours()?GetBuckets(t,i,function(n){return new Date(n.Value).getHours()},function(n){var t=new Date(n).Value;return GetMonthName(t)+" "+t.getDate()+", "+t.getFullYear()+" "+GetStandardHour(t)+" "+GetMeridian(t)}):f.getMinutes()>u.getMinutes()?GetBuckets(t,i,function(n){return new Date(n.Value).getMinutes()},function(n){var t=new Date(n.Value);return GetMonthName(t)+" "+t.getDate()+", "+t.getFullYear()+" "+GetStandardHour(t)+":"+GetStandardMinutes(t)+" "+GetMeridian(t)}):GetBuckets(t,i,function(n){return new Date(n.Value).getSeconds()},function(n){var t=new Date(n.Value);return GetMonthName(t)+" "+t.getDate()+", "+t.getFullYear()+" "+GetStandardHour(t)+":"+GetStandardMinutes(t)+"::"+GetStandardSeconds(t)+" "+GetMeridian(t)});if(category.Type==PivotViewer.Models.FacetType.Number){for(o=[],l=f-u,l==0?e=1:(e=Math.pow(10,Math.ceil(Math.log(l)/Math.log(10))-1),l<=e*5&&(e=e/2)),a=Math.floor(u/e)*e,p=Math.floor((f-a)/e)+1,r=0;r<p;r++)h=r*e+a,w=h+e,o[r]={startRange:h,endRange:h,tiles:[],values:[],startLabel:h.toString(),endLabel:w.toString()};for(r=0;r<t.length;r++){if(v=t[r].facetItem.FacetByName[i],v==undefined)break;for(t[r].buckets=[],y=0;y<v.FacetValues.length;y++)c=v.FacetValues[y].Value,s=o[Math.floor((c-a)/e)],s.tiles.push(t[r]),s.values[s.values.length-1]!=c&&(s.endRange=c,s.values.push(c))}if(r!=t.length)for(o.push({startRange:"(no info)",endRange:"(no info)",tiles:[],values:["(no info)"],startLabel:"(no info)",endLabel:"(no info)"});r<t.length;r++)s=o[o.length-1],s.tiles.push(t[r]),t[r].buckets=[o.length-1];return o}return GetBuckets(t,i)},GetSelectedCol:function(n){var r=n.selectedLoc,u=this.rowscols.PaddingX,t=this.rowscols.Columns,i=this.rowscols.TileMaxWidth,f=Math.floor((n._locations[r].x-this.currentOffsetX)/(i*t+u)),e=Math.round((n._locations[r].x-this.currentOffsetX-f*(t*i+u))/i);return f*t+e},GetSelectedRow:function(n){var t=n.selectedLoc;return Math.round((this.canvasHeightUIAdjusted-(n._locations[t].y-this.currentOffsetY))/n.height)},CenterOnSelectedTile:function(n,t){this.rowscols=this.GetRowsAndColumns(this.columnWidth-2,this.canvasHeightUIAdjusted,this.maxRatio,this.bigCount);this.rowscols.TileHeight<10&&(this.rowscols.TileHeight=10);var i=Math.floor(n/this.rowscols.Columns),r=this.rowscols.PaddingX*i;this.currentOffsetX=this.rowscols.TileMaxWidth*n*-1+this.width/2-this.rowscols.TileMaxWidth/2-r;this.currentOffsetY=-this.rowscols.TileHeight*(this.rowscols.Rows/2-(t+1))-this.canvasHeightUIAdjusted/2-this.rowscols.TileHeight/2;this.SetVisibleTileGraphPositions(this.rowscols,this.currentOffsetX,this.currentOffsetY,!0,!0)},handleSelection:function(n,t,i){var o=0,s=0,r=0,f=!1,h=!1,c,v,u;if(this.selected!=n&&this.selected==null&&(c=$(".pv-toolbarpanel-zoomslider").slider("option","value"),c!=0&&$(".pv-toolbarpanel-zoomslider").slider("option","value",0)),n!=null&&(n.Selected(!0),n.selectedLoc=i,f=!0),this.selected==null||f||(h=!0),n!=null&&this.selected!=n){var l=this.rowscols.PaddingX,e=this.rowscols.Columns,a=this.rowscols.TileMaxWidth;r=Math.floor((n._locations[i].x-this.currentOffsetX)/(n.width*e+l));v=Math.round((n._locations[i].x-this.currentOffsetX-r*(e*a+l))/a);o=r*e+v;s=Math.round((this.canvasHeightUIAdjusted-(n._locations[i].y-this.currentOffsetY))/n.height);var b=n.height,k=n.height/TileController._imageController.GetRatio(n.facetItem.Img),d=n.origheight,g=n.origwidth,y=n.context.canvas.height,p=n.context.canvas.width-($(".pv-filterpanel").width()+$(".pv-infopanel").width()),w;w=b/y>k/p?d/y:g/p;this.selected==null&&$(".pv-toolbarpanel-zoomslider").slider("option","value",Math.round(.75/w*2));this.selected=n;this.CenterOnSelectedTile(o,s);$(".pv-viewarea-bucketview-overlay div").fadeOut("slow")}else this.selected=n=null,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,$(".pv-toolbarpanel-zoomslider").slider("option","value",0),$(".pv-viewarea-bucketview-overlay div").fadeIn("slow");$.publish("/PivotViewer/Views/Item/Selected",[{item:n,bkt:r}]);f||h||(u=Math.floor((t-this.offsetX)/this.columnWidth),$.publish("/PivotViewer/Views/Item/Filtered",[{Facet:this.sortFacet,Item:this.buckets[u].startRange,MaxRange:this.buckets[u].endRange,Values:this.buckets[u].values,ClearFacetFilters:!0}]))}});
