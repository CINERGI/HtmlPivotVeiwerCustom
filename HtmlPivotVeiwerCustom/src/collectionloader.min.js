PivotViewer.Models.Loaders.ICollectionLoader=Object.subClass({init:function(){},LoadCollection:function(n){if(!n instanceof PivotViewer.Models.Collection)throw"collection not an instance of PivotViewer.Models.Collection.";}});PivotViewer.Models.Loaders.CXMLLoader=PivotViewer.Models.Loaders.ICollectionLoader.subClass({init:function(n,t){this.CXMLUriNoProxy=n;this.CXMLUri=t?t+n:n},LoadCollection:function(n){var n=n,t;this._super(n);n.CollectionBaseNoProxy=this.CXMLUriNoProxy;n.CollectionBase=this.CXMLUri;t=this;this.CXMLUri.endsWith(".zip")?jBinary.loadData(this.CXMLUri).then(function(i){var u=new JSZip,r;u.load(i);r=u.file(/.cxml/)[0].asText();t.LoadXML(n,$.parseXML(r.substring(r.indexOf(">")+1)))}):$.ajax({type:"GET",url:this.CXMLUri,dataType:"xml",success:function(n){return function(i){t.LoadXML(n,i)}}(n),error:function(n,t,i){var r,u;$(".pv-loading").remove();r="Error loading CXML Collection<br><br>";r+="URL        : "+this.url+"<br>";r+="Status : "+n.status+" "+i+"<br>";r+="Details    : "+n.responseText+"<br>";r+="<br>Pivot Viewer cannot continue until this problem is resolved<br>";$(".pv-wrapper").append('<div id="pv-loading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X<\/a><h2>HTML5 PivotViewer<\/h2><p>'+r+"<\/p><\/div><\/div>");u=setTimeout(function(){window.open("#pv-loading-error","_self")},1e3)}})},LoadXML:function(n,t){var ot,f,ht,it,s,b,u,k,rt,ut,a,o,e,d,h,g,ct,p,nt,at,c,tt,vt,w,y,r,ft;Debug.Log("CXML loaded");var l=$(t).find("Collection")[0],et=0,i="P";if(l==undefined){$(".pv-loading").remove();b="Error parsing CXML Collection<br>";b+="<br>Pivot Viewer cannot continue until this problem is resolved<br>";$(".pv-wrapper").append('<div id="pv-parse-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X<\/a><h2>HTML5 PivotViewer<\/h2><p>'+b+"<\/p><\/div><\/div>");setTimeout(function(){window.open("#pv-parse-error","_self")},1e3);throw"Error parsing CXML Collection";}for(u=0;u<l.attributes.length;u++)if(l.attributes[u].value=="http://schemas.microsoft.com/livelabs/pivot/collection/2009"){i=l.attributes[u].localName!=undefined?l.attributes[u].localName:l.attributes[u].baseName;break}for(n.CollectionName=$(l).attr("Name"),n.BrandImage=$(l).attr(i+":BrandImage")!=undefined?$(l).attr(i+":BrandImage"):"",ot=$(t).find("FacetCategory"),y=i,u=0;u<ot.length;u++){for(f=$(ot[u]),r=0;r<f[0].attributes.length;r++)if(f[0].attributes[r].value=="http://schemas.microsoft.com/livelabs/pivot/collection/2009"){i=f[0].attributes[r].localName!=undefined?f[0].attributes[r].localName:f[0].attributes[r].baseName;break}var lt=new PivotViewer.Models.FacetCategory(f.attr("Name"),f.attr("Format"),f.attr("Type"),f.attr(i+":IsFilterVisible")!=undefined?f.attr(i+":IsFilterVisible").toLowerCase()=="true"?!0:!1:!0,f.attr(i+":IsMetaDataVisible")!=undefined?f.attr(i+":IsMetaDataVisible").toLowerCase()=="true"?!0:!1:!0,f.attr(i+":IsWordWheelVisible")!=undefined?f.attr(i+":IsWordWheelVisible").toLowerCase()=="true"?!0:!1:!0),v=f.find(i+"\\:SortOrder"),st=v.find(i+"\\:SortValue");if(v.length==0&&(v=f.find("SortOrder"),st=v.find("SortValue")),v.length==1){for(ht=new PivotViewer.Models.FacetCategorySort(v.attr("Name")),r=0;r<st.length;r++)ht.SortValues.push($(st[r]).attr("Value"));lt.CustomSort=ht}n.FacetCategories.push(lt);i=y}if(it=$(t).find("Items"),it.length==1)if(s=$(it[0]).find("Item"),n.ImageBase=$(it[0]).attr("ImgBase"),s.length==0)$(".pv-loading").remove(),b="There are no items in the CXML Collection<br><br>",$(".pv-wrapper").append('<div id="pv-empty-collection-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X<\/a><h2>HTML5 PivotViewer<\/h2><p>'+b+"<\/p><\/div><\/div>"),setTimeout(function(){window.open("#pv-empty-collection-error","_self")},1e3);else for(u=0;u<s.length;u++){for(k=new PivotViewer.Models.Item($(s[u]).attr("Img").replace("#",""),$(s[u]).attr("Id"),$(s[u]).attr("Href"),$(s[u]).attr("Name")),rt=$(s[u]).find("Description"),rt.length==1&&rt[0].childNodes.length&&(k.Description=PivotViewer.Utils.HtmlSpecialChars(rt[0].childNodes[0].nodeValue)),ut=$(s[u]).find("Facet"),r=0;r<ut.length;r++){for(a=new PivotViewer.Models.Facet($(ut[r]).attr("Name")),o=$(ut[r]).children(),e=0;e<o.length;e++)o[e].nodeType==1&&(d=$.trim($(o[e]).attr("Value")),d==null||d==""?o[e].nodeName=="Link"?$(o[e]).attr("Href")==""||$(o[e]).attr("Href")==null?(h=new PivotViewer.Models.FacetValue(PivotViewer.Utils.HtmlSpecialChars("(empty Link)")),a.AddFacetValue(h)):$(o[e]).attr("Name")==""||$(o[e]).attr("Name")==null?(h=new PivotViewer.Models.FacetValue("(unnamed Link)"),h.Href=$(o[e]).attr("Href"),a.AddFacetValue(h)):(h=new PivotViewer.Models.FacetValue($(o[e]).attr("Name")),h.Href=$(o[e]).attr("Href"),a.AddFacetValue(h)):(h=new PivotViewer.Models.FacetValue(PivotViewer.Utils.HtmlSpecialChars("(empty "+o[e].nodeName+")")),a.AddFacetValue(h)):o[e].nodeName=="Number"?a.AddFacetValue(new PivotViewer.Models.FacetValue(parseFloat(d))):a.AddFacetValue(new PivotViewer.Models.FacetValue(PivotViewer.Utils.HtmlSpecialChars(d))));k.Facets.push(a)}if(g=$(s[u]).find("Extension"),g.length==1){for(y=i,r=0;r<g[0].childNodes.length;r++)if(i=g[0].childNodes[r].lookupPrefix("http://schemas.microsoft.com/livelabs/pivot/collection/2009"),i)break;if(ct=$(g[0]).find(i+"\\:Related, Related"),ct.length==1){for(p=$(ct[0]).find(i+"\\:Link, Link"),nt=0;nt<p.length;nt++)at=$(p[nt]).attr("Name"),c=$(p[nt]).attr("Href"),c.indexOf(".cxml")==-1&&c.indexOf("pivot.vsp")>=0?(tt=$.url(this.url),c=tt.attr("protocol")+"://"+tt.attr("authority")+tt.attr("directory")+c):c.indexOf(".cxml")==-1&&c.indexOf("sparql")>=0&&(tt=$.url(this.url),c=location.origin+location.pathname+"?url="+c),vt=new PivotViewer.Models.ItemLink(at,c),k.Links.push(vt);p.length>et&&(et=p.length)}i=y}n.Items.push(k)}if(n.MaxRelatedLinks=et,w=$(t).find("Extension"),w.length>1)for(x=0;x<w.length;x++){for(y=i,r=0;r<w[x].childNodes.length;r++)if(i=w[0].childNodes[r].lookupPrefix("http://schemas.microsoft.com/livelabs/pivot/collection/2009"),i)break;if(ft=$(w[x]).find(i+"\\:Copyright, Copyright"),ft.length>0){n.CopyrightName=$(ft[0]).attr("Name");n.CopyrightHref=$(ft[0]).attr("Href");break}i=y}s.length>0&&$.publish("/PivotViewer/Models/Collection/Loaded",null)},LoadColumn:function(){},GetRow:function(n){return PivotCollection.getItemById(n).Facets}});
