PivotViewer.Views.GridView=PivotViewer.Views.TileBasedView.subClass({init:function(n){this.collection=n;this.Scale=1;this._super();this.dontZoom=!1;var t=this;this.prevFilter=null;$.subscribe("/PivotViewer/Views/Canvas/Click",function(n){var r,i,u;if(t.isActive){for(r=null,i=0;i<t.tiles.length;i++)u=t.tiles[i].Contains(n.x,n.y),u>=0?r=t.tiles[i]:t.tiles[i].Selected(!1);t.handleSelection(r)}});$.subscribe("/PivotViewer/Views/Canvas/Hover",function(n){var i,r;if(t.isActive&&t.selected==null)for(i=0;i<t.tiles.length;i++)r=t.tiles[i].Contains(n.x,n.y),r>=0?t.tiles[i].Selected(!0):t.tiles[i].Selected(!1)});$.subscribe("/PivotViewer/Views/Canvas/Zoom",function(n){var u,e,o,s,f,h,i;if(t.isActive){if(t.dontZoom){t.dontZoom=!1;return}var r=t.Scale,l=t.currentWidth,a=t.currentHeight,c=n.scale!=undefined?0:1e3;if(n.scale!=undefined?n.scale>=1?t.Scale+=n.scale-1:(t.Scale-=n.scale,t.Scale=t.Scale<1?1:t.Scale):n.delta!=undefined&&(t.Scale=n.delta==0?1:t.Scale+n.delta),isNaN(t.Scale)&&(t.Scale=1),u=(t.width-t.offsetX)*t.Scale,e=(t.height-t.offsetY)*t.Scale,u<t.width||t.Scale==1?(t.currentOffsetX=t.offsetX,t.currentOffsetY=t.offsetY,t.currentWidth=t.width,t.currentHeight=t.height,t.Scale=1,t.dontZoom=!0,$(".pv-toolbarpanel-zoomslider").slider("option","value",0)):(o=(n.x-t.currentOffsetX)/r*t.Scale,s=(n.y-t.currentOffsetY)/r*t.Scale,t.currentOffsetX=n.x-o,t.currentOffsetY=n.y-s,t.currentWidth=u,t.currentHeight=e),f=t.prevFilter==null?t.filter:t.prevFilter,h=t.GetRowsAndColumns(t.currentWidth-t.offsetX,t.currentHeight-t.offsetY,t.maxRatio,f.length),t.SetVisibleTilePositions(h,f,t.currentOffsetX,t.currentOffsetY,!0,!0,c),t.Scale==1&&r!=1){for(i=0;i<t.tiles.length;i++)t.tiles[i].Selected(!1);t.selected=null;$.publish("/PivotViewer/Views/Item/Selected",[{item:t.selected,bkt:0}])}}});$.subscribe("/PivotViewer/Views/Canvas/Drag",function(n){if(t.isActive){var i=n.x,r=n.y,u=!1,f=!1;(t.currentOffsetX+=i,t.currentOffsetY+=r,i>0&&t.currentOffsetX>t.offsetX&&(t.currentOffsetX-=i,u=!0),r>0&&t.currentOffsetY>t.offsetY&&(t.currentOffsetY-=r,f=!0),t.currentOffsetX<t.offsetX&&t.currentWidth==t.width&&(t.currentOffsetX-=i,u=!0),i<0&&t.currentOffsetX<-1*(t.currentWidth-t.width)&&(t.currentOffsetX-=i,u=!0),t.currentOffsetY<t.offsetY&&t.currentHeight==t.height&&(t.currentOffsetY-=r,f=!0),r<0&&t.currentOffsetY-t.offsetY<-1*(t.currentHeight-t.height)&&(t.currentOffsetY-=r,f=!0),u&&f)||(u?t.OffsetTiles(0,r):f?t.OffsetTiles(i,0):t.OffsetTiles(i,r))}})},Setup:function(n,t,i,r,u){this.width=n;this.height=t;this.offsetX=i;this.offsetY=r;this.maxRatio=u;this.currentWidth=this.width;this.currentHeight=this.height;this.currentOffsetX=this.offsetX;this.currentOffsetY=this.offsetY},Activate:function(){var n=this,i,u,e,f,r,t;if(Modernizr.canvas){for(this._super(),this.filtered&&this.Filter(this.filterEvt.tiles,this.filterEvt.filter),i=0;i<this.tiles.length;i++)while(this.tiles[i]._locations.length>1)this.tiles[i]._locations.pop();for(t=0;t<this.tiles.length;t++)this.tiles[t].selectedLoc=0;if(u=0,e=$(".pv-toolbarpanel-zoomslider").slider("option","value"),e>0){for(this.selected=null,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,$(".pv-toolbarpanel-zoomslider").slider("option","value",0),f=this.prevFilter==null?this.filter:this.prevFilter,r=this.GetRowsAndColumns(this.currentWidth-this.offsetX,this.currentHeight-this.offsetY,this.maxRatio,f.length),t=0;t<this.tiles.length;t++)this.tiles[t].origwidth=r.TileHeight/TileController._imageController.GetRatio(this.tiles[t].facetItem.Img),this.tiles[t].origheight=r.TileHeight;this.SetVisibleTilePositions(r,f,this.currentOffsetX,this.currentOffsetY,!0,!1,1e3);u=1e3}this.prevFilter=null;setTimeout(function(){for(var i,u,r,f,t=0,e=0;t<n.tiles.length;t++)(n.tiles[t]._locations[0].startx=n.tiles[t]._locations[0].x,n.tiles[t]._locations[0].starty=n.tiles[t]._locations[0].y,n.tiles[t].startwidth=n.tiles[t].width,n.tiles[t].startheight=n.tiles[t].height,n.tiles[t].visible)||(n.tiles[t].start=PivotViewer.Utils.Now(),n.tiles[t].end=n.tiles[t].start+1e3,i=Math.atan2(n.tiles[t]._locations[0].y-n.currentHeight/2,n.tiles[t]._locations[0].x-n.currentWidth/2),n.tiles[t]._locations[0].destinationx=n.currentWidth*Math.cos(i)+n.currentWidth/2,n.tiles[t]._locations[0].destinationy=n.currentHeight*Math.sin(i)+n.currentHeight/2);for(n.maxRatio=TileController._imageController.GetRatio(n.tiles[0].facetItem.Img),t=0;t<n.filter.length;t++)u=n.filter[t].facetItem,r=TileController._imageController.GetRatio(u.Img),r<n.maxRatio&&(n.maxRatio=r);f=n.filter.length==n.tiles.length?0:500;setTimeout(function(){for(var i=n.GetRowsAndColumns(n.width-n.offsetX,n.height-n.offsetY,n.maxRatio,n.filter.length),t=0;t<n.tiles.length;t++)n.tiles[t].origwidth=i.TileHeight/TileController._imageController.GetRatio(n.tiles[t].facetItem.Img),n.tiles[t].origheight=i.TileHeight;n.SetVisibleTilePositions(i,n.filter,n.offsetX,n.offsetY,!1,!1,1e3)},f)},u)}},Filter:function(n,t){this.tiles=n;this.prevFilter=this.filter;this.filter=t;this.filtered=!1},GetButtonImage:function(){return"images/GridView.png"},GetButtonImageSelected:function(){return"images/GridViewSelected.png"},GetViewName:function(){return"Grid View"},SetVisibleTilePositions:function(n,t,i,r,u,f,e){var c=f&&this.rowscols?this.rowscols.Columns:n.Columns,s,h,o;for(f||(this.rowscols=n),s=0,h=0,o=0;o<t.length;o++)u&&(t[o]._locations[0].startx=t[o]._locations[0].x,t[o]._locations[0].starty=t[o]._locations[0].y,t[o].startwidth=t[o].width,t[o].startheight=t[o].height),t[o].destinationwidth=n.TileMaxWidth,t[o].destinationheight=n.TileHeight,t[o]._locations[0].destinationx=s*n.TileMaxWidth+i,t[o]._locations[0].destinationy=h*n.TileHeight+r,t[o].start=PivotViewer.Utils.Now(),t[o].end=t[o].start+e,s==c-1?(s=0,h++):s++},GetSelectedCol:function(n){return selectedCol=Math.round((n._locations[0].x-this.currentOffsetX)/n.width)},GetSelectedRow:function(n){return selectedRow=Math.round((n._locations[0].y-this.currentOffsetY)/n.height)},CenterOnSelectedTile:function(n,t){var i=this.GetRowsAndColumns(this.currentWidth-this.offsetX,this.currentHeight-this.offsetY,this.maxRatio,this.filter.length);this.currentOffsetX=i.TileMaxWidth*n*-1+this.width/2-i.TileMaxWidth/2;this.currentOffsetY=i.TileHeight*t*-1+this.height/2-i.TileHeight/2;this.SetVisibleTilePositions(i,this.filter,this.currentOffsetX,this.currentOffsetY,!0,!0,1e3)},handleSelection:function(n){var t=0,i=0,r;n!=null&&(t=Math.round((n._locations[0].x-this.currentOffsetX)/n.width),i=Math.round((n._locations[0].y-this.currentOffsetY)/n.height));this.selected!=n&&this.selected==null&&(r=$(".pv-toolbarpanel-zoomslider").slider("option","value"),r!=0&&$(".pv-toolbarpanel-zoomslider").slider("option","value",0));n!=null&&(n.Selected(!0),tileHeight=n.height,tileWidth=n.height/TileController._imageController.GetRatio(n.facetItem.Img),tileOrigHeight=n.origheight,tileOrigWidth=n.origwidth,canvasHeight=n.context.canvas.height,canvasWidth=n.context.canvas.width-($(".pv-filterpanel").width()+$(".pv-infopanel").width()));this.selected!=n?(origProportion=tileHeight/canvasHeight>tileWidth/canvasWidth?tileOrigHeight/canvasHeight:tileOrigWidth/canvasWidth,this.selected==null&&$(".pv-toolbarpanel-zoomslider").slider("option","value",Math.round(.75/origProportion*2)),this.selected=n,this.CenterOnSelectedTile(t,i)):(this.selected=n=null,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,$(".pv-toolbarpanel-zoomslider").slider("option","value",0));$.publish("/PivotViewer/Views/Item/Selected",[{item:n,bkt:0}])}});
