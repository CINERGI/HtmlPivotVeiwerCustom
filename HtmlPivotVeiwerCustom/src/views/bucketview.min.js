PivotViewer.Views.BucketView=PivotViewer.Views.TileBasedView.subClass({init:function(){this._super();var n=this;this.buckets=[];this.scale=1;this.canvasHeightUIAdjusted=0;this.titleSpace=62;this.dontZoom=!1;$.subscribe("/PivotViewer/Views/Canvas/Click",function(t){var r,u,i,f;if(n.isActive){for(r=null,u=null,i=0;i<n.filterList.length;i++)f=n.filterList[i].contains(t.x,t.y),f>=0?(r=n.filterList[i],u=f):n.filterList[i].Selected(!1);n.handleSelection(r,t.x,t.y,u)}});$.subscribe("/PivotViewer/Views/Canvas/Hover",function(t){var u,r,e,i,f;if(n.isActive&&($(".pv-bucketview-overlay-bucket").removeClass("bucketview-bucket-hover"),u=n.getBucket(t.x),r=n.buckets[u],!(u<0)))for(e=$("#pv-bucketview-overlay-bucket-"+u),e.addClass("bucketview-bucket-hover"),i=0;i<r.tiles.length;i++)f=r.tiles[i].contains(t.x,t.y),f>=0?(r.tiles[i].Selected(!0),r.tiles[i].selectedLoc=f):r.tiles[i].Selected(!1)});$.subscribe("/PivotViewer/Views/Canvas/Zoom",function(t){var i,e,u,f,r;if(n.isActive){if(n.dontZoom){n.dontZoom=!1;return}if(i=n.scale,e=t.scale!=undefined?0:1e3,t.scale!=undefined?t.scale>=1?n.scale+=t.scale-1:(n.scale-=t.scale,n.scale=n.scale<1?1:n.scale):t.delta!=undefined&&(n.scale=t.delta==0?1:n.scale+t.delta),isNaN(n.scale)&&(n.scale=1),u=(n.width-n.offsetX)*n.scale,u<n.width||n.scale<=1?(n.currentOffsetX=n.offsetX,n.currentOffsetY=n.offsetY,n.currentWidth=n.width,n.currentHeight=n.height,n.canvasHeightUIAdjusted=n.height-n.offsetY-n.titleSpace,n.columnWidth=n.origColumnWidth,n.scale=1,$(".pv-bucketview-overlay div").fadeIn("slow"),n.dontZoom=!0,PV.zoom(0),n.recalibrateUISettings()):(f=n.height*n.scale,n.currentOffsetX=t.x-(t.x-n.currentOffsetX)/i*n.scale,n.currentOffsetY=t.y-(t.y-n.currentOffsetY)/i*n.scale,n.canvasHeightUIAdjusted=f-(n.offsetY+n.titleSpace)/i*n.scale,n.currentWidth=u,n.currentHeight=f,n.columnWidth=n.origColumnWidth*n.scale,$(".pv-bucketview-overlay div").fadeOut("slow"),n.resetUISettings()),n.setTilePositions(n.rowscols,n.currentOffsetX,n.currentOffsetY,!0,!0),n.scale==1&&i!=1){for(r=0;r<n.tiles.length;r++)n.tiles[r].Selected(!1),n.tiles[r].selectedLoc=0;n.selected=null;$.publish("/PivotViewer/Views/Item/Selected",[{item:n.selected}])}}});$.subscribe("/PivotViewer/Views/Canvas/Drag",function(t){if(n.isActive){var i=t.x,r=t.y,u=!1,f=!1;(n.currentOffsetX+=i,n.currentOffsetY+=r,i>0&&n.currentOffsetX>n.offsetX&&(n.currentOffsetX-=i,u=!0),r>0&&n.currentOffsetY+n.canvasHeightUIAdjusted>n.currentHeight+n.offsetY&&(n.currentOffsetY-=r,f=!0),n.currentOffsetX<n.offsetX&&n.currentWidth==n.width&&(n.currentOffsetX-=i,u=!0),i<0&&n.currentOffsetX<-1*(n.currentWidth-n.width)&&(n.currentOffsetX-=i,u=!0),n.currentOffsetY<n.offsetY&&n.currentHeight==n.height&&(n.currentOffsetY-=r,f=!0),r<0&&n.currentOffsetY-n.offsetY<-1*(n.currentHeight-n.height)&&(n.currentOffsetY-=r,f=!0),u&&f)||(u?n.offsetTiles(0,r):f?n.offsetTiles(i,0):n.offsetTiles(i,r))}})},getBucket:function(n){return Math.floor((n-this.offsetX)/this.columnWidth)},recalibrateUISettings:function(){this.rowscols=this.getTileDimensions(this.columnWidth-2,this.canvasHeightUIAdjusted-this.offsetY,this.maxRatio,this.bigCount,this.rowscols)},resetUISettings:function(){this.rowscols=this.calculateDimensions(this.columnWidth-2,this.canvasHeightUIAdjusted-this.offsetY,this.maxRatio,this.bigCount)},setup:function(n,t,i,r,u){this.width=n;this.height=t;this.offsetX=i;this.offsetY=r;this.maxRatio=u;this.currentWidth=this.width;this.currentHeight=this.height;this.currentOffsetX=this.offsetX;this.currentOffsetY=this.offsetY;this.rowscols=null;this.bigCount=0},filter:function(n,t,i){this.sortFacet=i;this.tiles=n;this.filterList=t;this.buckets=this.bucketize(t,this.sortFacet);this.filtered=!1},activate:function(){var n=this;Modernizr.canvas&&(this._super(),this.filtered&&this.filter(this.filterEvt.tiles,this.filterEvt.filterList,this.filterEvt.sort),this.buckets&&this.createUI())},createUI:function(){var u,f,i,e,t,o,s,n;for(this.columnWidth=this.origColumnWidth=(this.width-this.offsetX)/this.buckets.length,this.canvasHeightUIAdjusted=this.height-this.offsetY-this.titleSpace,u=[],this.bigCount=0,t=0;t<this.buckets.length;t++){var r=this.buckets[t],h=t%2==0?"bucketview-bucket-dark":"bucketview-bucket-light",c=r.startRange==r.endRange||r.startLabel==r.endLabel?r.startLabel:r.startLabel+"<br>to<br>"+r.endLabel;u[t]="<div class='pv-bucketview-overlay-bucket "+h+"' id='pv-bucketview-overlay-bucket-"+t+"' style='width: "+(Math.floor(this.columnWidth)-4)+"px; height:"+(this.height-2)+"px; left:"+(t*this.columnWidth-2)+"px;'>";u[t]+="<div class='pv-bucketview-overlay-buckettitle' style='top: "+(this.canvasHeightUIAdjusted+4)+"px;'><div class='pv-bucket-countbox'>"+this.buckets[t].tiles.length+"<br>"+Math.round(this.buckets[t].tiles.length/this.filterList.length*100)+"%<\/div>"+c+"<\/div><\/div>";this.bigCount<r.tiles.length&&(this.bigCount=r.tiles.length)}for(f=$(".pv-bucketview-overlay"),f.css("left",this.offsetX+"px"),$(".pv-bucketview-overlay div").fadeOut("slow",function(){$(this).remove()}),f.append(u.join("")),$(".pv-bucketview-overlay div").fadeIn("slow"),t=0;t<this.tiles.length;t++)(i=this.tiles[t],i._locations[0].startx=i._locations[0].x,i._locations[0].starty=i._locations[0].y,i.startwidth=i.width,i.startheight=i.height,i.filtered&&(Settings.showMissing||!i.missing))||(i.start=PivotViewer.Utils.now(),i.end=i.start+1e3,e=Math.atan2(i._locations[0].y-this.currentHeight/2,i._locations[0].x-this.currentWidth/2),i._locations[0].destinationx=this.currentWidth*Math.cos(e)+this.currentWidth/2,i._locations[0].destinationy=this.currentHeight*Math.sin(e)+this.currentHeight/2);for(this.maxRatio=TileController._imageController.getRatio(this.tiles[0].item.img),t=0;t<this.filterList.length;t++)o=TileController._imageController.getRatio(this.filterList[t].item.img),o<this.maxRatio&&(this.maxRatio=o);s=this.filterList.length==this.tiles.length?0:500;n=this;setTimeout(function(){var r=$(".pv-toolbarpanel-zoomslider").slider("option","value"),i,t;for(r>0&&(n.selected=selectedTile=null,n.currentOffsetX=n.offsetX,n.currentOffsetY=n.offsetY,n.resetUISettings(),PV.zoom(0)),n.resetUISettings(),i=TileController._imageController,t=0;t<n.tiles.length;t++)n.tiles[t].origwidth=n.rowscols.TileHeight/i.getRatio(n.tiles[t].item.img),n.tiles[t].origheight=n.rowscols.TileHeight,n.tiles[t].destinationwidth=1,n.tiles[t].destinationheight=1;n.setTilePositions(n.rowscols,n.offsetX,n.offsetY,!1,!1)},s)},deactivate:function(){this._super();$(".pv-bucketview-overlay div").fadeOut()},getUI:function(){return Modernizr.canvas?"<div class='pv-bucketview-overlay'><\/div>":this._super()},getButtonImage:function(){return"images/bucketview.png"},getButtonImageSelected:function(){return"images/bucketviewSelected.png"},getViewName:function(){return"Bucket View"},setTilePositions:function(n,t,i,r,u){var a=u&&this.rowscols?this.rowscols.Columns:n.Columns,v,y,e,o,h,f;for(u||(this.rowscols=n),v=[],y=[],e=0;e<this.tiles.length;e++)this.tiles[e].firstFilterItemDone=!1,this.tiles[e]._locations=[this.tiles[e]._locations[0]];for(o=0;o<this.buckets.length;o++){var l=this.buckets[o],s=0,c=0;for(h=0;h<l.tiles.length;h++)f=l.tiles[h],f.firstFilterItemDone?(tileLocation=new PivotViewer.Views.TileLocation,tileLocation.startx=f._locations[0].startx,tileLocation.starty=f._locations[0].starty,tileLocation.x=f._locations[0].x,tileLocation.y=f._locations[0].y,tileLocation.destinationx=o*this.columnWidth+s*n.TileMaxWidth+t,tileLocation.destinationy=this.canvasHeightUIAdjusted-n.TileHeight-c*n.TileHeight+i,f._locations.push(tileLocation)):(r&&(f._locations[0].startx=f._locations[0].x,f._locations[0].starty=f._locations[0].y,f.startwidth=f.width,f.startheight=f.height),f.destinationwidth=n.TileMaxWidth,f.destinationheight=n.TileHeight,f._locations[0].destinationx=o*this.columnWidth+s*n.TileMaxWidth+t,f._locations[0].destinationy=this.canvasHeightUIAdjusted-n.TileHeight-c*n.TileHeight+i,f.start=PivotViewer.Utils.now(),f.end=f.start+1e3,f.firstFilterItemDone=!0),s==a-1?(s=0,c++):s++}},bucketize:function(n,t){var d=PivotCollection.getCategoryByName(t),s,h,r,p,f,w,rt,a,ut,i,g,b,k,tt,o,u,c,y,it,l,v,e;if(n[0].item.getFacetByName(t)==undefined)return e=new PivotViewer.Models.Bucket("(no info)","(no info)"),e.addTile(n[0]),e;for(s=n[0].item.getFacetByName(t).values[0].value,i=n.length-1;i>0;i--)if(n[i].item.getFacetByName(t)!=undefined)break;if(h=n[i].item.getFacetByName(t).values[0].value,d.type==PivotViewer.Models.FacetType.DateTime)return s=new Date(s),h=new Date(h),PivotViewer.Utils.getBuckets(n,t,PivotViewer.Utils.getTimeValueFunction(s,h),PivotViewer.Utils.getTimeLabelFunction(s,h));if(d.type==PivotViewer.Models.FacetType.Number){for(r=[],r.ids=[],p=h-s,p==0?f=1:(f=Math.pow(10,Math.ceil(Math.log(p)/Math.log(10))-1),d.integer&&f<=1?f=1:p<=f*5&&(f/=2)),w=Math.floor(s/f)*f,rt=Math.floor((h-w)/f)+1,i=0;i<rt;i++)a=i*f+w,ut=a+f,r[i]=new PivotViewer.Models.Bucket(a,a,a.toString(),ut.toString());for(i=0;i<n.length;i++){if(g=n[i].item,b=g.getFacetByName(t),b==undefined)break;for(k=0;k<b.values.length;k++){var nt=b.values[k].value,v=Math.floor((nt-w)/f),e=r[v];e.addTile(n[i]);r.ids[g.id]=v;e.endRange<nt&&(e.endRange=nt)}}for(tt=0,u=0;u<r.length;u++)r[u].tiles.length==0&&tt++;if(tt>=Math.floor(r.length/2)){for(o=[],o.ids=[],u=0;u<r.length>>1;u++){c=r[2*u];y=r[2*u+1];o.push(c);Array.prototype.push.apply(c.tiles,y.tiles);for(l in c.ids)o.ids[l]=u;for(l in y.ids)c.ids[l]=!0,o.ids[l]=u;c.endRange=y.endRange;c.endLabel=y.endLabel}if(it=2*u,it<r.length){e=r[it];o.push(e);for(l in e.ids)o.ids[l]=u}r=o}if(i!=n.length&&Settings.showMissing)for(r.push(new PivotViewer.Models.Bucket("(no info)","(no info)")),v=r.length-1,e=r[v];i<n.length;i++)e.addTile(n[i]),r.ids[n[i].item.id]=v;return r}return PivotViewer.Utils.getBuckets(n,t)},centerOnTile:function(n){var a=n.item,r=n._locations[n.selectedLoc],u=this.rowscols.TileMaxWidth,t=this.rowscols.PaddingX,i=this.buckets.ids[n.item.id],f=this.rowscols.Columns,h=Math.round((r.x-this.currentOffsetX-i*(f*u+t))/u),c=i*f+h,l=Math.round((this.canvasHeightUIAdjusted-(r.y-this.currentOffsetY))/n.height)-1,e=n.context.canvas.height,o=n.context.canvas.width-($(".pv-filterpanel").width()+$(".pv-infopanel").width()),s;s=n.height/e>n.height/TileController._imageController.getRatio(n.item.img)/o?n.origheight/e:n.origwidth/o;this.selected==null&&PV.zoom(Math.round(.75/s*2));t=this.rowscols.PaddingX*i;this.currentOffsetX=this.width/2-this.rowscols.TileMaxWidth*c-this.rowscols.TileMaxWidth/2-t;this.currentOffsetY=this.height/2-this.canvasHeightUIAdjusted+this.rowscols.TileHeight/2+l*this.rowscols.TileHeight;this.setTilePositions(this.rowscols,this.currentOffsetX,this.currentOffsetY,!0,!0)},handleSelection:function(n,t,i,r){var f=!1,e=!1,u;n!=null&&(n.Selected(!0),n.selectedLoc=r,f=!0);this.selected!=null&&n==null&&(e=!0);n!=null&&this.selected!=n?(this.centerOnTile(n),$(".pv-bucketview-overlay div").fadeOut("slow")):this.selected!=null&&(this.selected=n=null,PV.zoom(0),$(".pv-bucketview-overlay div").fadeIn("slow"));$.publish("/PivotViewer/Views/Item/Selected",[{item:n}]);f||e||(u=this.buckets[this.getBucket(t)],$.publish("/PivotViewer/Views/Item/Filtered",[{Facet:this.sortFacet,Item:u.startRange,MaxRange:u.endRange,Values:u.values,ClearFacetFilters:!0}]))}});
