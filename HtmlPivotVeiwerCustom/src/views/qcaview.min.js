PivotViewer.Utils.loadScript("src/views/crosstabview.min.js");PivotViewer.Utils.loadScript("src/views/iv.min.js");PivotViewer.Views.QcaView=PivotViewer.Views.CrosstabView.subClass({init:function(){this._super();this.singleEq=!1;var n=this;$.subscribe("/PivotViewer/Views/IVFiltered",function(){n.filter();n.activate()})},bucketize:function(n,t,i){var s=IV.getIV(),ft,e,r,et,c,d,tt,it,st,w,g,rt,ut,l,f,o,u,i,nt,h,a;if(s==null)return null;for(ft=PivotCollection.getCategoryByName(t),e=[],e.ids=[],e[0]=new PivotViewer.Models.Bucket("","True Positive"),e[1]=new PivotViewer.Models.Bucket("","False Positive"),this.singleEq&&(e[2]=new PivotViewer.Models.Bucket("","True Negative"),e[3]=new PivotViewer.Models.Bucket("","False Negative")),r=0;r<e.length;r++)e[r].colCount=0,e[r].subBuckets=[],e[r].subBuckets.ids=[];if(this.singleEq&&i){for(r=0;r<e.length;r++)e[r].subBuckets[0]=new PivotViewer.Models.Bucket(i.startRange,i.startLabel);for(i.tiles=[],i.ids=[],r=0;r<this.filterList.length;r++)f=this.filterList[r],i.addTile(f),u=i==this.buckets2[this.buckets2.ids[f.item.id]]?i.oldBkt.ids[f.item.id]?0:1:i.oldBkt.ids[f.item.id]?3:2,o=e[u],o.addTile(f),o.colCount++,e.ids[f.item.id]=u,o.subBuckets[0].addTile(f),o.subBuckets.ids[f.item.id]=0,this.buckets2.ids[f.item.id]=0;et=this.buckets2.ids;this.buckets2=[i];this.buckets2.ids=et}else{var v=this.__proto__.__proto__.__proto__.bucketize(n,t),b=[],y=[],p=[];for(r=0;r<v.length;r++)for(v[r].order=r,p[r]=[],y[r]=[],u=0;u<1<<s.categories.length;u++)p[r][u]=0;for(c=[],r=0;r<n.length;r++){var f=n[r],k=0,ot=f.item.getFacetByName(ft.name);if(ot!=undefined){for(u=0;u<s.categories.length;u++){if(d=s.categories[u],tt=f.item.getFacetByName(d.name),tt==undefined)break;ivalue=tt.values[0].value;d.type==PivotViewer.Models.FacetType.String?s.values[u][ivalue]&&(k|=1<<u):d.type==PivotViewer.Models.FacetType.DateTime||(it=s.values[u],it.slider("values",0)<=ivalue&&it.slider("values",1)>=ivalue&&(k|=1<<u))}if(!(u<s.categories.length)){for(f.bits=k,o=v.ids[f.item.id],st=ot.values[0].value,p[o][k]++,u=0;u<s.categories.length;u++)h="",u<s.categories.length-1&&(h+=f.bits>>u+1),h+="a",u>0&&(h+=f.bits%(1<<u)),y[o][h]==undefined&&(y[o][h]=0,b[h]==undefined&&(b[h]=0)),y[o][h]++,b[h]++;c.push(f)}}}for(this.filterList2=this.filterList=c,this.buckets2=[],this.buckets2.ids=[],w=[],g=[],r=0;r<1<<s.categories.length;r++)g[r]=0;for(r=0;r<v.length;r++)if(p[r]!=undefined)for(o=v[r],u=0;u<1<<s.categories.length;u++)rt=p[r][u],rt>g[u]&&(g[u]=rt,w[u]=o);for(ut=[],r=0,order=0;r<w.length;r++)w[r]!=undefined&&(l=new PivotViewer.Models.Bucket(null,null),l.oldBkt=w[r],l.order=order++,l.eq=r,this.buckets2.push(l),ut[r]=l);for(r=0;r<e.length;r++)for(o=e[r],u=0;u<this.buckets2.length;u++)i=this.buckets2[u],o.subBuckets[u]=new PivotViewer.Models.Bucket(i.startRange,i.startLabel);for(r=0;r<c.length;r++)f=c[r],i=ut[f.bits],i.addTile(f),this.buckets2.ids[f.item.id]=i.order,u=i.oldBkt.ids[f.item.id]?0:1,o=e[u],e.ids[f.item.id]=u,o.addTile(f),o.colCount++,o.subBuckets[i.order].addTile(f),o.subBuckets.ids[f.item.id]=i.order;for(r=0;r<this.buckets2.length;r++){for(i=this.buckets2[r],nt="",u=0;u<s.categories.length;u++)h="",u<s.categories.length-1&&(h+=f.bits>>u+1),h+="a",u>0&&(h+=f.bits%(1<<u)),a=e[0].subBuckets[r].tiles.length/i.tiles.length,a-=s.categories.length>1?y[i.oldBkt.order][h]/b[h]:i.oldBkt.tiles.length/c.length,a=Math.floor(a*100),nt+=(i.eq>>u&1?"(":"~(")+s.categories[u].name+") ["+(a>0?"+":"")+a+"%]"+(u<s.categories.length-1?" ^ ":"");nt+="<br>&#8594; "+this.sortFacet+": ("+i.oldBkt.getLabel()+")";i.startLabel=i.endLabel=nt}}return e},activate:function(){IV.on();this._super();$("#pv-altsortcontrols").hide()},deactivate:function(){IV.off();this.singleEq=!1;this._super();this.filtered=!0},filter:function(n,t,i,r){i&&(this.sortFacet=i);n&&(this.tiles=n);t&&(this.filterList2=this.filterList=t);r||(this.singleEq=!1);this.buckets=this.bucketize(this.filterList,this.sortFacet,r);this.filtered=!1},getViewName:function(){return"QCA View"},getStatsBox:function(){return"<div style='position:absolute; width: "+(this.columnWidth-4)+"px; height: 50px; top: "+i*this.rowHeight+"px;'><div style='text-align:center'>Equations<\/div><div style='position:absolute; right:2px;'>Result<\/div><\/div><\/div>"},handleSelection:function(n,t,i,r){var f=!1,e=!1,u;n!=null&&(n.Selected(!0),n.selectedLoc=r,f=!0);this.selected!=null&&n==null&&(e=!0);n!=null&&this.selected!=n?(this.centerOnTile(n),$(".pv-bucketview-overlay div").fadeOut("slow")):this.selected!=null&&(this.selected=n=null,PV.zoom(0),$(".pv-bucketview-overlay div").fadeIn("slow"));$.publish("/PivotViewer/Views/Item/Selected",[{item:n}]);f||e||(this.singleEq?(this.singleEq=!1,this.filter()):(u=this.getBucket2(i),u>=0&&(this.singleEq=!0,this.filter(this.tiles,this.filterList,this.sortFacet,this.buckets2[u]))),this.activate())}});
